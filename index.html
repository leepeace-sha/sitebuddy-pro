<index.html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#b00020"/>
  <link rel="manifest" href="manifest.webmanifest">
  <title>Site Buddy</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#b00020;
      --borderSoft:#f2b7bd;
      --shadow: 0 10px 30px rgba(17,24,39,.10);
      --radius: 16px;
      --focus: rgba(176,0,32,.22);
      --btn:#b00020;
      --btnText:#fff;
      --btn2:#111827;
      --btn2Text:#fff;
      --danger:#b00020;
      --ok:#0f766e;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header{
      position: sticky; top:0; z-index:10;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
      border-bottom: 3px solid var(--border);
    }

    .wrap{max-width: 1180px; margin: 0 auto; padding: 14px 16px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}

    .brand{display:flex; align-items:center; gap:12px;}
    .mark{
      width:42px; height:42px; border-radius:14px;
      border:2px solid var(--border);
      display:grid; place-items:center;
      font-weight: 900;
      color: var(--border);
      background: #fff;
    }
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end}

    button{
      border:1px solid rgba(17,24,39,.12);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
    }
    button.primary{background: var(--btn); color: var(--btnText); border-color: rgba(176,0,32,.55);}
    button.secondary{background: var(--btn2); color: var(--btn2Text); border-color: rgba(17,24,39,.22);}
    button.ghost{background:#fff; border-color: rgba(176,0,32,.35); color: var(--border);}
    button.danger{background:#fff; border-color: rgba(176,0,32,.45); color: var(--danger);}
    button:disabled{opacity:.45; cursor:not-allowed}

    main .grid{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
      padding: 16px 0 28px;
    }
    @media (max-width: 980px){ main .grid{grid-template-columns: 1fr} }

    .card{
      background: var(--card);
      border: 2px solid var(--borderSoft);
      border-left: 6px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .card h2{
      margin:0 0 10px;
      font-size: 14px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      letter-spacing:.2px;
    }

    .sub{margin:6px 0 0; font-size:12px; color:var(--muted)}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}

    input, textarea, select{
      width:100%;
      border: 1px solid rgba(17,24,39,.14);
      border-radius: 12px;
      padding: 10px 10px;
      background:#fff;
      color: var(--text);
      outline:none;
    }
    input:focus, textarea:focus, select:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(176,0,32,.45);
    }
    textarea{min-height: 90px; resize: vertical}

    .row{display:flex; gap:10px}
    .row>*{flex:1}

    .list{
      display:flex; flex-direction:column; gap:8px;
      max-height: 540px; overflow:auto; padding-right: 4px;
    }
    .item{
      border:1px solid rgba(17,24,39,.12);
      border-left: 5px solid transparent;
      border-radius: 14px;
      padding: 10px;
      cursor:pointer;
      background:#fff;
      transition: transform .05s ease, border-color .12s ease;
    }
    .item:hover{transform: translateY(-1px)}
    .item.active{
      border-color: rgba(176,0,32,.35);
      border-left-color: var(--border);
      background: rgba(176,0,32,.03);
    }
    .item .title{font-weight:900; font-size:13px}
    .meta{margin-top:4px; display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:var(--muted)}
    .pill{
      border:1px solid rgba(17,24,39,.12);
      padding: 4px 8px;
      border-radius: 999px;
      background:#fff;
      white-space:nowrap;
    }
    .pill.open{border-color: rgba(176,0,32,.35); color: var(--border)}
    .pill.closed{border-color: rgba(15,118,110,.28); color: var(--ok)}
    .pill.high{border-color: rgba(176,0,32,.45); color: var(--border)}
    .pill.medium{border-color: rgba(17,24,39,.20)}
    .pill.low{border-color: rgba(17,24,39,.12)}

    .split{
      display:grid;
      grid-template-columns: 1fr 420px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .split{grid-template-columns:1fr} }

    .hr{height:1px; background: rgba(17,24,39,.10); margin:12px 0;}
    .tiny{font-size:11px; color:var(--muted)}

    .photoGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .photoGrid{grid-template-columns:1fr} }

    .photoCard{
      border:1px solid rgba(17,24,39,.12);
      border-radius: 14px;
      overflow:hidden;
      background:#fff;
    }
    .photoCard img{width:100%; height:170px; object-fit:cover; display:block;}
    .photoCap{padding: 8px 10px; display:flex; justify-content:space-between; align-items:center; gap:8px; color:var(--muted); font-size:12px;}

    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(17,24,39,.45);
      display:none;
      align-items:center; justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(980px, 100%);
      background:#fff;
      border-radius: 18px;
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
      overflow:hidden;
      border: 2px solid rgba(176,0,32,.25);
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px 14px;
      border-bottom: 2px solid rgba(17,24,39,.08);
    }
    .modalHead h3{margin:0; font-size:14px; letter-spacing:.2px}
    .modalBody{padding: 12px 14px;}
    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      border:1px solid rgba(17,24,39,.10);
      border-radius: 14px;
      padding: 8px;
      background: rgba(176,0,32,.02);
    }
    .toolBtn{padding:8px 10px; border-radius: 12px; font-weight:900}
    .toolBtn.active{box-shadow: 0 0 0 4px var(--focus); border-color: rgba(176,0,32,.45)}
    canvas{max-width:100%; background:#fff; border-radius: 14px; border:1px solid rgba(17,24,39,.12)}
    video{max-width:100%; border-radius: 14px; border:1px solid rgba(17,24,39,.12); background:#000}

    .toast{
      position: fixed; left:50%; bottom:16px;
      transform: translateX(-50%);
      background: #111827;
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: 0 14px 45px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease;
      z-index: 100;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="mark">SB</div>
      <div>
        <h1>Site Buddy</h1>
        <p>Offline audits • Photos • Annotations • Reports • PWA</p>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="btnNewProject">+ New Project</button>
      <button class="secondary" id="btnNewIssue" disabled>+ New Issue</button>
      <button class="primary" id="btnExport" disabled>Export PDF</button>
      <button class="secondary" id="btnShare" disabled>Share PDF</button>
      <button class="ghost" id="btnInstall" style="display:none;">Install</button>
      <button class="danger" id="btnReset">Reset</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Projects <span class="tiny">Select a project to work</span></h2>
      <div id="projectList" class="list"></div>
      <div class="hr"></div>

      <h2>Project Details</h2>
      <label>Title</label>
      <input id="pTitle" placeholder="e.g., Riverside Apartments – Block B"/>

      <div class="row">
        <div>
          <label>Reference</label>
          <input id="pRef" placeholder="e.g., RB-2026-014"/>
        </div>
        <div>
          <label>Client</label>
          <input id="pClient" placeholder="e.g., Acme Property"/>
        </div>
      </div>

      <label>Notes</label>
      <textarea id="pNotes" placeholder="Optional site notes…"></textarea>

      <div class="row">
        <button class="primary" id="btnSaveProject" disabled>Save</button>
        <button class="danger" id="btnDeleteProject" disabled>Delete</button>
      </div>

      <p class="sub">Stored offline on this device (IndexedDB). No internet needed.</p>
    </section>

    <section class="card">
      <h2>Issues <span class="tiny">Per selected project</span></h2>

      <div class="split">
        <div>
          <div class="row">
            <div>
              <label>Filter</label>
              <select id="issueFilter">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div>
              <label>Search</label>
              <input id="issueSearch" placeholder="Title / location / notes / assignee…"/>
            </div>
          </div>

          <div style="height:10px"></div>
          <div id="issueList" class="list" style="max-height: 380px;"></div>
        </div>

        <div>
          <h2 style="margin-bottom:6px;">Issue Details</h2>
          <p class="sub" id="issueHint">Select a project, then create an issue.</p>

          <div id="issueForm" style="display:none;">
            <label>Title</label>
            <input id="iTitle" placeholder="e.g., Missing handrail at stairwell"/>

            <div class="row">
              <div>
                <label>Status</label>
                <select id="iStatus">
                  <option value="open">Open</option>
                  <option value="closed">Closed</option>
                </select>
              </div>
              <div>
                <label>Severity</label>
                <select id="iSeverity">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Assignee</label>
                <input id="iAssignee" placeholder="e.g., John / Subcontractor / Team"/>
              </div>
              <div>
                <label>Due date</label>
                <input id="iDueDate" type="date"/>
              </div>
            </div>

            <label>Location / Area</label>
            <input id="iLocation" placeholder="e.g., Level 2 – Corridor C"/>

            <label>Notes</label>
            <textarea id="iNotes" placeholder="Describe the issue, action required, etc."></textarea>

            <div class="row">
              <button class="secondary" id="btnCamera" type="button">Open Camera</button>
              <button class="ghost" id="btnQuickCapture" type="button">Quick Capture</button>
              <label style="margin:0; flex:1;">
                <span class="tiny">Or upload:</span>
                <input id="iPhotoInput" type="file" accept="image/*" multiple capture="environment" style="margin-top:6px;"/>
              </label>
            </div>

            <div style="height:10px"></div>
            <div id="photoGrid" class="photoGrid"></div>

            <div class="row" style="margin-top:10px;">
              <button class="primary" id="btnSaveIssue" type="button">Save Issue</button>
              <button class="danger" id="btnDeleteIssue" type="button">Delete</button>
            </div>

            <div class="hr"></div>
            <h2 style="margin-bottom:6px;">Report Signature</h2>
            <p class="tiny">Draw a signature to include in the PDF report.</p>
            <canvas id="sigCanvas" width="700" height="220"></canvas>
            <div class="row" style="margin-top:8px;">
              <button class="ghost" id="btnSigClear" type="button">Clear signature</button>
              <button class="ghost" id="btnSigSave" type="button">Save signature</button>
            </div>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <p class="tiny">Android note: Live camera preview requires HTTPS. “Quick Capture” works via the system camera.</p>
    </section>
  </div>
</main>

<div class="modalBackdrop" id="annoBackdrop">
  <div class="modal">
    <div class="modalHead">
      <h3 id="annoTitle">Annotate Photo</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="ghost" id="btnAnnoUndo" type="button">Undo</button>
        <button class="ghost" id="btnAnnoClear" type="button">Clear</button>
        <button class="primary" id="btnAnnoSave" type="button">Save</button>
        <button class="danger" id="btnAnnoClose" type="button">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="toolbar" style="margin-bottom:10px;">
        <button class="toolBtn ghost active" data-tool="rect" type="button">Rectangle</button>
        <button class="toolBtn ghost" data-tool="arrow" type="button">Arrow</button>
        <button class="toolBtn ghost" data-tool="text" type="button">Text</button>
        <span class="tiny" style="margin-left:auto;">Drag to draw • click for text</span>
      </div>

      <canvas id="annoCanvas" width="1200" height="800"></canvas>
      <p class="tiny">Stored with canvas size for perfect PDF scaling.</p>
    </div>
  </div>
</div>

<div class="modalBackdrop" id="camBackdrop">
  <div class="modal">
    <div class="modalHead">
      <h3>Camera</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="primary" id="btnSnap" type="button">Snap Photo</button>
        <button class="ghost" id="btnCamSwitch" type="button">Switch camera</button>
        <button class="danger" id="btnCamClose" type="button">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <video id="camVideo" autoplay playsinline></video>
      <canvas id="camCanvas" width="1280" height="720" style="display:none;"></canvas>
      <p class="tiny">If preview won’t start: use “Quick Capture” (system camera) or run on HTTPS.</p>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* =========================
   IndexedDB Offline Storage
========================= */
const DB_NAME = "sitebuddy_db_v3";
const DB_VER  = 1;

function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains("projects")){
        db.createObjectStore("projects", { keyPath: "id" });
      }
      if(!db.objectStoreNames.contains("photos")){
        const store = db.createObjectStore("photos", { keyPath: "id" });
        store.createIndex("by_issueId", "issueId", { unique:false });
      }
      if(!db.objectStoreNames.contains("signatures")){
        db.createObjectStore("signatures", { keyPath: "projectId" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function dbPut(storeName, value){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(storeName, "readwrite");
    t.oncomplete = () => resolve(true);
    t.onerror = () => reject(t.error);
    t.objectStore(storeName).put(value);
  });
}

async function dbGet(storeName, key){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(storeName, "readonly");
    const req = t.objectStore(storeName).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

async function dbDelete(storeName, key){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(storeName, "readwrite");
    t.oncomplete = () => resolve(true);
    t.onerror = () => reject(t.error);
    t.objectStore(storeName).delete(key);
  });
}

async function dbGetAllProjects(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction("projects", "readonly");
    const req = t.objectStore("projects").getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

async function dbGetPhotosByIssueId(issueId){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction("photos", "readonly");
    const idx = t.objectStore("photos").index("by_issueId");
    const req = idx.getAll(issueId);
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

async function dbDeletePhotosByIssueId(issueId){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction("photos", "readwrite");
    const store = t.objectStore("photos");
    const idx = store.index("by_issueId");
    const req = idx.openCursor(issueId);
    req.onsuccess = (e) => {
      const cursor = e.target.result;
      if(cursor){
        store.delete(cursor.primaryKey);
        cursor.continue();
      }
    };
    t.oncomplete = () => resolve(true);
    t.onerror = () => reject(t.error);
  });
}

/* =========================
   App State
========================= */
const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);
const $ = (id) => document.getElementById(id);

const toastEl = $("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1600);
}

const state = {
  projects: [],
  selectedProjectId: null,
  selectedIssueId: null,
  photoUrlCache: new Map(),
};

function safe(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

function getProject(){ return state.projects.find(p => p.id === state.selectedProjectId) || null; }
function getIssue(){
  const p = getProject();
  if(!p) return null;
  return (p.issues||[]).find(i => i.id === state.selectedIssueId) || null;
}

async function loadAll(){
  state.projects = await dbGetAllProjects();
  if(!state.selectedProjectId && state.projects.length){
    state.selectedProjectId = state.projects[0].id;
  }
  render();
  await loadSignatureIntoCanvas();
}

/* =========================
   Rendering
========================= */
function severityPill(sev){
  const s = (sev||"medium").toLowerCase();
  return s === "high" ? "pill high" : s === "low" ? "pill low" : "pill medium";
}

function renderProjects(){
  const list = $("projectList");
  list.innerHTML = "";

  if(state.projects.length === 0){
    list.innerHTML = `<div class="tiny">No projects yet. Click “New Project”.</div>`;
  }

  for(const p of state.projects){
    const issuesCount = (p.issues||[]).length;
    const el = document.createElement("div");
    el.className = "item" + (p.id === state.selectedProjectId ? " active" : "");
    el.innerHTML = `
      <div class="title">${safe(p.title || "Untitled Project")}</div>
      <div class="meta">
        <span class="pill">${safe(p.reference || "No ref")}</span>
        <span class="pill">${safe(p.client || "No client")}</span>
        <span class="pill">${issuesCount} issue${issuesCount===1?"":"s"}</span>
      </div>
    `;
    el.onclick = async () => {
      state.selectedProjectId = p.id;
      state.selectedIssueId = null;
      render();
      await loadSignatureIntoCanvas();
    };
    list.appendChild(el);
  }

  const proj = getProject();
  $("btnNewIssue").disabled = !proj;
  $("btnExport").disabled = !proj;
  $("btnShare").disabled  = !proj;
  $("btnSaveProject").disabled = !proj;
  $("btnDeleteProject").disabled = !proj;

  $("pTitle").value = proj?.title || "";
  $("pRef").value = proj?.reference || "";
  $("pClient").value = proj?.client || "";
  $("pNotes").value = proj?.notes || "";
}

function renderIssues(){
  const proj = getProject();
  const list = $("issueList");
  list.innerHTML = "";

  if(!proj){
    list.innerHTML = `<div class="tiny">Select or create a project.</div>`;
    return;
  }

  const filter = $("issueFilter").value;
  const q = $("issueSearch").value.trim().toLowerCase();

  let issues = (proj.issues||[]).slice();
  if(filter !== "all") issues = issues.filter(i => i.status === filter);
  if(q){
    issues = issues.filter(i =>
      (i.title||"").toLowerCase().includes(q) ||
      (i.location||"").toLowerCase().includes(q) ||
      (i.notes||"").toLowerCase().includes(q) ||
      (i.assignee||"").toLowerCase().includes(q)
    );
  }

  if(issues.length === 0){
    list.innerHTML = `<div class="tiny">No issues match. Click “New Issue”.</div>`;
    return;
  }

  for(const i of issues){
    const el = document.createElement("div");
    el.className = "item" + (i.id === state.selectedIssueId ? " active" : "");
    const statusClass = i.status === "closed" ? "pill closed" : "pill open";

    const due = i.dueDate ? new Date(i.dueDate).toLocaleDateString() : "";
    const ass = (i.assignee || "").trim();

    el.innerHTML = `
      <div class="title">${safe(i.title || "Untitled Issue")}</div>
      <div class="meta">
        <span class="${statusClass}">${safe(i.status||"open")}</span>
        <span class="${severityPill(i.severity)}">${safe(i.severity||"medium")}</span>
        <span class="pill">${safe(i.location||"No location")}</span>
        ${ass ? `<span class="pill">Assignee: ${safe(ass)}</span>` : ``}
        ${due ? `<span class="pill">Due: ${safe(due)}</span>` : ``}
      </div>
    `;
    el.onclick = async () => {
      state.selectedIssueId = i.id;
      renderIssues();
      await renderIssueDetail();
    };
    list.appendChild(el);
  }
}

async function renderIssueDetail(){
  const proj = getProject();
  const issue = getIssue();

  if(!proj){
    $("issueForm").style.display = "none";
    $("issueHint").style.display = "block";
    $("issueHint").textContent = "Select a project, then create an issue.";
    return;
  }
  if(!issue){
    $("issueForm").style.display = "none";
    $("issueHint").style.display = "block";
    $("issueHint").textContent = "Create an issue, or tap one to edit.";
    return;
  }

  $("issueHint").style.display = "none";
  $("issueForm").style.display = "block";

  $("iTitle").value = issue.title || "";
  $("iStatus").value = issue.status || "open";
  $("iSeverity").value = issue.severity || "medium";
  $("iAssignee").value = issue.assignee || "";
  $("iDueDate").value = issue.dueDate || "";
  $("iLocation").value = issue.location || "";
  $("iNotes").value = issue.notes || "";

  await renderPhotos(issue.id);
}

async function renderPhotos(issueId){
  const grid = $("photoGrid");
  grid.innerHTML = "";

  const photos = await dbGetPhotosByIssueId(issueId);
  if(photos.length === 0){
    grid.innerHTML = `<div class="tiny">No photos yet. Use Camera, Quick Capture, or Upload.</div>`;
    return;
  }

  for(let idx=0; idx<photos.length; idx++){
    const ph = photos[idx];

    let url = state.photoUrlCache.get(ph.id);
    if(!url){
      url = URL.createObjectURL(ph.blob);
      state.photoUrlCache.set(ph.id, url);
    }

    const el = document.createElement("div");
    el.className = "photoCard";
    el.innerHTML = `
      <img src="${url}" alt="Issue photo"/>
      <div class="photoCap">
        <span>Photo ${idx+1}</span>
        <div style="display:flex; gap:8px;">
          <button class="ghost" data-anno="${ph.id}" type="button">Annotate</button>
          <button class="danger" data-del="${ph.id}" type="button">Remove</button>
        </div>
      </div>
    `;
    grid.appendChild(el);
  }

  grid.querySelectorAll("[data-del]").forEach(btn => {
    btn.onclick = async (e) => {
      e.stopPropagation();
      const id = btn.getAttribute("data-del");
      const ok = confirm("Remove this photo?");
      if(!ok) return;
      const url = state.photoUrlCache.get(id);
      if(url) URL.revokeObjectURL(url);
      state.photoUrlCache.delete(id);
      await dbDelete("photos", id);
      await renderPhotos(issueId);
      toast("Photo removed");
    };
  });

  grid.querySelectorAll("[data-anno]").forEach(btn => {
    btn.onclick = async (e) => {
      e.stopPropagation();
      const photoId = btn.getAttribute("data-anno");
      await openAnnotationEditor(photoId);
    };
  });
}

function render(){
  renderProjects();
  renderIssues();
  renderIssueDetail();
}

/* =========================
   CRUD: Projects & Issues
========================= */
async function saveProject(proj){
  await dbPut("projects", proj);
  state.projects = await dbGetAllProjects();
}

$("btnNewProject").onclick = async () => {
  const p = {
    id: uid(),
    title: "New Project",
    reference: "",
    client: "",
    notes: "",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    issues: []
  };
  await saveProject(p);
  state.selectedProjectId = p.id;
  state.selectedIssueId = null;
  render();
  await loadSignatureIntoCanvas();
  toast("Project created");
};

$("btnSaveProject").onclick = async () => {
  const p = getProject();
  if(!p) return;
  p.title = $("pTitle").value.trim() || "Untitled Project";
  p.reference = $("pRef").value.trim();
  p.client = $("pClient").value.trim();
  p.notes = $("pNotes").value.trim();
  p.updatedAt = new Date().toISOString();
  await saveProject(p);
  renderProjects();
  toast("Project saved");
};

$("btnDeleteProject").onclick = async () => {
  const p = getProject();
  if(!p) return;
  const ok = confirm(`Delete project "${p.title}" and all its issues/photos/signature?`);
  if(!ok) return;

  for(const issue of (p.issues||[])){
    await dbDeletePhotosByIssueId(issue.id);
  }
  await dbDelete("signatures", p.id);
  await dbDelete("projects", p.id);

  for(const [, url] of state.photoUrlCache.entries()){
    URL.revokeObjectURL(url);
  }
  state.photoUrlCache.clear();

  state.projects = await dbGetAllProjects();
  state.selectedProjectId = state.projects[0]?.id || null;
  state.selectedIssueId = null;
  render();
  await loadSignatureIntoCanvas();
  toast("Project deleted");
};

$("btnNewIssue").onclick = async () => {
  const p = getProject();
  if(!p) return;

  const issue = {
    id: uid(),
    title: "New Issue",
    status: "open",
    severity: "medium",
    assignee: "",
    dueDate: "",
    location: "",
    notes: "",
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  p.issues = [issue, ...(p.issues||[])];
  p.updatedAt = new Date().toISOString();
  await saveProject(p);

  state.selectedIssueId = issue.id;
  renderIssues();
  await renderIssueDetail();
  toast("Issue created");
};

$("btnSaveIssue").onclick = async () => {
  const p = getProject();
  const i = getIssue();
  if(!p || !i) return;

  i.title = $("iTitle").value.trim() || "Untitled Issue";
  i.status = $("iStatus").value;
  i.severity = $("iSeverity").value;
  i.assignee = $("iAssignee").value.trim();
  i.dueDate = $("iDueDate").value;
  i.location = $("iLocation").value.trim();
  i.notes = $("iNotes").value.trim();
  i.updatedAt = new Date().toISOString();

  p.updatedAt = new Date().toISOString();
  await saveProject(p);
  renderIssues();
  toast("Issue saved");
};

$("btnDeleteIssue").onclick = async () => {
  const p = getProject();
  const i = getIssue();
  if(!p || !i) return;
  const ok = confirm(`Delete issue "${i.title}" and its photos?`);
  if(!ok) return;

  await dbDeletePhotosByIssueId(i.id);
  p.issues = (p.issues||[]).filter(x => x.id !== i.id);
  p.updatedAt = new Date().toISOString();
  await saveProject(p);

  state.selectedIssueId = null;
  renderIssues();
  await renderIssueDetail();
  toast("Issue deleted");
};

/* =========================
   Photo Import (Upload)
========================= */
$("iPhotoInput").addEventListener("change", async (e) => {
  const issue = getIssue();
  if(!issue) return;

  const files = Array.from(e.target.files || []);
  if(files.length === 0) return;

  for(const file of files){
    if(!file.type.startsWith("image/")) continue;
    const blob = await normalizeImageToJpegBlob(file, 1600);
    const rec = { id: uid(), issueId: issue.id, createdAt: new Date().toISOString(), blob, annotations: [], annoW: null, annoH: null };
    await dbPut("photos", rec);
  }

  e.target.value = "";
  await renderPhotos(issue.id);
  toast(files.length === 1 ? "Photo added" : `${files.length} photos added`);
});

$("btnQuickCapture").onclick = () => $("iPhotoInput").click();

/* Normalize images for consistent PDF embedding */
async function normalizeImageToJpegBlob(fileOrBlob, maxSidePx=1600){
  const blob = fileOrBlob instanceof Blob ? fileOrBlob : new Blob([fileOrBlob]);
  const img = await blobToImage(blob);
  const { canvas, ctx, w, h } = drawImageFit(img, maxSidePx);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,w,h);
  ctx.drawImage(img, 0, 0, w, h);
  return await new Promise((resolve) => canvas.toBlob(b => resolve(b), "image/jpeg", 0.86));
}

function blobToImage(blob){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
    img.src = url;
  });
}

function drawImageFit(img, maxSide){
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const ratio = Math.min(maxSide / img.width, maxSide / img.height, 1);
  const w = Math.round(img.width * ratio);
  const h = Math.round(img.height * ratio);
  canvas.width = w; canvas.height = h;
  return { canvas, ctx, w, h };
}

/* =========================
   Camera Capture (Android hardened)
========================= */
let camStream = null;
let camFacingMode = "environment";

$("btnCamera").onclick = async () => {
  const issue = getIssue();
  if(!issue) return;
  await openCamera();
};

$("btnCamClose").onclick = async () => { await closeCamera(); };
$("btnCamSwitch").onclick = async () => {
  camFacingMode = camFacingMode === "environment" ? "user" : "environment";
  await openCamera(true);
};

async function openCamera(restart=false){
  $("camBackdrop").classList.add("show");
  const video = $("camVideo");

  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
    toast("Camera not supported. Use Quick Capture/Upload.");
    $("camBackdrop").classList.remove("show");
    return;
  }

  // Android browsers typically require secure context for getUserMedia.
  if(!window.isSecureContext){
    toast("Live camera needs HTTPS. Use Quick Capture.");
    $("camBackdrop").classList.remove("show");
    return;
  }

  if(camStream && restart){
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
  if(camStream){
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }

  const attempts = [
    { video: { facingMode: { exact: camFacingMode } }, audio: false },
    { video: { facingMode: { ideal: camFacingMode } }, audio: false },
    { video: { facingMode: { ideal: "environment" } }, audio: false },
    { video: true, audio: false }
  ];

  let lastErr = null;
  for(const constraints of attempts){
    try{
      camStream = await navigator.mediaDevices.getUserMedia(constraints);
      break;
    }catch(err){
      lastErr = err;
      camStream = null;
    }
  }

  if(!camStream){
    console.error("getUserMedia failed:", lastErr);
    toast("Camera blocked. Use Quick Capture/Upload.");
    $("camBackdrop").classList.remove("show");
    return;
  }

  try{
    video.srcObject = camStream;
    video.setAttribute("playsinline", "true");
    video.muted = true;
    await video.play();
    toast("Camera ready");
  }catch(err){
    console.error("video play failed:", err);
    toast("Preview failed. Use Quick Capture.");
    $("camBackdrop").classList.remove("show");
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
}

async function closeCamera(){
  $("camBackdrop").classList.remove("show");
  const video = $("camVideo");
  try{ video.pause(); }catch(_){}
  video.srcObject = null;
  if(camStream){
    camStream.getTracks().forEach(t => t.stop());
    camStream = null;
  }
}

$("btnSnap").onclick = async () => {
  const issue = getIssue();
  if(!issue) return;

  const video = $("camVideo");
  if(!camStream || !video.videoWidth){
    toast("Camera not ready. Use Quick Capture.");
    return;
  }

  const canvas = $("camCanvas");
  const ctx = canvas.getContext("2d");

  const vw = video.videoWidth || 1280;
  const vh = video.videoHeight || 720;
  canvas.width = vw;
  canvas.height = vh;
  ctx.drawImage(video, 0, 0, vw, vh);

  const blob = await new Promise(resolve => canvas.toBlob(b => resolve(b), "image/jpeg", 0.9));
  const norm = await normalizeImageToJpegBlob(blob, 1600);

  const rec = { id: uid(), issueId: issue.id, createdAt: new Date().toISOString(), blob: norm, annotations: [], annoW: null, annoH: null };
  await dbPut("photos", rec);
  await renderPhotos(issue.id);
  toast("Photo captured");
};

/* =========================
   Annotation Editor (stores annoW/annoH)
========================= */
const anno = {
  photoId: null,
  baseImg: null,
  tool: "rect",
  dragging: false,
  startX: 0, startY: 0,
  tempShape: null,
  shapes: [],
  history: [],
};

const annoCanvas = $("annoCanvas");
const annoCtx = annoCanvas.getContext("2d");

function setTool(tool){
  anno.tool = tool;
  document.querySelectorAll("[data-tool]").forEach(b => {
    b.classList.toggle("active", b.getAttribute("data-tool") === tool);
  });
}
document.querySelectorAll("[data-tool]").forEach(btn => btn.onclick = () => setTool(btn.getAttribute("data-tool")));

$("btnAnnoClose").onclick = () => closeAnno();
$("btnAnnoUndo").onclick = () => {
  if(anno.history.length){
    anno.shapes = anno.history.pop();
    drawAnno();
  }
};
$("btnAnnoClear").onclick = () => {
  if(!confirm("Clear all annotations?")) return;
  pushHistory();
  anno.shapes = [];
  drawAnno();
};
$("btnAnnoSave").onclick = async () => {
  if(!anno.photoId) return;
  const rec = await dbGet("photos", anno.photoId);
  if(!rec) return;

  rec.annotations = anno.shapes;
  rec.annoW = annoCanvas.width;
  rec.annoH = annoCanvas.height;
  await dbPut("photos", rec);

  toast("Annotations saved");
  closeAnno();
  const issue = getIssue();
  if(issue) await renderPhotos(issue.id);
};

function pushHistory(){
  anno.history.push(JSON.parse(JSON.stringify(anno.shapes)));
  if(anno.history.length > 30) anno.history.shift();
}

function clientToCanvas(e){
  const rect = annoCanvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * (annoCanvas.width / rect.width);
  const y = (e.clientY - rect.top) * (annoCanvas.height / rect.height);
  return { x, y };
}

annoCanvas.addEventListener("pointerdown", async (e) => {
  if(!anno.baseImg) return;
  const { x, y } = clientToCanvas(e);
  anno.dragging = true;
  anno.startX = x; anno.startY = y;
  anno.tempShape = null;

  if(anno.tool === "text"){
    const text = prompt("Text:", "Note");
    if(text && text.trim()){
      pushHistory();
      anno.shapes.push({ type:"text", x, y, text: text.trim() });
      drawAnno();
    }
    anno.dragging = false;
    return;
  }

  if(anno.tool === "rect"){
    anno.tempShape = { type:"rect", x1:x, y1:y, x2:x, y2:y };
    return;
  }

  if(anno.tool === "arrow"){
    anno.tempShape = { type:"arrow", x1:x, y1:y, x2:x, y2:y };
    return;
  }
});

annoCanvas.addEventListener("pointermove", (e) => {
  if(!anno.dragging || !anno.tempShape) return;
  const { x, y } = clientToCanvas(e);
  anno.tempShape.x2 = x;
  anno.tempShape.y2 = y;
  drawAnno();
  drawShape(anno.tempShape, true);
});

annoCanvas.addEventListener("pointerup", () => {
  if(!anno.dragging) return;
  anno.dragging = false;

  if(anno.tempShape){
    pushHistory();
    if(anno.tempShape.type === "rect"){
      const { x1,y1,x2,y2 } = anno.tempShape;
      anno.shapes.push({
        type:"rect",
        x: Math.min(x1,x2),
        y: Math.min(y1,y2),
        w: Math.abs(x2-x1),
        h: Math.abs(y2-y1),
      });
    }else{
      anno.shapes.push(anno.tempShape);
    }
    anno.tempShape = null;
    drawAnno();
  }
});

function drawAnno(){
  const ctx = annoCtx;
  ctx.clearRect(0,0,annoCanvas.width, annoCanvas.height);
  ctx.drawImage(anno.baseImg, 0, 0, annoCanvas.width, annoCanvas.height);
  for(const s of anno.shapes) drawShape(s, false);
}

function drawShape(s, isPreview){
  const ctx = annoCtx;
  ctx.save();
  ctx.lineWidth = isPreview ? 5 : 6;
  ctx.strokeStyle = "#b00020";
  ctx.fillStyle = "#b00020";
  ctx.font = "900 28px ui-sans-serif, system-ui";
  ctx.globalAlpha = isPreview ? 0.85 : 1;

  if(s.type === "rect"){
    const x = s.x ?? Math.min(s.x1, s.x2);
    const y = s.y ?? Math.min(s.y1, s.y2);
    const w = s.w ?? Math.abs(s.x2 - s.x1);
    const h = s.h ?? Math.abs(s.y2 - s.y1);
    ctx.strokeRect(x,y,w,h);
  }

  if(s.type === "arrow"){
    const x1 = s.x1, y1 = s.y1, x2 = s.x2, y2 = s.y2;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();

    const angle = Math.atan2(y2-y1, x2-x1);
    const headLen = 28;
    const a1 = angle - Math.PI/7;
    const a2 = angle + Math.PI/7;
    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(x2 - headLen*Math.cos(a1), y2 - headLen*Math.sin(a1));
    ctx.lineTo(x2 - headLen*Math.cos(a2), y2 - headLen*Math.sin(a2));
    ctx.closePath();
    ctx.fill();
  }

  if(s.type === "text"){
    ctx.fillText(s.text || "", s.x, s.y);
  }

  ctx.restore();
}

async function openAnnotationEditor(photoId){
  const rec = await dbGet("photos", photoId);
  if(!rec) return;

  const img = await blobToImage(rec.blob);

  const maxW = 1200;
  const ratio = Math.min(maxW / img.width, 1);
  const w = Math.round(img.width * ratio);
  const h = Math.round(img.height * ratio);
  annoCanvas.width = w;
  annoCanvas.height = h;

  anno.photoId = photoId;
  anno.baseImg = img;
  anno.shapes = rec.annotations || [];
  anno.history = [];
  setTool("rect");

  $("annoBackdrop").classList.add("show");
  drawAnno();
}

function closeAnno(){
  $("annoBackdrop").classList.remove("show");
  anno.photoId = null;
  anno.baseImg = null;
  anno.shapes = [];
  anno.history = [];
}

/* =========================
   Signature Capture
========================= */
const sig = { drawing:false, lastX:0,lastY:0 };
const sigCanvas = $("sigCanvas");
const sigCtx = sigCanvas.getContext("2d");

function clearSig(){
  sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
  sigCtx.strokeStyle = "rgba(17,24,39,.18)";
  sigCtx.lineWidth = 2;
  sigCtx.beginPath();
  sigCtx.moveTo(40, sigCanvas.height-60);
  sigCtx.lineTo(sigCanvas.width-40, sigCanvas.height-60);
  sigCtx.stroke();
}

function sigPos(e){
  const r = sigCanvas.getBoundingClientRect();
  const x = (e.clientX - r.left) * (sigCanvas.width / r.width);
  const y = (e.clientY - r.top) * (sigCanvas.height / r.height);
  return {x,y};
}

sigCanvas.addEventListener("pointerdown", (e) => {
  sig.drawing = true;
  const {x,y} = sigPos(e);
  sig.lastX = x; sig.lastY = y;
});
sigCanvas.addEventListener("pointermove", (e) => {
  if(!sig.drawing) return;
  const {x,y} = sigPos(e);
  sigCtx.strokeStyle = "#111827";
  sigCtx.lineWidth = 3.5;
  sigCtx.lineCap = "round";
  sigCtx.beginPath();
  sigCtx.moveTo(sig.lastX, sig.lastY);
  sigCtx.lineTo(x,y);
  sigCtx.stroke();
  sig.lastX = x; sig.lastY = y;
});
sigCanvas.addEventListener("pointerup", () => sig.drawing = false);
sigCanvas.addEventListener("pointerleave", () => sig.drawing = false);

$("btnSigClear").onclick = () => { clearSig(); toast("Signature cleared"); };
$("btnSigSave").onclick = async () => {
  const p = getProject();
  if(!p) return;
  const dataUrl = sigCanvas.toDataURL("image/png");
  await dbPut("signatures", { projectId: p.id, dataUrl });
  toast("Signature saved");
};

async function loadSignatureIntoCanvas(){
  clearSig();
  const p = getProject();
  if(!p) return;
  const rec = await dbGet("signatures", p.id);
  if(!rec?.dataUrl) return;

  const img = new Image();
  img.onload = () => {
    const maxW = sigCanvas.width - 80;
    const maxH = sigCanvas.height - 80;
    const r = Math.min(maxW / img.width, maxH / img.height, 1);
    const w = img.width * r, h = img.height * r;
    const x = (sigCanvas.width - w)/2;
    const y = (sigCanvas.height - h)/2;
    sigCtx.drawImage(img, x, y, w, h);
  };
  img.src = rec.dataUrl;
}

/* =========================
   Report Export + Share
========================= */
function safeFile(s){ return String(s||"Report").replace(/[^a-z0-9-_]+/gi,"_").slice(0,60); }

async function renderAnnotatedToDataUrl(photoRec){
  const img = await blobToImage(photoRec.blob);
  const { canvas, ctx, w, h } = drawImageFit(img, 1400);

  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,w,h);
  ctx.drawImage(img, 0,0,w,h);

  const shapes = photoRec.annotations || [];
  const annoW = photoRec.annoW || w;
  const annoH = photoRec.annoH || h;
  const scaleX = w / annoW;
  const scaleY = h / annoH;

  ctx.save();
  ctx.strokeStyle = "#b00020";
  ctx.fillStyle = "#b00020";
  ctx.lineWidth = 6;
  ctx.font = "900 34px ui-sans-serif, system-ui";

  for(const s of shapes){
    if(s.type === "rect"){
      ctx.strokeRect((s.x||0)*scaleX, (s.y||0)*scaleY, (s.w||0)*scaleX, (s.h||0)*scaleY);
    }
    if(s.type === "arrow"){
      const x1 = (s.x1||0)*scaleX, y1 = (s.y1||0)*scaleY, x2 = (s.x2||0)*scaleX, y2 = (s.y2||0)*scaleY;
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      const angle = Math.atan2(y2-y1, x2-x1);
      const headLen = 34;
      const a1 = angle - Math.PI/7, a2 = angle + Math.PI/7;
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2 - headLen*Math.cos(a1), y2 - headLen*Math.sin(a1));
      ctx.lineTo(x2 - headLen*Math.cos(a2), y2 - headLen*Math.sin(a2));
      ctx.closePath(); ctx.fill();
    }
    if(s.type === "text"){
      ctx.fillText(s.text||"", (s.x||0)*scaleX, (s.y||0)*scaleY);
    }
  }

  ctx.restore();
  return canvas.toDataURL("image/jpeg", 0.9);
}

async function drawReport(doc, p){
  const margin = 46;
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const contentW = pageW - margin*2;

  const title = p.title || "Site Buddy Report";
  const generated = new Date().toLocaleString();

  function redFrame(){
    doc.setDrawColor(176,0,32);
    doc.setLineWidth(3);
    doc.rect(margin, margin, contentW, pageH - margin*2);
  }

  redFrame();
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text(title, margin+16, 96, { maxWidth: contentW-32 });

  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  doc.text(`Reference: ${p.reference || "-"}`, margin+16, 130);
  doc.text(`Client: ${p.client || "-"}`, margin+16, 146);
  doc.text(`Generated: ${generated}`, margin+16, 162);

  if(p.notes){
    doc.setFont("helvetica","bold");
    doc.text("Project Notes", margin+16, 196);
    doc.setFont("helvetica","normal");
    const wrapped = doc.splitTextToSize(p.notes, contentW-32);
    doc.text(wrapped, margin+16, 214);
  }

  doc.addPage(); redFrame();
  const issues = (p.issues||[]).slice();
  const openCount = issues.filter(i=>i.status==="open").length;
  const closedCount = issues.filter(i=>i.status==="closed").length;

  doc.setFont("helvetica","bold");
  doc.setFontSize(18);
  doc.text("Summary", margin+16, 86);

  doc.setFont("helvetica","normal");
  doc.setFontSize(12);
  doc.text(`Total issues: ${issues.length}`, margin+16, 120);
  doc.text(`Open: ${openCount}`, margin+16, 140);
  doc.text(`Closed: ${closedCount}`, margin+16, 160);

  const byLoc = new Map();
  for(const i of issues){
    const loc = (i.location || "Unspecified area").trim() || "Unspecified area";
    if(!byLoc.has(loc)) byLoc.set(loc, []);
    byLoc.get(loc).push(i);
  }

  doc.setFont("helvetica","bold");
  doc.setFontSize(12);
  doc.text("Issues by area", margin+16, 200);
  doc.setFont("helvetica","normal");
  doc.setFontSize(11);

  let y = 224;
  for(const [loc, arr] of byLoc.entries()){
    const line = `• ${loc} — ${arr.length} issue${arr.length===1?"":"s"} (Open: ${arr.filter(i=>i.status==="open").length}, Closed: ${arr.filter(i=>i.status==="closed").length})`;
    const wrapped = doc.splitTextToSize(line, contentW-32);
    if(y + wrapped.length*14 > pageH - margin - 140){
      doc.addPage(); redFrame(); y = 86;
    }
    doc.text(wrapped, margin+16, y);
    y += wrapped.length*14 + 6;
  }

  const sigRec = await dbGet("signatures", p.id);
  if(sigRec?.dataUrl){
    if(y > pageH - margin - 140){
      doc.addPage(); redFrame(); y = 86;
    }
    doc.setFont("helvetica","bold");
    doc.text("Signature", margin+16, y+18);
    try{
      doc.addImage(sigRec.dataUrl, "PNG", margin+16, y+30, 220, 80);
      doc.setFont("helvetica","normal");
      doc.setFontSize(10);
      doc.text("Signed on-site", margin+246, y+78);
    }catch(_){}
  }

  const locs = Array.from(byLoc.keys()).sort((a,b)=>a.localeCompare(b));
  for(const loc of locs){
    const locIssues = byLoc.get(loc);
    const open = locIssues.filter(i=>i.status==="open");
    const closed = locIssues.filter(i=>i.status==="closed");

    for(const block of [
      { name: "Open issues", items: open },
      { name: "Closed issues", items: closed },
    ]){
      if(block.items.length === 0) continue;

      doc.addPage(); redFrame();
      doc.setFont("helvetica","bold");
      doc.setFontSize(16);
      doc.text(loc, margin+16, 86);
      doc.setFontSize(12);
      doc.text(block.name, margin+16, 110);

      let yy = 140;
      doc.setFont("helvetica","normal");
      doc.setFontSize(11);

      for(const issue of block.items){
        const assignee = (issue.assignee || "-").trim() || "-";
        const dueDate = issue.dueDate ? new Date(issue.dueDate).toLocaleDateString() : "-";

        const line1 = `${issue.title || "Untitled"}  •  Severity: ${issue.severity || "medium"}`;
        const lineMeta = `Assignee: ${assignee}  •  Due: ${dueDate}`;
        const notes = issue.notes || "-";

        const lines1 = doc.splitTextToSize(line1, contentW-32);
        const linesMeta = doc.splitTextToSize(lineMeta, contentW-32);
        const lines2 = doc.splitTextToSize(notes, contentW-32);

        const needed = (lines1.length + linesMeta.length + lines2.length)*14 + 26;
        if(yy + needed > pageH - margin - 20){
          doc.addPage(); redFrame(); yy = 86;
        }

        doc.setFont("helvetica","bold");
        doc.text(lines1, margin+16, yy);
        yy += lines1.length*14 + 4;

        doc.setFont("helvetica","normal");
        doc.text(linesMeta, margin+16, yy);
        yy += linesMeta.length*14 + 6;

        doc.text(lines2, margin+16, yy);
        yy += lines2.length*14 + 10;

        const photos = await dbGetPhotosByIssueId(issue.id);
        if(photos.length){
          doc.addPage(); redFrame();
          doc.setFont("helvetica","bold");
          doc.setFontSize(14);
          doc.text(`Photos: ${issue.title || "Issue"}`, margin+16, 86);
          doc.setFont("helvetica","normal");
          doc.setFontSize(10);

          let py = 110;
          for(let k=0; k<photos.length; k++){
            const ph = photos[k];
            if(py + 310 > pageH - margin){
              doc.addPage(); redFrame(); py = 86;
            }
            const dataUrl = await renderAnnotatedToDataUrl(ph);
            const imgW = contentW - 32;
            const imgH = 250;
            doc.addImage(dataUrl, "JPEG", margin+16, py, imgW, imgH, undefined, "FAST");
            py += imgH + 14;

            doc.setTextColor(176,0,32);
            doc.text(`Photo ${k+1} (annotated)`, margin+16, py);
            doc.setTextColor(0,0,0);
            py += 18;
          }
        }
      }
    }
  }
}

async function exportPdf(){
  const p = getProject();
  if(!p){ toast("Select a project first"); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  await drawReport(doc, p);
  doc.save(`SiteBuddy_${safeFile(p.title || "Report")}.pdf`);
  toast("PDF exported");
}

$("btnExport").onclick = async () => exportPdf();

async function buildPdfBlobForProject(project){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  await drawReport(doc, project);
  return doc.output("blob");
}

$("btnShare").onclick = async () => {
  const p = getProject();
  if(!p){ toast("Select a project first"); return; }

  try{
    const blob = await buildPdfBlobForProject(p);
    const fileName = `SiteBuddy_${safeFile(p.title || "Report")}.pdf`;
    const file = new File([blob], fileName, { type: "application/pdf" });

    if(navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ title: p.title || "Site Buddy Report", text: "Site Buddy report PDF", files: [file] });
      toast("Shared");
      return;
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 3000);
    toast("Downloaded (sharing not supported)");
  }catch(err){
    console.error(err);
    toast("Share failed");
  }
};

/* =========================
   PWA install + SW
========================= */
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $("btnInstall").style.display = "inline-block";
});
$("btnInstall").onclick = async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  $("btnInstall").style.display = "none";
};
window.addEventListener("appinstalled", () => {
  toast("Installed");
  $("btnInstall").style.display = "none";
});

if("serviceWorker" in navigator){
  window.addEventListener("load", async () => {
    try{ await navigator.serviceWorker.register("./sw.js"); }
    catch(e){ console.warn("SW registration failed", e); }
  });
}

/* =========================
   Reset
========================= */
$("btnReset").onclick = async () => {
  const ok = confirm("Reset Site Buddy? This deletes all offline data on this device.");
  if(!ok) return;

  await closeCamera();
  closeAnno();

  for(const [, url] of state.photoUrlCache.entries()){
    URL.revokeObjectURL(url);
  }
  state.photoUrlCache.clear();

  await new Promise((resolve) => {
    const req = indexedDB.deleteDatabase(DB_NAME);
    req.onsuccess = () => resolve(true);
    req.onerror = () => resolve(true);
    req.onblocked = () => resolve(true);
  });

  state.projects = [];
  state.selectedProjectId = null;
  state.selectedIssueId = null;
  render();
  clearSig();
  toast("Reset complete");
};

/* =========================
   Inputs / Filters
========================= */
["pTitle","pRef","pClient","pNotes"].forEach(id => {
  $(id).addEventListener("input", () => $("btnSaveProject").disabled = !getProject());
});
$("issueFilter").addEventListener("change", renderIssues);
$("issueSearch").addEventListener("input", () => {
  clearTimeout(window.__q);
  window.__q = setTimeout(renderIssues, 120);
});

/* =========================
   Init
========================= */
clearSig();
loadAll();
</script>
</body>
</html>
