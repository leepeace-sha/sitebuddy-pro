<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#b00020"/>
  <link rel="manifest" href="manifest.webmanifest">
  <title>Site Buddy</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    :root{--bg:#ffffff;--text:#0b1220;--muted:#667085;--border:#b00020;--shadow:0 14px 40px rgba(16,24,40,.10);--radius:18px;--focus:rgba(176,0,32,.20);--chip:#f8fafc;--ok:#0f766e;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 700px at 15% -10%,rgba(176,0,32,.10),transparent 60%),radial-gradient(900px 600px at 110% 20%,rgba(16,24,40,.08),transparent 55%),var(--bg);color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.80));backdrop-filter:blur(12px);border-bottom:3px solid var(--border);box-shadow:0 10px 30px rgba(16,24,40,.08);}
    .wrap{max-width:1180px;margin:0 auto;padding:14px 16px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;min-width:260px;}
    .mark{width:46px;height:46px;border-radius:16px;border:2px solid rgba(176,0,32,.55);display:grid;place-items:center;background:#fff;overflow:hidden;box-shadow:0 8px 22px rgba(176,0,32,.14);}
    .mark img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{border:1px solid rgba(16,24,40,.12);background:#fff;color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:900;box-shadow:0 1px 0 rgba(0,0,0,.02);}
    button.primary{background:linear-gradient(180deg,#b00020,#8a0018);color:#fff;border-color:rgba(0,0,0,.08);box-shadow:0 14px 30px rgba(176,0,32,.22);}
    button.secondary{background:rgba(176,0,32,.08);border-color:rgba(176,0,32,.25);}
    button.ghost{background:transparent;}
    button.danger{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.35);}
    button:disabled{opacity:.5;cursor:not-allowed}
    main{max-width:1180px;margin:0 auto;padding:18px 16px 40px;}
    .grid{display:grid;grid-template-columns:320px 1fr 420px;gap:14px;align-items:start}
    @media (max-width:1100px){.grid{grid-template-columns:1fr;}}
    .card{background:rgba(255,255,255,.90);border:1px solid rgba(16,24,40,.10);border-top:4px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;}
    .card h2{margin:0 0 10px;font-size:14px;letter-spacing:.3px}
    .tiny{font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{flex:1}
    label{display:block;font-size:12px;font-weight:800;margin-bottom:6px;color:rgba(16,24,40,.72)}
    input[type="text"],input[type="date"],select,textarea{width:100%;padding:10px 12px;border-radius:14px;border:1px solid rgba(16,24,40,.14);background:#fff;outline:none;}
    input[type="text"]:focus,input[type="date"]:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px var(--focus);border-color:rgba(176,0,32,.35)}
    textarea{min-height:88px;resize:vertical}
    .hr{height:1px;background:rgba(16,24,40,.10);margin:12px 0}
    .list{max-height:320px;overflow:auto;border:1px solid rgba(16,24,40,.10);border-radius:14px;background:#fff}
    .item{padding:10px 12px;border-bottom:1px solid rgba(16,24,40,.08);cursor:pointer}
    .item:hover{background:rgba(176,0,32,.05)}
    .item.active{background:rgba(176,0,32,.10);border-left:4px solid var(--border)}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{display:inline-flex;gap:8px;align-items:center;border-radius:999px;padding:8px 10px;background:var(--chip);border:1px solid rgba(16,24,40,.10);font-size:12px;font-weight:900;cursor:pointer}
    .chip.active{background:rgba(176,0,32,.10);border-color:rgba(176,0,32,.25)}
    .photoGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .thumb{border-radius:14px;overflow:hidden;border:1px solid rgba(16,24,40,.12);background:#fff;position:relative}
    .thumb img{width:100%;height:110px;object-fit:cover;display:block}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(16,24,40,.92);color:#fff;padding:10px 12px;border-radius:999px;font-size:12px;opacity:0;pointer-events:none;transition:.2s;z-index:999}
    .toast.show{opacity:1}
    canvas{border:1px solid rgba(16,24,40,.14);border-radius:14px;background:#fff;touch-action:none}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .backdrop.show{display:flex}
    .modal{width:min(1180px,96vw);height:min(820px,92vh);background:#fff;border-radius:22px;overflow:hidden;border:1px solid rgba(255,255,255,.20);box-shadow:0 28px 90px rgba(0,0,0,.35);display:flex;flex-direction:column}
    .modalTop{padding:12px 14px;border-bottom:1px solid rgba(16,24,40,.10);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .modalBody{padding:10px;overflow:auto;display:grid;place-items:center;flex:1}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="mark"><img alt="Site Buddy" src="icons/icon-192.png" onerror="this.style.display='none'"></div>
        <div>
          <h1>Site Buddy</h1>
          <p>Offline audits • Photos • Pins • Reports • PWA</p>
        </div>
      </div>
      <div class="actions">
        <button id="btnNewProject">+ New Project</button>
        <button id="btnNewIssue">+ New Issue</button>
        <button class="secondary" id="btnExportPdf">Export PDF</button>
        <button class="ghost" id="btnSharePdf">Share PDF</button>
        <button class="ghost" id="btnInstall">Install</button>
        <button class="danger" id="btnReset">Reset</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <h2>Projects <span class="tiny" style="font-weight:700">Select a project</span></h2>
      <div id="projectList" class="list"></div>
    </section>

    <section class="card">
      <h2>Project Details</h2>
      <div class="row">
        <div>
          <label>Title</label>
          <input id="pTitle" type="text" placeholder="e.g. Riverside Apartments">
        </div>
        <div>
          <label>Reference</label>
          <input id="pRef" type="text" placeholder="e.g. RA-2026-02">
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label>Client</label>
          <input id="pClient" type="text" placeholder="Client name">
        </div>
      </div>
      <div style="margin-top:10px;">
        <label>Notes</label>
        <textarea id="pNotes" placeholder="Site access, contacts, scope..."></textarea>
      </div>

      <div class="hr"></div>

      <h2>Branding</h2>
      <div class="row">
        <div class="thumb" style="height:110px;display:grid;place-items:center;">
          <img id="companyLogoPreview" alt="Company logo" style="max-width:100%;max-height:100%;display:none;">
          <span id="companyLogoPlaceholder" class="tiny">Upload your company logo</span>
        </div>
        <div>
          <input id="companyLogoInput" type="file" accept="image/*"/>
          <div style="display:flex;gap:10px;margin-top:8px;"><button class="ghost" id="btnClearCompanyLogo">Clear</button></div>
        </div>
      </div>

      <div class="hr"></div>

      <h2>Site Plan / Drawing</h2>
      <p class="tiny">Upload JPEG / PNG / PDF (PDF first page auto-converted)</p>
      <input id="planUpload" type="file" accept="image/jpeg,image/png,application/pdf"/>
      <div class="row" style="margin-top:10px;">
        <button class="secondary" id="btnOpenPlan" disabled>Open Plan for Pinning</button>
      </div>
      <div id="planPreview" class="thumb" style="margin-top:10px;display:grid;place-items:center;min-height:120px;">
        <img alt="Plan preview" style="display:none;max-width:100%;height:auto;">
        <span class="tiny">No plan uploaded.</span>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="primary" id="btnSaveProject">Save</button>
        <button class="danger" id="btnDeleteProject">Delete</button>
      </div>
      <p class="tiny" style="margin-top:10px;">Stored offline on this device (IndexedDB).</p>
    </section>

    <section class="card">
      <h2>Issues <span class="tiny" style="font-weight:700">Per project</span></h2>

      <div class="chips">
        <div class="chip active" data-filter="all">Filter <span class="tiny" style="font-weight:800">All</span></div>
        <div class="chip" data-filter="open">Open</div>
        <div class="chip" data-filter="closed">Closed</div>
      </div>

      <div style="margin-top:10px;">
        <label>Search</label>
        <input id="issueSearch" type="text" placeholder="Search issues...">
      </div>

      <div class="hr"></div>

      <h2>Issue Details</h2>
      <p class="tiny" id="issueHint">Select a project, then create an issue.</p>

      <div class="row">
        <div>
          <label>Issue ID</label>
          <input id="iId" type="text" placeholder="Auto" disabled>
        </div>
        <div>
          <label>Title</label>
          <input id="iTitle" type="text" placeholder="e.g. Damaged handrail">
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Status</label>
          <select id="iStatus">
            <option value="open">Open</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <label>Severity</label>
          <select id="iSeverity">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Assignee</label>
          <input id="iAssignee" type="text" placeholder="Name">
        </div>
        <div>
          <label>Due date</label>
          <input id="iDue" type="date">
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Location / Area</label>
        <input id="iLocation" type="text" placeholder="e.g. Stairwell A, Level 3">
      </div>

      <div style="margin-top:10px;">
        <label>Notes</label>
        <textarea id="iNotes" placeholder="Describe the issue, action required, etc."></textarea>
        <div class="row">
          <button class="secondary" id="btnCamera">Open Camera</button>
          <button class="ghost" id="btnQuickCapture">Quick Capture</button>

          <!-- UPDATED: allow PDFs in issue upload -->
          <label style="margin:0;flex:1;">
            <span class="tiny">Or upload:</span>
            <input id="iPhotoInput" type="file" accept="image/*,application/pdf" multiple capture="environment" style="margin-top:6px;"/>
          </label>
        </div>
        <div style="height:10px"></div>
        <div id="photoGrid" class="photoGrid"></div>
        <div class="row" style="margin-top:10px;">
          <button class="primary" id="btnSaveIssue">Save Issue</button>
          <button class="danger" id="btnDeleteIssue">Delete</button>
        </div>
        <div class="hr"></div>

        <h2 style="margin-bottom:6px;">Report Signature</h2>
        <p class="tiny">Draw a signature to include in the PDF report.</p>
        <canvas id="sigCanvas" width="700" height="220"></canvas>
        <div class="row" style="margin-top:8px;">
          <button class="ghost" id="btnClearSig">Clear signature</button>
          <button class="secondary" id="btnSaveSig">Save signature</button>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="backdrop" id="planBackdrop">
  <div class="modal">
    <div class="modalTop">
      <div>
        <div style="font-weight:900">Site Plan — Drop Pins</div>
        <div class="tiny">Tap anywhere to place/move pin → choose issue</div>
      </div>
      <button class="ghost" id="btnClosePlan">Close</button>
    </div>
    <div class="modalBody">
      <canvas id="planCanvas"></canvas>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

async function refreshProject(){
  if(!state.selectedProjectId) return;
  state.projects = await dbGetAllProjects();
}

async function loadPlan(){
  await refreshProject();
  const p = getProject();
  const img = $("planPreview").querySelector("img");
  const btn = $("btnOpenPlan");
  if(!p || !p.planDataUrl){ img.style.display="none"; btn.disabled=true; return; }
  img.src = p.planDataUrl; img.style.display = "block"; btn.disabled = false;
}

async function pdfToImage(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  const page = await pdf.getPage(1);
  const scale = 2.5;
  const viewport = page.getViewport({scale});
  const canvas = document.createElement("canvas");
  canvas.height = viewport.height; canvas.width = viewport.width;
  const ctx = canvas.getContext("2d");
  await page.render({canvasContext: ctx, viewport}).promise;
  return canvas.toDataURL("image/png", 0.95);
}

/* Issue attachment upload (images + PDFs → first page PNG) */
function addIssueAttachmentPreview(dataUrl, sourceLabel){
  const grid = document.getElementById("photoGrid");
  if(!grid) return;

  const wrap = document.createElement("div");
  wrap.className = "thumb";
  wrap.style.position = "relative";

  const img = document.createElement("img");
  img.src = dataUrl;
  img.alt = sourceLabel || "Attachment";
  img.loading = "lazy";

  wrap.appendChild(img);

  if(sourceLabel){
    const badge = document.createElement("div");
    badge.textContent = sourceLabel;
    badge.style.position = "absolute";
    badge.style.left = "8px";
    badge.style.bottom = "8px";
    badge.style.padding = "4px 8px";
    badge.style.borderRadius = "999px";
    badge.style.fontSize = "11px";
    badge.style.fontWeight = "800";
    badge.style.background = "rgba(255,255,255,.88)";
    badge.style.border = "1px solid rgba(16,24,40,.12)";
    wrap.appendChild(badge);
  }

  grid.prepend(wrap);

  // If your full app defines a persistence hook, call it.
  if(typeof window.onIssueAttachmentAdded === "function"){
    try{ window.onIssueAttachmentAdded({ dataUrl, sourceLabel }); }catch(_){}
  }
}

document.getElementById("iPhotoInput")?.addEventListener("change", async (e) => {
  const files = Array.from(e.target.files || []);
  if(!files.length) return;

  for(const file of files){
    try{
      if(file.type === "application/pdf"){
        if(typeof toast==="function") toast("Converting PDF...");
        const dataUrl = await pdfToImage(file);
        addIssueAttachmentPreview(dataUrl, "PDF (page 1)");
      } else if(file.type.startsWith("image/")){
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        addIssueAttachmentPreview(dataUrl, "Image");
      } else {
        if(typeof toast==="function") toast("Unsupported file: " + (file.name || "unknown"));
      }
    } catch(err){
      console.error(err);
      if(typeof toast==="function") toast("Couldn’t process: " + (file.name || "file"));
    }
  }

  e.target.value = "";
});

$("planUpload").onchange = async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const p = getProject();
  if(!p) return toast("Select a project first");

  let dataUrl;
  if(file.type === "application/pdf"){
    toast("Converting PDF...");
    dataUrl = await pdfToImage(file);
  } else {
    dataUrl = await new Promise(r => {
      const reader = new FileReader();
      reader.onload = () => r(reader.result);
      reader.readAsDataURL(file);
    });
  }

  p.planDataUrl = dataUrl;
  p.updated = Date.now();
  await dbPut("projects", p);
  await refreshProject();
  await loadPlan();
  toast("✅ JPEG / PNG / PDF uploaded!");
  e.target.value = "";
};

$("btnOpenPlan").onclick = async () => {
  await refreshProject();
  const p = getProject();
  if(!p || !p.planDataUrl) return toast("Upload JPEG, PNG or PDF first");
  openPlanModal();
};

/* Plan modal */
const planCanvas = $("planCanvas");
const planCtx = planCanvas.getContext("2d");
let planImg = null;
let currentPlanX = 0, currentPlanY = 0;

async function openPlanModal(){
  const p = getProject();
  planImg = await new Promise(r => {const i=new Image();i.onload=()=>r(i);i.src=p.planDataUrl;});
  const ratio = Math.min(1100/planImg.width, 700/planImg.height, 1);
  planCanvas.width = planImg.width * ratio;
  planCanvas.height = planImg.height * ratio;
  $("planBackdrop").classList.add("show");
  drawPlan();
}

function drawPlan(){
  planCtx.clearRect(0,0,planCanvas.width,planCanvas.height);
  planCtx.drawImage(planImg,0,0,planCanvas.width,planCanvas.height);
  const p = getProject();
  let num = 1;
  (p.issues||[]).forEach(issue=>{if(issue.pin){drawPin(planCtx, issue.pin.x*planCanvas.width, issue.pin.y*planCanvas.height, num++);}});
}

function drawPin(ctx,x,y,num){
  ctx.save();
  ctx.fillStyle="#b00020";ctx.strokeStyle="#fff";ctx.lineWidth=4;
  ctx.beginPath();ctx.arc(x,y,18,0,Math.PI*2);ctx.fill();ctx.stroke();
  ctx.fillStyle="#fff";ctx.font="900 20px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";
  ctx.fillText(num,x,y+1);
  ctx.restore();
}

/* Rest of your app code (you can keep your full script if you have it, but for now this will make the upload work) */
async function init(){
  // ... your DB and other init code ...
  loadPlan();
}
init();
</script>
</body>
</html>
