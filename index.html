<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Site Buddy (Offline)</title>
<style>
  :root{--red:#b00020;--ink:#101828;--muted:#667085;--bg:#fff;--card:#ffffff;--bd:rgba(16,24,40,.12);--r:16px}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,rgba(176,0,32,.06),transparent 35%),#fff;color:var(--ink)}
  header{position:sticky;top:0;z-index:10;background:rgba(255,255,255,.9);backdrop-filter:blur(10px);border-bottom:3px solid var(--red)}
  .wrap{max-width:1200px;margin:0 auto;padding:12px 14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  h1{margin:0;font-size:16px}
  .muted{color:var(--muted);font-size:12px}
  button,select,input,textarea{font:inherit}
  button{border:1px solid var(--bd);background:#fff;border-radius:14px;padding:10px 12px;font-weight:800;cursor:pointer}
  button.primary{background:var(--red);border-color:rgba(176,0,32,.4);color:#fff}
  button:disabled{opacity:.45;cursor:not-allowed}
  select,input,textarea{border:1px solid var(--bd);border-radius:14px;padding:10px 10px;background:#fff;min-width:0}
  textarea{min-height:86px;resize:vertical}
  main{max-width:1200px;margin:0 auto;padding:14px}
  .grid{display:grid;grid-template-columns:360px 1fr;gap:12px}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--bd);border-left:5px solid var(--red);border-radius:var(--r);padding:12px}
  .list{display:flex;flex-direction:column;gap:8px;max-height:560px;overflow:auto;padding-right:3px}
  .item{border:1px solid var(--bd);border-radius:14px;padding:10px;cursor:pointer}
  .item.active{border-color:rgba(176,0,32,.35);background:rgba(176,0,32,.04)}
  .pill{display:inline-flex;border:1px solid var(--bd);border-radius:999px;padding:3px 8px;font-size:12px;color:var(--muted);gap:6px;align-items:center}
  .pill.red{border-color:rgba(176,0,32,.35);color:var(--red);background:rgba(176,0,32,.05)}
  .pill.ok{border-color:rgba(15,118,110,.28);color:#0f766e;background:rgba(15,118,110,.05)}
  .meta{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .hr{height:1px;background:rgba(16,24,40,.10);margin:12px 0}
  .modalBackdrop{position:fixed;inset:0;background:rgba(16,24,40,.45);display:none;align-items:center;justify-content:center;padding:14px;z-index:50}
  .modalBackdrop.show{display:flex}
  .modal{background:#fff;border:1px solid rgba(176,0,32,.25);border-radius:18px;max-width:1040px;width:100%;box-shadow:0 18px 70px rgba(0,0,0,.28);overflow:hidden}
  .modalHead{display:flex;justify-content:space-between;gap:10px;align-items:center;padding:12px;border-bottom:1px solid rgba(16,24,40,.10);background:linear-gradient(180deg,rgba(176,0,32,.06),#fff)}
  .modalBody{padding:12px}
  canvas{max-width:100%;border:1px solid var(--bd);border-radius:14px;background:#fff;touch-action:none}
  .pickerList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:8px}
  .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#101828;color:#fff;padding:10px 12px;border-radius:999px;font-size:12px;opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:100}
  .toast.show{opacity:1}
</style>
</head>
<body>
<header>
  <div class="wrap row">
    <div class="grow">
      <h1>üìç Site Buddy</h1>
      <div class="muted">Offline projects ‚Ä¢ issues ‚Ä¢ PDF plan pins (1 pin per issue) ‚Ä¢ export</div>
    </div>
    <button class="primary" id="btnNewProject">+ New Project</button>
    <button id="btnNewIssue" disabled>+ New Issue</button>
    <select id="template" style="width:180px">
      <option value="client" selected>Client-ready PDF</option>
      <option value="internal">Internal PDF</option>
    </select>
    <button class="primary" id="btnExport" disabled>Export PDF</button>
    <button id="btnReset">Reset</button>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div style="font-weight:900">Projects</div>
          <div class="muted">Select a project</div>
        </div>
        <div class="pill red" id="projCount">0</div>
      </div>
      <div class="hr"></div>
      <div class="list" id="projectList"></div>
      <div class="hr"></div>

      <div style="font-weight:900">Project details</div>
      <label class="muted">Title</label>
      <input id="pTitle" placeholder="e.g., Riverside Apartments ‚Äì Block B">
      <div class="row">
        <div class="grow">
          <label class="muted">Reference</label>
          <input id="pRef" placeholder="e.g., RB-2026-014">
        </div>
        <div class="grow">
          <label class="muted">Client</label>
          <input id="pClient" placeholder="e.g., Acme Property">
        </div>
      </div>
      <label class="muted">Notes</label>
      <textarea id="pNotes" placeholder="Optional site notes‚Ä¶"></textarea>

      <div class="row">
        <button class="primary" id="btnSaveProject" disabled>Save</button>
        <button id="btnDeleteProject" disabled>Delete</button>
      </div>

      <div class="hr"></div>
      <div style="font-weight:900">Drawings (PDF plans)</div>
      <label class="muted">Upload PDF</label>
      <input id="drawingUpload" type="file" accept="application/pdf">
      <label class="muted">Drawing name (optional)</label>
      <input id="drawingName" placeholder="e.g., Level 2 Floor Plan">
      <div class="muted" id="drawingHint" style="margin-top:8px"></div>
      <div class="list" id="drawingList" style="max-height:240px;margin-top:10px"></div>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div style="font-weight:900">Issues</div>
          <div class="muted" id="issueHint">Select a project, then create an issue.</div>
        </div>
        <div class="pill" id="openCount">0 open</div>
      </div>
      <div class="hr"></div>

      <div class="row">
        <select id="issueFilter" style="width:140px">
          <option value="all">All</option>
          <option value="open" selected>Open</option>
          <option value="closed">Closed</option>
        </select>
        <input id="issueSearch" class="grow" placeholder="Search by code/title/location/assignee/pin‚Ä¶">
      </div>

      <div class="hr"></div>
      <div class="grid" style="grid-template-columns:420px 1fr">
        <div class="list" id="issueList" style="max-height:540px"></div>

        <div>
          <div style="font-weight:900">Issue details</div>
          <div class="muted">Pin is assigned when you place it on a drawing (one per issue).</div>
          <div class="hr"></div>

          <div class="row">
            <div class="grow">
              <label class="muted">Code</label>
              <input id="iCode" disabled>
            </div>
            <div class="grow">
              <label class="muted">Pin #</label>
              <input id="iPin" disabled placeholder="(No pin yet)">
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <label class="muted">Linked drawing</label>
              <input id="iDrawingLink" disabled placeholder="(Not linked)">
            </div>
            <button id="btnOpenLinkedDrawing" disabled>Open</button>
            <button id="btnDropPinForIssue" disabled>Drop pin</button>
          </div>

          <label class="muted">Title</label>
          <input id="iTitle" placeholder="e.g., Missing handrail at stairwell">

          <div class="row">
            <div class="grow">
              <label class="muted">Status</label>
              <select id="iStatus">
                <option value="open" selected>Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div class="grow">
              <label class="muted">Severity</label>
              <select id="iSeverity">
                <option value="low">Low</option>
                <option value="medium" selected>Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="grow">
              <label class="muted">Assignee</label>
              <input id="iAssignee" placeholder="e.g., Subcontractor / Team">
            </div>
            <div class="grow">
              <label class="muted">Due date</label>
              <input id="iDueDate" type="date">
            </div>
          </div>

          <label class="muted">Location / Area</label>
          <input id="iLocation" placeholder="e.g., Level 2 ‚Äì Corridor C">

          <label class="muted">Notes</label>
          <textarea id="iNotes" placeholder="Describe the issue, action required, etc."></textarea>

          <div class="row">
            <button class="primary" id="btnSaveIssue" disabled>Save issue</button>
            <button id="btnDeleteIssue" disabled>Delete</button>
          </div>

          <div class="hr"></div>
          <div style="font-weight:900">Signature (optional, used in PDF)</div>
          <div class="muted">Draw below, then ‚ÄúSave signature‚Äù.</div>
          <div style="height:8px"></div>
          <canvas id="sigCanvas" width="900" height="240"></canvas>
          <div class="row" style="margin-top:8px">
            <button id="btnSigClear">Clear</button>
            <button id="btnSigSave">Save signature</button>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Drawing Viewer -->
<div class="modalBackdrop" id="drawingBackdrop">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div style="font-weight:900" id="drawingModalTitle">Drawing</div>
        <div class="muted" id="drawingPageInfo"></div>
      </div>
      <div class="row">
        <button id="btnPrevPage">Prev</button>
        <button id="btnNextPage">Next</button>
        <button class="primary" id="btnTogglePinMode">Drop Pin</button>
        <button id="btnCloseDrawing">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <canvas id="drawingCanvas" width="1400" height="900"></canvas>
      <div class="muted" id="pinModeHint" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<!-- Issue Picker Modal -->
<div class="modalBackdrop" id="pickerBackdrop">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Link pin to existing issue</div>
        <div class="muted">Pick an issue to link this pin (moves pin if issue already had one).</div>
      </div>
      <div class="row">
        <button id="btnPickerCancel">Cancel</button>
      </div>
    </div>
    <div class="modalBody">
      <label class="muted">Search</label>
      <input id="pickerSearch" placeholder="Search by code/title/assignee/pin‚Ä¶">
      <div style="height:10px"></div>
      <div class="pickerList" id="pickerList"></div>
      <div class="muted" id="pickerHint" style="margin-top:10px"></div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.min.js"></script>
<script>
/* ===== pdf.js worker ===== */
pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.4.168/build/pdf.worker.min.js";

/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);
const uid = ()=> Math.random().toString(36).slice(2,10)+"-"+Date.now().toString(36);
const safe = (s)=>String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
const toastEl=$("toast");
function toast(msg){ toastEl.textContent=msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"),1400); }
const pad3=(n)=>String(n).padStart(3,"0");
const issueCode=(n)=>`SB-${pad3(n)}`;
function todayISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;}
function isOverdue(i){ if(!i?.dueDate || i.status==="closed") return false; const t=new Date();t.setHours(0,0,0,0); const d=new Date(i.dueDate+"T00:00:00"); return d<t; }

/* ===== IndexedDB ===== */
const DB="sitebuddy_db_min_v1", VER=1;
function openDB(){
  return new Promise((resolve,reject)=>{
    const req=indexedDB.open(DB,VER);
    req.onupgradeneeded=()=>{
      const db=req.result;
      if(!db.objectStoreNames.contains("projects")) db.createObjectStore("projects",{keyPath:"id"});
      if(!db.objectStoreNames.contains("drawings")){
        const s=db.createObjectStore("drawings",{keyPath:"id"});
        s.createIndex("by_projectId","projectId",{unique:false});
      }
      if(!db.objectStoreNames.contains("signatures")) db.createObjectStore("signatures",{keyPath:"projectId"});
    };
    req.onsuccess=()=>resolve(req.result);
    req.onerror=()=>reject(req.error);
  });
}
async function dbPut(store,val){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(store,"readwrite");t.oncomplete=()=>res(true);t.onerror=()=>rej(t.error);t.objectStore(store).put(val);});}
async function dbGet(store,key){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(store,"readonly");const r=t.objectStore(store).get(key);r.onsuccess=()=>res(r.result||null);r.onerror=()=>rej(r.error);});}
async function dbDel(store,key){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction(store,"readwrite");t.oncomplete=()=>res(true);t.onerror=()=>rej(t.error);t.objectStore(store).delete(key);});}
async function dbGetAllProjects(){const db=await openDB();return new Promise((res,rej)=>{const t=db.transaction("projects","readonly");const r=t.objectStore("projects").getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>rej(r.error);});}
async function dbGetDrawingsByProjectId(projectId){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const t=db.transaction("drawings","readonly");
    const idx=t.objectStore("drawings").index("by_projectId");
    const r=idx.getAll(projectId);
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}

/* ===== State ===== */
const state={projects:[],selectedProjectId:null,selectedIssueId:null};
const project=()=>state.projects.find(p=>p.id===state.selectedProjectId)||null;
const issue=()=>project()?.issues?.find(i=>i.id===state.selectedIssueId)||null;

/* ===== Pin numbering: ONE pin per issue ===== */
function ensureCounters(p){
  if(typeof p.issueCounter!=="number") p.issueCounter=0;
  if(typeof p.pinCounter!=="number"){
    const maxPin=Math.max(0,...(p.issues||[]).map(i=>Number(i.drawingPinNo||0)));
    p.pinCounter=maxPin;
  }
}
function ensureIssuePin(p,i){
  if(i.drawingPinNo) return i.drawingPinNo;
  ensureCounters(p);
  p.pinCounter += 1;
  i.drawingPinNo = p.pinCounter;
  return i.drawingPinNo;
}

/* ===== UI render ===== */
function renderProjects(){
  $("projCount").textContent=String(state.projects.length);
  const list=$("projectList"); list.innerHTML="";
  if(state.projects.length===0){ list.innerHTML=`<div class="muted">No projects yet. Click ‚ÄúNew Project‚Äù.</div>`; }
  for(const p of state.projects){
    const el=document.createElement("div");
    el.className="item"+(p.id===state.selectedProjectId?" active":"");
    const open=(p.issues||[]).filter(i=>i.status==="open").length;
    el.innerHTML=`
      <div style="font-weight:900">${safe(p.title||"Untitled")}</div>
      <div class="meta">
        <span class="pill">${safe(p.reference||"No ref")}</span>
        <span class="pill">${safe(p.client||"No client")}</span>
        <span class="pill red">${open} open</span>
        <span class="pill">${(p.issues||[]).length} total</span>
      </div>`;
    el.onclick=()=>{ state.selectedProjectId=p.id; state.selectedIssueId=null; renderAll(); loadSig(); toast("Project selected"); };
    list.appendChild(el);
  }
  const p=project();
  $("btnNewIssue").disabled=!p;
  $("btnExport").disabled=!p;
  $("btnSaveProject").disabled=!p;
  $("btnDeleteProject").disabled=!p;

  $("pTitle").value=p?.title||"";
  $("pRef").value=p?.reference||"";
  $("pClient").value=p?.client||"";
  $("pNotes").value=p?.notes||"";
}

function renderIssues(){
  const p=project();
  const list=$("issueList"); list.innerHTML="";
  if(!p){ $("issueHint").textContent="Select a project, then create an issue."; $("openCount").textContent="0 open"; return; }
  $("issueHint").textContent="Tap an issue to edit. Pins are added in a drawing.";
  const filter=$("issueFilter").value;
  const q=$("issueSearch").value.trim().toLowerCase();
  let issues=(p.issues||[]).slice();
  if(filter!=="all") issues=issues.filter(i=>i.status===filter);
  if(q){
    issues=issues.filter(i=>
      (i.code||"").toLowerCase().includes(q) ||
      (i.title||"").toLowerCase().includes(q) ||
      (i.location||"").toLowerCase().includes(q) ||
      (i.assignee||"").toLowerCase().includes(q) ||
      String(i.drawingPinNo||"").includes(q)
    );
  }
  const open=(p.issues||[]).filter(i=>i.status==="open").length;
  $("openCount").textContent=`${open} open`;
  if(issues.length===0){ list.innerHTML=`<div class="muted">No issues match.</div>`; return; }

  for(const i of issues){
    const el=document.createElement("div");
    el.className="item"+(i.id===state.selectedIssueId?" active":"");
    const pin=i.drawingPinNo?`Pin ${i.drawingPinNo}`:"No pin";
    const statusP=i.status==="closed"?"pill ok":"pill red";
    const overdue=isOverdue(i);
    el.innerHTML=`
      <div style="font-weight:900">${safe(i.code)} ‚Ä¢ ${safe(i.title||"Untitled")}</div>
      <div class="meta">
        <span class="${statusP}">${safe(i.status)}</span>
        <span class="pill">${safe(i.severity||"medium")}</span>
        <span class="pill">${safe(pin)}</span>
        <span class="pill">${safe(i.location||"No location")}</span>
        ${i.assignee?`<span class="pill">Assignee: ${safe(i.assignee)}</span>`:""}
        ${i.dueDate?`<span class="pill ${overdue?"red":""}">Due: ${safe(i.dueDate)}${overdue?" (Overdue)":""}</span>`:""}
      </div>`;
    el.onclick=()=>{ state.selectedIssueId=i.id; renderIssues(); renderIssueDetail(); };
    list.appendChild(el);
  }
}

async function renderIssueDetail(){
  const p=project(), i=issue();
  const has=p && i;
  $("btnSaveIssue").disabled=!has;
  $("btnDeleteIssue").disabled=!has;

  $("iCode").value=i?.code||"";
  $("iPin").value=i?.drawingPinNo?String(i.drawingPinNo):"";
  $("iTitle").value=i?.title||"";
  $("iStatus").value=i?.status||"open";
  $("iSeverity").value=i?.severity||"medium";
  $("iAssignee").value=i?.assignee||"";
  $("iDueDate").value=i?.dueDate||"";
  $("iLocation").value=i?.location||"";
  $("iNotes").value=i?.notes||"";

  $("btnOpenLinkedDrawing").disabled=!(i?.drawingId);
  $("btnDropPinForIssue").disabled=!(p && i);
  if(i?.drawingId){
    const dr=await dbGet("drawings", i.drawingId);
    $("iDrawingLink").value = `${dr?.name||"Drawing"} ‚Ä¢ Page ${i.drawingPage||1}`;
  } else $("iDrawingLink").value="";
}

/* ===== Projects CRUD ===== */
async function saveProject(p){ await dbPut("projects",p); state.projects=await dbGetAllProjects(); }

$("btnNewProject").onclick=async()=>{
  const p={id:uid(),title:"New Project",reference:"",client:"",notes:"",issueCounter:0,pinCounter:0,issues:[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};
  await saveProject(p); state.selectedProjectId=p.id; state.selectedIssueId=null; renderAll(); loadSig(); toast("Project created");
};
$("btnSaveProject").onclick=async()=>{
  const p=project(); if(!p) return;
  p.title=$("pTitle").value.trim()||"Untitled Project";
  p.reference=$("pRef").value.trim();
  p.client=$("pClient").value.trim();
  p.notes=$("pNotes").value.trim();
  p.updatedAt=new Date().toISOString();
  await saveProject(p); renderProjects(); toast("Project saved");
};
$("btnDeleteProject").onclick=async()=>{
  const p=project(); if(!p) return;
  if(!confirm(`Delete project "${p.title}"?`)) return;
  const drawings=await dbGetDrawingsByProjectId(p.id);
  for(const d of drawings) await dbDel("drawings", d.id);
  await dbDel("signatures", p.id);
  await dbDel("projects", p.id);
  state.projects=await dbGetAllProjects();
  state.selectedProjectId=state.projects[0]?.id||null;
  state.selectedIssueId=null;
  renderAll(); loadSig(); toast("Project deleted");
};

/* ===== Issues CRUD ===== */
$("btnNewIssue").onclick=async()=>{
  const p=project(); if(!p) return;
  ensureCounters(p);
  p.issueCounter += 1;
  const i={id:uid(),code:issueCode(p.issueCounter),title:"New Issue",status:"open",severity:"medium",assignee:"",dueDate:"",location:"",notes:"",
    drawingId:null,drawingPage:null,drawingX:null,drawingY:null,drawingPinNo:null,
    createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()
  };
  p.issues=[i, ...(p.issues||[])]; p.updatedAt=new Date().toISOString();
  await saveProject(p); state.selectedIssueId=i.id; renderAll(); toast(`Issue created (${i.code})`);
};
$("btnSaveIssue").onclick=async()=>{
  const p=project(), i=issue(); if(!p||!i) return;
  i.title=$("iTitle").value.trim()||"Untitled Issue";
  i.status=$("iStatus").value;
  i.severity=$("iSeverity").value;
  i.assignee=$("iAssignee").value.trim();
  i.dueDate=$("iDueDate").value;
  i.location=$("iLocation").value.trim();
  i.notes=$("iNotes").value.trim();
  i.updatedAt=new Date().toISOString();
  p.updatedAt=new Date().toISOString();
  await saveProject(p); renderIssues(); toast("Issue saved");
};
$("btnDeleteIssue").onclick=async()=>{
  const p=project(), i=issue(); if(!p||!i) return;
  if(!confirm(`Delete issue ${i.code}?`)) return;
  p.issues=(p.issues||[]).filter(x=>x.id!==i.id);
  p.updatedAt=new Date().toISOString();
  await saveProject(p);
  state.selectedIssueId=null; renderAll(); toast("Issue deleted");
};

$("issueFilter").onchange=()=>renderIssues();
$("issueSearch").oninput=()=>{ clearTimeout(window.__t); window.__t=setTimeout(renderIssues,120); };

/* ===== Drawings ===== */
$("drawingUpload").addEventListener("change", async (e)=>{
  const p=project(); if(!p){ toast("Select a project first"); e.target.value=""; return; }
  const file=e.target.files?.[0]; if(!file) return;
  if(file.type!=="application/pdf"){ toast("Upload a PDF"); e.target.value=""; return; }
  const name=($("drawingName").value||"").trim() || file.name.replace(/\.pdf$/i,"");
  let pageCount=null;
  try{ const ab=await file.arrayBuffer(); const pdf=await pdfjsLib.getDocument({data:ab}).promise; pageCount=pdf.numPages; pdf.destroy?.(); }catch(_){}
  const rec={id:uid(),projectId:p.id,name,blob:file,pageCount,createdAt:new Date().toISOString()};
  await dbPut("drawings", rec);
  $("drawingName").value=""; e.target.value="";
  toast("Drawing saved offline");
  await renderDrawings();
});
async function renderDrawings(){
  const p=project();
  const list=$("drawingList"); list.innerHTML="";
  if(!p){ $("drawingHint").textContent="Select a project to upload drawings."; return; }
  const drawings=await dbGetDrawingsByProjectId(p.id);
  $("drawingHint").textContent = drawings.length ? "Tap a drawing to open and drop pins." : "No drawings yet. Upload a PDF.";
  for(const d of drawings){
    const el=document.createElement("div");
    el.className="item";
    el.innerHTML=`<div style="font-weight:900">${safe(d.name||"Untitled Drawing")}</div>
      <div class="meta"><span class="pill">${d.pageCount||"PDF"}</span><span class="pill">tap to open</span></div>`;
    el.onclick=()=>openDrawing(d.id,1);
    list.appendChild(el);
  }
}

/* ===== Drawing modal with pins ===== */
const drawing={current:null,pdf:null,page:1,pinMode:false,pendingPoint:null,forceIssueId:null};

function drawPin(ctx,x,y,num){
  ctx.save();
  ctx.fillStyle="#b00020"; ctx.strokeStyle="#ffffff"; ctx.lineWidth=5;
  const r=22;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle="#ffffff"; ctx.font="900 22px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(String(num),x,y+1);
  ctx.restore();
}

async function openDrawing(drawingId,page=1){
  const rec=await dbGet("drawings", drawingId);
  if(!rec){ toast("Drawing not found"); return; }
  drawing.current=rec; drawing.page=page; drawing.pinMode=false; drawing.pendingPoint=null;
  const ab=await rec.blob.arrayBuffer();
  drawing.pdf=await pdfjsLib.getDocument({data:ab}).promise;
  $("drawingModalTitle").textContent=rec.name||"Drawing";
  $("drawingBackdrop").classList.add("show");
  $("pinModeHint").textContent="";
  await renderDrawingPage();
}

async function renderDrawingPage(){
  const p=project();
  if(!p||!drawing.pdf||!drawing.current) return;
  const canvas=$("drawingCanvas"), ctx=canvas.getContext("2d");
  const page=await drawing.pdf.getPage(drawing.page);
  const vp=page.getViewport({scale:1.6});
  canvas.width=Math.round(vp.width); canvas.height=Math.round(vp.height);
  ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
  await page.render({canvasContext:ctx,viewport:vp}).promise;
  $("drawingPageInfo").textContent=`Page ${drawing.page} of ${drawing.pdf.numPages}`;

  // draw all pins on this page for this drawing
  const pins=(p.issues||[]).filter(i=>i.drawingId===drawing.current.id && i.drawingPage===drawing.page && i.drawingPinNo);
  pins.sort((a,b)=>(a.drawingPinNo||0)-(b.drawingPinNo||0));
  for(const i of pins){
    drawPin(ctx,(i.drawingX||0)*canvas.width,(i.drawingY||0)*canvas.height,i.drawingPinNo);
  }
}

$("btnCloseDrawing").onclick=()=>{ $("drawingBackdrop").classList.remove("show"); drawing.current=null; drawing.pdf=null; drawing.page=1; drawing.pinMode=false; drawing.pendingPoint=null; drawing.forceIssueId=null; };
$("btnPrevPage").onclick=async()=>{ if(!drawing.pdf) return; if(drawing.page>1){ drawing.page--; await renderDrawingPage(); } };
$("btnNextPage").onclick=async()=>{ if(!drawing.pdf) return; if(drawing.page<drawing.pdf.numPages){ drawing.page++; await renderDrawingPage(); } };

$("btnTogglePinMode").onclick=()=>{
  if(!drawing.current) return;
  drawing.pinMode=!drawing.pinMode;
  $("pinModeHint").textContent = drawing.pinMode
    ? (drawing.forceIssueId ? "Tap to place pin for the selected issue." : "Tap to place pin. You will choose an issue (or create one).")
    : "";
  toast(drawing.pinMode ? "Pin mode on" : "Pin mode off");
};

$("drawingCanvas").addEventListener("click", async (e)=>{
  const p=project();
  if(!p||!drawing.current||!drawing.pdf||!drawing.pinMode) return;
  const canvas=$("drawingCanvas");
  const r=canvas.getBoundingClientRect();
  const x=(e.clientX-r.left)/r.width;
  const y=(e.clientY-r.top)/r.height;
  drawing.pendingPoint={x,y,page:drawing.page,drawingId:drawing.current.id};

  // If we came from "Drop pin" on issue detail, link to that issue directly.
  if(drawing.forceIssueId){
    const i=p.issues.find(z=>z.id===drawing.forceIssueId);
    if(i) await linkPinToIssue(p,i);
    return;
  }

  const wantExisting = confirm("Link this pin to an EXISTING issue?\nPress Cancel to CREATE a new issue.");
  if(wantExisting){
    const chosen = await openIssuePicker();
    if(!chosen) { toast("Cancelled"); return; }
    await linkPinToIssue(p, chosen);
  } else {
    const created = await createIssueForPin(p);
    await linkPinToIssue(p, created);
  }
});

async function createIssueForPin(p){
  ensureCounters(p);
  p.issueCounter += 1;
  const i={id:uid(),code:issueCode(p.issueCounter),title:"New Issue",status:"open",severity:"medium",assignee:"",dueDate:"",location:"",notes:"",
    drawingId:null,drawingPage:null,drawingX:null,drawingY:null,drawingPinNo:null,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()
  };
  p.issues=[i, ...(p.issues||[])];
  p.updatedAt=new Date().toISOString();
  await saveProject(p);
  return i;
}

/* ===== Issue Picker Modal ===== */
let pickerResolve=null;
function openIssuePicker(){
  $("pickerBackdrop").classList.add("show");
  $("pickerSearch").value="";
  renderPicker("");
  $("pickerHint").textContent="Selecting an issue will move its existing pin (one pin total).";
  return new Promise((resolve)=>{ pickerResolve=resolve; });
}
function closePicker(result){
  $("pickerBackdrop").classList.remove("show");
  const r=pickerResolve; pickerResolve=null;
  if(r) r(result||null);
}
$("btnPickerCancel").onclick=()=>closePicker(null);
$("pickerSearch").oninput=(e)=>renderPicker(e.target.value.trim().toLowerCase());

function renderPicker(q){
  const p=project();
  const list=$("pickerList"); list.innerHTML="";
  if(!p){ list.innerHTML=`<div class="muted">No project.</div>`; return; }
  let issues=(p.issues||[]).slice();
  if(q){
    issues=issues.filter(i=>
      (i.code||"").toLowerCase().includes(q) ||
      (i.title||"").toLowerCase().includes(q) ||
      (i.assignee||"").toLowerCase().includes(q) ||
      (i.location||"").toLowerCase().includes(q) ||
      String(i.drawingPinNo||"").includes(q)
    );
  }
  if(issues.length===0){ list.innerHTML=`<div class="muted">No matching issues.</div>`; return; }
  issues=issues.slice(0,60);
  for(const i of issues){
    const el=document.createElement("div");
    el.className="item";
    const pin=i.drawingPinNo?`Pin ${i.drawingPinNo}`:"No pin";
    el.innerHTML=`<div style="font-weight:900">${safe(i.code)} ‚Ä¢ ${safe(i.title||"Untitled")}</div>
      <div class="meta">
        <span class="pill">${safe(pin)}</span>
        <span class="pill">${safe(i.status)}</span>
        <span class="pill">${safe(i.severity||"medium")}</span>
        ${i.assignee?`<span class="pill">Assignee: ${safe(i.assignee)}</span>`:""}
      </div>`;
    el.onclick=()=>closePicker(i);
    list.appendChild(el);
  }
}

/* ===== Link pin to issue (one pin per issue, MOVE if already pinned) ===== */
async function linkPinToIssue(p,i){
  const pt=drawing.pendingPoint; if(!pt) return;

  if(i.drawingPinNo && i.drawingId){
    const ok=confirm(`${i.code} already has Pin ${i.drawingPinNo}.\nMove it to this new location?`);
    if(!ok) return;
  }

  const pinNo=ensureIssuePin(p,i);
  i.drawingId=pt.drawingId;
  i.drawingPage=pt.page;
  i.drawingX=pt.x;
  i.drawingY=pt.y;
  i.updatedAt=new Date().toISOString();
  p.updatedAt=new Date().toISOString();
  await saveProject(p);

  drawing.pinMode=false;
  drawing.pendingPoint=null;
  drawing.forceIssueId=null;
  $("pinModeHint").textContent="";
  await renderDrawingPage();

  state.selectedIssueId=i.id;
  renderIssues();
  renderIssueDetail();
  toast(`Pin ${pinNo} linked to ${i.code}`);
}

/* ===== Open linked drawing / drop pin for selected issue ===== */
$("btnOpenLinkedDrawing").onclick=async()=>{
  const i=issue(); if(!i?.drawingId) return;
  await openDrawing(i.drawingId, i.drawingPage||1);
};
$("btnDropPinForIssue").onclick=async()=>{
  const p=project(), i=issue(); if(!p||!i){ return; }
  const drawings=await dbGetDrawingsByProjectId(p.id);
  if(drawings.length===0){ toast("Upload a drawing first"); return; }
  // open first drawing; you can open another from list in Projects panel
  await openDrawing(drawings[0].id, 1);
  drawing.forceIssueId=i.id;
  drawing.pinMode=true;
  $("pinModeHint").textContent="Tap to place pin for the selected issue (moves existing pin).";
  toast("Tap plan to place pin");
};

/* ===== Signature ===== */
const sigCanvas=$("sigCanvas"), sigCtx=sigCanvas.getContext("2d");
sigCanvas.style.touchAction="none";
const sig={drawing:false};
function clearSig(){
  sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
  sigCtx.strokeStyle="rgba(16,24,40,.18)";
  sigCtx.lineWidth=2;
  sigCtx.beginPath(); sigCtx.moveTo(40,sigCanvas.height-60); sigCtx.lineTo(sigCanvas.width-40,sigCanvas.height-60); sigCtx.stroke();
}
function sigPos(e){
  const r=sigCanvas.getBoundingClientRect();
  return {x:(e.clientX-r.left)*(sigCanvas.width/r.width), y:(e.clientY-r.top)*(sigCanvas.height/r.height)};
}
sigCanvas.addEventListener("pointerdown",(e)=>{e.preventDefault();sig.drawing=true;sigCanvas.setPointerCapture(e.pointerId);const {x,y}=sigPos(e);sigCtx.strokeStyle="#101828";sigCtx.lineWidth=3.8;sigCtx.lineCap="round";sigCtx.lineJoin="round";sigCtx.beginPath();sigCtx.moveTo(x,y);});
sigCanvas.addEventListener("pointermove",(e)=>{if(!sig.drawing) return; e.preventDefault(); const {x,y}=sigPos(e); sigCtx.lineTo(x,y); sigCtx.stroke();});
function sigUp(e){ if(!sig.drawing) return; e.preventDefault(); sig.drawing=false; try{sigCanvas.releasePointerCapture(e.pointerId);}catch(_){} }
sigCanvas.addEventListener("pointerup",sigUp); sigCanvas.addEventListener("pointercancel",sigUp); sigCanvas.addEventListener("pointerleave",sigUp);
$("btnSigClear").onclick=()=>{clearSig();toast("Signature cleared");};
$("btnSigSave").onclick=async()=>{
  const p=project(); if(!p){ toast("Select a project"); return; }
  await dbPut("signatures",{projectId:p.id,dataUrl:sigCanvas.toDataURL("image/png")});
  toast("Signature saved");
};
async function loadSig(){
  clearSig();
  const p=project(); if(!p) return;
  const rec=await dbGet("signatures",p.id);
  if(!rec?.dataUrl) return;
  const img=new Image();
  img.onload=()=>{
    const maxW=sigCanvas.width-80, maxH=sigCanvas.height-80;
    const r=Math.min(maxW/img.width, maxH/img.height, 1);
    const w=img.width*r, h=img.height*r;
    sigCtx.drawImage(img,(sigCanvas.width-w)/2,(sigCanvas.height-h)/2,w,h);
  };
  img.src=rec.dataUrl;
}

/* ===== Export PDF (includes plan pages with pins + legend) ===== */
function safeFile(s){ return String(s||"Report").replace(/[^a-z0-9-_]+/gi,"_").slice(0,60); }
function drawPdfPin(ctx,x,y,num){
  ctx.save();
  ctx.fillStyle="#b00020"; ctx.strokeStyle="#ffffff"; ctx.lineWidth=6;
  const r=26; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.stroke();
  ctx.fillStyle="#ffffff"; ctx.font="900 26px system-ui"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(String(num),x,y+1); ctx.restore();
}
async function exportPdf(){
  const p=project(); if(!p){ toast("Select a project"); return; }
  const template=$("template").value || "client";
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:"pt",format:"a4"});
  const m=46, pageW=doc.internal.pageSize.getWidth(), pageH=doc.internal.pageSize.getHeight(), contentW=pageW-m*2;

  const frame=()=>{
    doc.setDrawColor(176,0,32); doc.setLineWidth(3); doc.rect(m,m,contentW,pageH-m*2);
    if(template==="internal"){
      doc.setFillColor(176,0,32); doc.roundedRect(pageW-m-120, m+10, 120, 22, 8, 8, "F");
      doc.setTextColor(255,255,255); doc.setFont("helvetica","bold"); doc.setFontSize(10);
      doc.text("INTERNAL", pageW-m-60, m+26, {align:"center"});
      doc.setTextColor(0,0,0);
    }
  };

  // Cover
  frame();
  doc.setFont("helvetica","bold"); doc.setFontSize(22);
  doc.text(p.title||"Site Buddy Report", m+16, 110, {maxWidth:contentW-32});
  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(`Reference: ${p.reference||"-"}`, m+16, 146);
  doc.text(`Client: ${p.client||"-"}`, m+16, 162);
  doc.text(`Generated: ${new Date().toLocaleString()}`, m+16, 178);
  const issues=(p.issues||[]).slice();
  doc.text(`Total issues: ${issues.length}`, m+16, 194);

  // Signature (if any)
  const sig=await dbGet("signatures",p.id);
  if(sig?.dataUrl){
    doc.setFont("helvetica","bold"); doc.text("Signature:", m+16, 230);
    doc.addImage(sig.dataUrl,"PNG", m+16, 238, 220, 80);
  }

  // Drawing pages with pins + legend
  const linked=issues.filter(i=>i.drawingId && i.drawingPinNo);
  if(linked.length){
    const groups=new Map();
    for(const i of linked){
      const key=`${i.drawingId}::${i.drawingPage||1}`;
      if(!groups.has(key)) groups.set(key,[]);
      groups.get(key).push(i);
    }
    const drawings=await dbGetDrawingsByProjectId(p.id);

    for(const [key, arr] of groups.entries()){
      const [drawingId, pageStr]=key.split("::");
      const pageNo=Number(pageStr||1);
      const dRec=drawings.find(d=>d.id===drawingId);
      if(!dRec) continue;

      const ab=await dRec.blob.arrayBuffer();
      const pdf=await pdfjsLib.getDocument({data:ab}).promise;
      const pg=await pdf.getPage(pageNo);
      const vp=pg.getViewport({scale:1.25});

      const c=document.createElement("canvas");
      c.width=Math.round(vp.width); c.height=Math.round(vp.height);
      const ctx=c.getContext("2d");
      ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height);
      await pg.render({canvasContext:ctx,viewport:vp}).promise;

      arr.sort((a,b)=>(a.drawingPinNo||0)-(b.drawingPinNo||0));
      for(const i of arr) drawPdfPin(ctx,(i.drawingX||0)*c.width,(i.drawingY||0)*c.height,i.drawingPinNo);
      const img=c.toDataURL("image/jpeg",0.9);

      doc.addPage(); frame();
      doc.setFont("helvetica","bold"); doc.setFontSize(16);
      doc.text(`Drawing: ${dRec.name||"Plan"} (Page ${pageNo})`, m+16, 110);

      const x=m+16, y=130, boxW=contentW-32, boxH=380;
      doc.addImage(img,"JPEG", x, y, boxW, boxH, undefined, "FAST");

      let ly=y+boxH+24;
      doc.setFontSize(12); doc.text("Pin Legend", x, ly); ly+=18;
      doc.setFont("helvetica","normal"); doc.setFontSize(11);
      for(const i of arr){
        const line=`${i.drawingPinNo}. ${i.code} ‚Ä¢ ${i.title||"Untitled"} ‚Ä¢ ${i.status} ‚Ä¢ ${i.severity} ‚Ä¢ ${i.assignee||"-"}`;
        const wrapped=doc.splitTextToSize(line, contentW-32);
        doc.text(wrapped, x, ly);
        ly += wrapped.length*14 + 4;
        if(ly > pageH - m - 30) break;
      }
      pdf.destroy?.();
    }
  }

  // Issue pages
  for(const i of issues){
    doc.addPage(); frame();
    doc.setFont("helvetica","bold"); doc.setFontSize(16);
    doc.text(`${i.code} ‚Ä¢ ${i.drawingPinNo?("Pin "+i.drawingPinNo):"No pin"}`, m+16, 110);
    doc.setFontSize(12); doc.text(i.title||"Untitled", m+16, 132, {maxWidth:contentW-32});
    doc.setFont("helvetica","normal"); doc.setFontSize(11);
    doc.text(`Status: ${i.status}   Severity: ${i.severity}`, m+16, 160);
    doc.text(`Assignee: ${i.assignee||"-"}   Due: ${i.dueDate||"-"}`, m+16, 178);
    doc.text(`Location: ${i.location||"-"}`, m+16, 196);
    const notes=i.notes||"-";
    const wrapped=doc.splitTextToSize(notes, contentW-32);
    doc.text(wrapped, m+16, 224);
  }

  const tag = template==="internal" ? "_INTERNAL" : "_CLIENT";
  doc.save(`SiteBuddy_${safeFile(p.title||"Report")}${tag}.pdf`);
  toast("PDF exported");
}
$("btnExport").onclick=exportPdf;

/* ===== Reset ===== */
$("btnReset").onclick=async()=>{
  if(!confirm("Reset? This deletes all offline data for this app on this device.")) return;
  $("drawingBackdrop").classList.remove("show");
  $("pickerBackdrop").classList.remove("show");
  await new Promise((resolve)=>{ const r=indexedDB.deleteDatabase(DB); r.onsuccess=()=>resolve(true); r.onerror=()=>resolve(true); r.onblocked=()=>resolve(true); });
  state.projects=[]; state.selectedProjectId=null; state.selectedIssueId=null;
  renderAll(); clearSig(); toast("Reset complete");
};

/* ===== Init ===== */
function renderAll(){ renderProjects(); renderIssues(); renderIssueDetail(); renderDrawings(); $("btnDropPinForIssue").disabled=!(project()&&issue()); }
async function init(){
  state.projects=await dbGetAllProjects();
  if(state.projects.length) state.selectedProjectId=state.projects[0].id;
  clearSig();
  renderAll();
  await loadSig();
}
init();
</script>
</body>
</html>
