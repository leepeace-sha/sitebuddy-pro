<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#b00020"/>
  <link rel="manifest" href="manifest.webmanifest">
  <title>Site Buddy</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    :root{--bg:#ffffff;--text:#0b1220;--muted:#667085;--border:#b00020;--shadow:0 14px 40px rgba(16,24,40,.10);--radius:18px;--focus:rgba(176,0,32,.20);--chip:#f8fafc;--ok:#0f766e;}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:radial-gradient(1200px 700px at 15% -10%,rgba(176,0,32,.10),transparent 60%),radial-gradient(900px 600px at 110% 20%,rgba(16,24,40,.08),transparent 55%),var(--bg);color:var(--text);}
    header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(255,255,255,.92),rgba(255,255,255,.80));backdrop-filter:blur(12px);border-bottom:3px solid var(--border);box-shadow:0 10px 30px rgba(16,24,40,.08);}
    .wrap{max-width:1180px;margin:0 auto;padding:14px 16px;}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .brand{display:flex;align-items:center;gap:12px;min-width:260px;}
    .mark{width:46px;height:46px;border-radius:16px;border:2px solid rgba(176,0,32,.55);display:grid;place-items:center;background:#fff;overflow:hidden;box-shadow:0 8px 22px rgba(176,0,32,.14);}
    .mark img{width:100%;height:100%;object-fit:cover}
    .brand h1{margin:0;font-size:16px;letter-spacing:.2px}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    button{border:1px solid rgba(16,24,40,.12);background:#fff;color:var(--text);padding:10px 12px;border-radius:14px;cursor:pointer;font-weight:900;box-shadow:0 1px 0 rgba(0,0,0,.02);}
    button.primary{background:linear-gradient(180deg,#c40028,#b00020);color:#fff;border-color:rgba(176,0,32,.55);}
    button.secondary{background:linear-gradient(180deg,#1b2333,#101828);color:#fff;border-color:rgba(16,24,40,.22);}
    button.ghost{background:#fff;border-color:rgba(176,0,32,.30);color:var(--border);}
    button.danger{background:#fff;border-color:rgba(176,0,32,.45);color:var(--border);}
    button:disabled{opacity:.45;cursor:not-allowed}
    main .grid{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:16px 0 28px;}
    @media (max-width:980px){main .grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.95),rgba(255,255,255,.86));border:2px solid rgba(176,0,32,.14);border-left:6px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;}
    .card h2{margin:0 0 10px;font-size:14px;display:flex;justify-content:space-between;align-items:center;gap:10px;letter-spacing:.2px;}
    .sub{margin:6px 0 0;font-size:12px;color:var(--muted)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,textarea,select{width:100%;border:1px solid rgba(16,24,40,.14);border-radius:14px;padding:10px 10px;background:#fff;color:var(--text);outline:none;}
    input:focus,textarea:focus,select:focus{box-shadow:0 0 0 4px var(--focus);border-color:rgba(176,0,32,.35);}
    textarea{min-height:90px;resize:vertical}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    .list{display:flex;flex-direction:column;gap:8px;max-height:540px;overflow:auto;padding-right:4px;}
    .item{border:1px solid rgba(16,24,40,.12);border-left:5px solid transparent;border-radius:16px;padding:10px;cursor:pointer;background:#fff;transition:transform .06s ease,border-color .12s ease,box-shadow .12s ease;}
    .item:hover{transform:translateY(-1px);box-shadow:0 12px 30px rgba(16,24,40,.10)}
    .item.active{border-color:rgba(176,0,32,.30);border-left-color:var(--border);background:rgba(176,0,32,.03);}
    .item .title{font-weight:950;font-size:13px}
    .meta{margin-top:6px;display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)}
    .pill{border:1px solid rgba(16,24,40,.12);padding:4px 8px;border-radius:999px;background:var(--chip);white-space:nowrap;}
    .pill.open{border-color:rgba(176,0,32,.30);color:var(--border)}
    .pill.closed{border-color:rgba(15,118,110,.28);color:var(--ok)}
    .pill.high{border-color:rgba(176,0,32,.45);color:var(--border)}
    .pill.overdue{border-color:rgba(176,0,32,.55);color:var(--border);font-weight:950}
    .split{display:grid;grid-template-columns:1fr 430px;gap:14px;align-items:start;}
    @media (max-width:980px){.split{grid-template-columns:1fr}}
    .hr{height:1px;background:rgba(16,24,40,.10);margin:12px 0;}
    .tiny{font-size:11px;color:var(--muted)}
    .photoGrid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;}
    @media (max-width:560px){.photoGrid{grid-template-columns:1fr}}
    .photoCard{border:1px solid rgba(16,24,40,.12);border-radius:16px;overflow:hidden;background:#fff;box-shadow:0 10px 24px rgba(16,24,40,.08);}
    .photoCard img{width:100%;height:175px;object-fit:cover;display:block;}
    .photoCap{padding:8px 10px;display:flex;justify-content:space-between;align-items:center;gap:8px;color:var(--muted);font-size:12px;}
    .modalBackdrop{position:fixed;inset:0;background:rgba(16,24,40,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;}
    .modalBackdrop.show{display:flex}
    .modal{width:min(1020px,100%);background:#fff;border-radius:20px;box-shadow:0 18px 70px rgba(0,0,0,.35);overflow:hidden;border:2px solid rgba(176,0,32,.22);}
    .modalHead{display:flex;justify-content:space-between;align-items:center;gap:10px;padding:12px 14px;border-bottom:2px solid rgba(16,24,40,.08);background:linear-gradient(180deg,rgba(176,0,32,.06),rgba(255,255,255,.92));}
    .modalHead h3{margin:0;font-size:14px;letter-spacing:.2px}
    .modalBody{padding:12px 14px;}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;border:1px solid rgba(16,24,40,.10);border-radius:16px;padding:8px;background:rgba(176,0,32,.03);}
    .toolBtn{padding:8px 10px;border-radius:14px;font-weight:950}
    .toolBtn.active{box-shadow:0 0 0 4px var(--focus);border-color:rgba(176,0,32,.35)}
    canvas{max-width:100%;background:#fff;border-radius:16px;border:1px solid rgba(16,24,40,.12);touch-action:none}
    video{max-width:100%;border-radius:16px;border:1px solid rgba(16,24,40,.12);background:#000}
    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#101828;color:#fff;padding:10px 12px;border-radius:999px;font-size:12px;box-shadow:0 14px 45px rgba(0,0,0,.25);opacity:0;pointer-events:none;transition:opacity .15s ease;z-index:100;}
    .toast.show{opacity:1}
    .brandBox{display:flex;gap:10px;align-items:center;flex-wrap:wrap;border:1px dashed rgba(176,0,32,.35);border-radius:16px;padding:10px;background:rgba(176,0,32,.02);}
    .brandPreview{width:100px;height:46px;border-radius:14px;border:1px solid rgba(16,24,40,.10);background:#fff;display:grid;place-items:center;overflow:hidden;}
    .brandPreview img{width:100%;height:100%;object-fit:contain}
    .planPreview img{width:100%;height:160px;object-fit:cover;border-radius:12px;}
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="mark"><img src="app-icon.png" alt="Site Buddy"/></div>
      <div><h1>Site Buddy</h1><p>Offline audits • Photos • Pins • Reports • PWA</p></div>
    </div>
    <div class="actions">
      <button class="primary" id="btnNewProject">+ New Project</button>
      <button class="secondary" id="btnNewIssue" disabled>+ New Issue</button>
      <button class="primary" id="btnExport" disabled>Export PDF</button>
      <button class="secondary" id="btnShare" disabled>Share PDF</button>
      <button class="ghost" id="btnInstall" style="display:none;">Install</button>
      <button class="danger" id="btnReset">Reset</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h2>Projects <span class="tiny">Select a project</span></h2>
      <div id="projectList" class="list"></div>
      <div class="hr"></div>

      <h2>Project Details</h2>
      <label>Title</label>
      <input id="pTitle" placeholder="e.g., Riverside Apartments – Block B"/>

      <div class="row">
        <div><label>Reference</label><input id="pRef" placeholder="e.g., RB-2026-014"/></div>
        <div><label>Client</label><input id="pClient" placeholder="e.g., Acme Property"/></div>
      </div>

      <label>Notes</label>
      <textarea id="pNotes" placeholder="Optional site notes…"></textarea>

      <div class="hr"></div>
      <h2>Branding</h2>
      <div class="brandBox">
        <div class="brandPreview"><img id="companyLogoPreview" src="logo.png" alt="Company logo"/></div>
        <div style="flex:1;min-width:180px;">
          <div class="tiny" style="margin-bottom:6px;">Upload your company logo</div>
          <input id="companyLogoInput" type="file" accept="image/*"/>
          <div style="display:flex;gap:10px;margin-top:8px;"><button class="ghost" id="btnClearCompanyLogo">Clear</button></div>
        </div>
      </div>

      <div class="hr"></div>
      <h2>Site Plan / Drawing</h2>
      <div class="brandBox">
        <div id="planPreview" class="planPreview"><img src="" alt="Site plan" style="display:none;"></div>
        <div style="flex:1;min-width:180px;">
          <div class="tiny" style="margin-bottom:6px;">Upload JPEG / PNG / PDF (PDF first page auto-converted)</div>
          <input id="planUpload" type="file" accept="image/jpeg,image/png,application/pdf"/>
          <button class="ghost" id="btnOpenPlan" style="margin-top:8px;" disabled>Open Plan for Pinning</button>
        </div>
      </div>

      <div class="hr"></div>
      <div class="row">
        <button class="primary" id="btnSaveProject" disabled>Save</button>
        <button class="danger" id="btnDeleteProject" disabled>Delete</button>
      </div>
      <p class="sub">Stored offline on this device (IndexedDB).</p>
    </section>

    <section class="card">
      <h2>Issues <span class="tiny">Per project</span></h2>
      <div class="split">
        <div>
          <div class="row">
            <div><label>Filter</label><select id="issueFilter"><option value="all">All</option><option value="open">Open</option><option value="closed">Closed</option></select></div>
            <div><label>Search</label><input id="issueSearch" placeholder="Title / location / notes / assignee…"/></div>
          </div>
          <div style="height:10px"></div>
          <div id="issueList" class="list" style="max-height:380px;"></div>
        </div>
        <div>
          <h2 style="margin-bottom:6px;">Issue Details</h2>
          <p class="sub" id="issueHint">Select a project, then create an issue.</p>
          <div id="issueForm" style="display:none;">
            <label>Issue ID</label><input id="iCode" disabled />
            <label>Title</label><input id="iTitle" placeholder="e.g., Missing handrail at stairwell"/>
            <div class="row">
              <div><label>Status</label><select id="iStatus"><option value="open">Open</option><option value="closed">Closed</option></select></div>
              <div><label>Severity</label><select id="iSeverity"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
            </div>
            <div class="row">
              <div><label>Assignee</label><input id="iAssignee" placeholder="e.g., John / Subcontractor / Team"/></div>
              <div><label>Due date</label><input id="iDueDate" type="date"/></div>
            </div>
            <label>Location / Area</label><input id="iLocation" placeholder="e.g., Level 2 – Corridor C"/>
            <label>Notes</label><textarea id="iNotes" placeholder="Describe the issue, action required, etc."></textarea>
            <div class="row">
              <button class="secondary" id="btnCamera">Open Camera</button>
              <button class="ghost" id="btnQuickCapture">Quick Capture</button>
              <label style="margin:0;flex:1;"><span class="tiny">Or upload:</span><input id="iPhotoInput" type="file" accept="image/*" multiple capture="environment" style="margin-top:6px;"/></label>
            </div>
            <div style="height:10px"></div>
            <div id="photoGrid" class="photoGrid"></div>
            <div class="row" style="margin-top:10px;">
              <button class="primary" id="btnSaveIssue">Save Issue</button>
              <button class="danger" id="btnDeleteIssue">Delete</button>
            </div>
            <div class="hr"></div>
            <h2 style="margin-bottom:6px;">Report Signature</h2>
            <p class="tiny">Draw a signature to include in the PDF report.</p>
            <canvas id="sigCanvas" width="700" height="220"></canvas>
            <div class="row" style="margin-top:8px;">
              <button class="ghost" id="btnSigClear">Clear signature</button>
              <button class="ghost" id="btnSigSave">Save signature</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<div class="modalBackdrop" id="planBackdrop">
  <div class="modal" style="width:min(1100px,100%)">
    <div class="modalHead"><h3>Site Plan — Drop Pins</h3><button class="ghost" id="btnPlanClose">Close</button></div>
    <div class="modalBody">
      <canvas id="planCanvas" width="1100" height="700" style="max-width:100%;background:#fff;border:1px solid #ddd;border-radius:16px;cursor:crosshair;"></canvas>
      <div class="tiny" style="margin-top:8px;">Tap anywhere to place/move pin → choose issue</div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const DB_NAME = "sitebuddy_db_v6";
const DB_VER = 6;

let db;
function openDB(){ return new Promise((resolve, reject) => {
  const req = indexedDB.open(DB_NAME, DB_VER);
  req.onupgradeneeded = () => {
    const db = req.result;
    if(!db.objectStoreNames.contains("projects")) db.createObjectStore("projects", { keyPath:"id" });
    if(!db.objectStoreNames.contains("photos")) { const s = db.createObjectStore("photos", { keyPath:"id" }); s.createIndex("by_issueId", "issueId"); }
    if(!db.objectStoreNames.contains("signatures")) db.createObjectStore("signatures", { keyPath:"projectId" });
    if(!db.objectStoreNames.contains("branding")) db.createObjectStore("branding", { keyPath:"key" });
  };
  req.onsuccess = () => { db = req.result; resolve(); };
  req.onerror = () => reject(req.error);
}); }

async function dbGet(store, key){ return new Promise(r => { const tx = db.transaction(store,"readonly"); const req = tx.objectStore(store).get(key); req.onsuccess = () => r(req.result); }); }
async function dbPut(store, value){ return new Promise(r => { const tx = db.transaction(store,"readwrite"); tx.objectStore(store).put(value); tx.oncomplete = () => r(true); }); }
async function dbGetAllProjects(){ return new Promise(r => { const tx = db.transaction("projects","readonly"); const req = tx.objectStore("projects").getAll(); req.onsuccess = () => r(req.result.sort((a,b) => (b.updated||0) - (a.updated||0))); }); }

const state = { projects: [], selectedProjectId: null };
function $(id){ return document.getElementById(id); }
function toast(msg){ const t = $("toast"); t.textContent = msg; t.classList.add("show"); setTimeout(() => t.classList.remove("show"), 2200); }
function getProject(){ return state.projects.find(p => p.id === state.selectedProjectId); }

async function refreshProject(){
  if(!state.selectedProjectId) return;
  state.projects = await dbGetAllProjects();
}

async function loadPlan(){
  await refreshProject();
  const p = getProject();
  const img = $("planPreview").querySelector("img");
  const btn = $("btnOpenPlan");
  if(!p || !p.planDataUrl){ img.style.display="none"; btn.disabled=true; return; }
  img.src = p.planDataUrl;
  img.style.display = "block";
  btn.disabled = false;
}

async function pdfToImage(file){
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  const page = await pdf.getPage(1);
  const scale = 2.5;
  const viewport = page.getViewport({scale});
  const canvas = document.createElement("canvas");
  canvas.height = viewport.height; canvas.width = viewport.width;
  const ctx = canvas.getContext("2d");
  await page.render({canvasContext: ctx, viewport}).promise;
  return canvas.toDataURL("image/png", 0.95);
}

$("planUpload").onchange = async (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const p = getProject();
  if(!p) return toast("Select a project first");

  let dataUrl;
  if(file.type === "application/pdf"){
    toast("Converting PDF...");
    dataUrl = await pdfToImage(file);
  } else {
    dataUrl = await new Promise(r => {
      const reader = new FileReader();
      reader.onload = () => r(reader.result);
      reader.readAsDataURL(file);
    });
  }

  p.planDataUrl = dataUrl;
  p.updated = Date.now();
  await dbPut("projects", p);
  await refreshProject();
  await loadPlan();
  toast("Preview ready – click 'Open Plan for Pinning'");
  e.target.value = "";
};

$("btnOpenPlan").onclick = async () => {
  await refreshProject();
  const p = getProject();
  if(!p || !p.planDataUrl) return toast("Upload a file first");
  openPlanModal();
};

/* Plan modal */
const planCanvas = $("planCanvas");
const planCtx = planCanvas.getContext("2d");
let planImg = null;
let currentPlanX = 0, currentPlanY = 0;

async function openPlanModal(){
  const p = getProject();
  planImg = await new Promise(r => {const i=new Image();i.onload=()=>r(i);i.src=p.planDataUrl;});
  const ratio = Math.min(1100/planImg.width, 700/planImg.height, 1);
  planCanvas.width = planImg.width * ratio;
  planCanvas.height = planImg.height * ratio;
  $("planBackdrop").classList.add("show");
  drawPlan();
}

function drawPlan(){
  planCtx.clearRect(0,0,planCanvas.width,planCanvas.height);
  planCtx.drawImage(planImg,0,0,planCanvas.width,planCanvas.height);
  const p = getProject();
  let num = 1;
  (p.issues||[]).forEach(issue=>{if(issue.pin){drawPin(planCtx, issue.pin.x*planCanvas.width, issue.pin.y*planCanvas.height, num++);}});
}

function drawPin(ctx,x,y,num){
  ctx.save();
  ctx.fillStyle="#b00020";ctx.strokeStyle="#fff";ctx.lineWidth=4;
  ctx.beginPath();ctx.arc(x,y,18,0,Math.PI*2);ctx.fill();ctx.stroke();
  ctx.fillStyle="#fff";ctx.font="900 20px system-ui";ctx.textAlign="center";ctx.textBaseline="middle";
  ctx.fillText(num,x,y+1);
  ctx.restore();
}

async function init(){
  await openDB();
  state.projects = await dbGetAllProjects();
  if(!state.selectedProjectId && state.projects.length) state.selectedProjectId = state.projects[0].id;
  render();
  loadPlan();
}
init();
</script>
</body>
</html>
