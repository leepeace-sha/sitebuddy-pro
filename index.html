 <!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#b00020"/>
  <link rel="manifest" href="manifest.webmanifest">
  <title>Site Buddy</title>

  <style>
    :root{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#0b1220;
      --muted:#667085;
      --border:#b00020;
      --shadow: 0 14px 40px rgba(16,24,40,.10);
      --radius: 18px;
      --focus: rgba(176,0,32,.20);
      --btn:#b00020;
      --btnText:#fff;
      --btn2:#101828;
      --btn2Text:#fff;
      --danger:#b00020;
      --ok:#0f766e;
      --chip:#f8fafc;
      --soft:#f8fafc;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(176,0,32,.10), transparent 60%),
        radial-gradient(900px 600px at 110% 20%, rgba(16,24,40,.08), transparent 55%),
        var(--bg);
      color: var(--text);
    }

    header{
      position: sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      backdrop-filter: blur(12px);
      border-bottom: 3px solid var(--border);
      box-shadow: 0 10px 30px rgba(16,24,40,.08);
    }

    .wrap{max-width: 1180px; margin: 0 auto; padding: 14px 16px;}
    .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}

    .brand{display:flex; align-items:center; gap:12px; min-width: 260px;}
    .mark{
      width:46px; height:46px; border-radius:16px;
      border:2px solid rgba(176,0,32,.55);
      display:grid; place-items:center;
      background:#fff;
      overflow:hidden;
      box-shadow: 0 8px 22px rgba(176,0,32,.14);
    }
    .mark img{width:100%; height:100%; object-fit:contain}
    .brand h1{margin:0; font-size:16px; letter-spacing:.2px}
    .brand p{margin:2px 0 0; font-size:12px; color:var(--muted)}

    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
    .exportRow{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    button{
      border:1px solid rgba(16,24,40,.12);
      background:#fff;
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 900;
      box-shadow: 0 1px 0 rgba(0,0,0,.02);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    button:hover{ transform: translateY(-1px); box-shadow: 0 12px 30px rgba(16,24,40,.10); }
    button:active{ transform: translateY(0px) scale(.99); }
    button.primary{
      background: linear-gradient(180deg, #c40028, #b00020);
      color: var(--btnText);
      border-color: rgba(176,0,32,.55);
    }
    button.secondary{
      background: linear-gradient(180deg, #1b2333, #101828);
      color: var(--btn2Text);
      border-color: rgba(16,24,40,.22);
    }
    button.ghost{
      background:#fff;
      border-color: rgba(176,0,32,.30);
      color: var(--border);
    }
    button.danger{
      background:#fff;
      border-color: rgba(176,0,32,.45);
      color: var(--danger);
    }
    button:disabled{opacity:.45; cursor:not-allowed; transform:none; box-shadow:none}

    select, input, textarea{
      width:100%;
      border: 1px solid rgba(16,24,40,.14);
      border-radius: 14px;
      padding: 10px 10px;
      background:#fff;
      color: var(--text);
      outline:none;
    }
    select:focus, input:focus, textarea:focus{
      box-shadow: 0 0 0 4px var(--focus);
      border-color: rgba(176,0,32,.35);
    }
    textarea{min-height: 90px; resize: vertical}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    .tiny{font-size:11px; color:var(--muted)}
    .sub{margin:6px 0 0; font-size:12px; color:var(--muted)}
    .hr{height:1px; background: rgba(16,24,40,.10); margin:12px 0;}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.86));
      border: 2px solid rgba(176,0,32,.14);
      border-left: 6px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin:0 0 10px;
      font-size: 14px;
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      letter-spacing:.2px;
    }

    /* Tabs */
    .tabs{
      display:flex; gap:8px; flex-wrap:wrap;
      padding: 10px 16px 14px;
      border-top: 1px solid rgba(16,24,40,.08);
    }
    .tab{
      padding:10px 12px;
      border-radius: 999px;
      border:1px solid rgba(16,24,40,.12);
      background:#fff;
      font-weight: 950;
      cursor:pointer;
      display:flex; gap:8px; align-items:center;
    }
    .tab.active{
      border-color: rgba(176,0,32,.35);
      box-shadow: 0 0 0 4px var(--focus);
      color: var(--border);
    }
    .badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width: 24px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 950;
      border:1px solid rgba(16,24,40,.12);
      background: var(--chip);
      color: var(--muted);
    }
    .badge.red{border-color: rgba(176,0,32,.35); color: var(--border); background: rgba(176,0,32,.05);}

    /* Screens + transitions */
    .screenWrap{
      position: relative;
      min-height: 560px;
      padding: 16px 0 28px;
    }
    .screen{
      position:absolute; inset: 0;
      opacity:0;
      transform: translateY(10px);
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
    }
    .screen.active{
      opacity:1;
      transform: translateY(0);
      pointer-events:auto;
      position: relative;
    }
    @media (prefers-reduced-motion: reduce){
      .screen{transition:none}
      button{transition:none}
    }

    /* Layout */
    .grid2{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid2{grid-template-columns: 1fr} }

    .row{display:flex; gap:10px}
    .row>*{flex:1}

    .list{
      display:flex; flex-direction:column; gap:8px;
      max-height: 540px; overflow:auto; padding-right: 4px;
    }
    .item{
      border:1px solid rgba(16,24,40,.12);
      border-left: 5px solid transparent;
      border-radius: 16px;
      padding: 10px;
      cursor:pointer;
      background:#fff;
      transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .item:hover{transform: translateY(-1px); box-shadow: 0 12px 30px rgba(16,24,40,.10)}
    .item.active{
      border-color: rgba(176,0,32,.30);
      border-left-color: var(--border);
      background: rgba(176,0,32,.03);
    }
    .item .title{font-weight:950; font-size:13px}
    .meta{margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; font-size:12px; color:var(--muted)}
    .pill{
      border:1px solid rgba(16,24,40,.12);
      padding: 4px 8px;
      border-radius: 999px;
      background: var(--chip);
      white-space:nowrap;
    }
    .pill.open{border-color: rgba(176,0,32,.30); color: var(--border)}
    .pill.closed{border-color: rgba(15,118,110,.28); color: var(--ok)}
    .pill.high{border-color: rgba(176,0,32,.45); color: var(--border)}
    .pill.overdue{border-color: rgba(176,0,32,.55); color: var(--border); font-weight:950}

    /* Photos - squares */
    .photoGrid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:10px;
    }
    @media (max-width: 560px){ .photoGrid{grid-template-columns:1fr} }

    .photoCard{
      border:1px solid rgba(16,24,40,.12);
      border-radius: 16px;
      overflow:hidden;
      background:#fff;
      box-shadow: 0 10px 24px rgba(16,24,40,.08);
    }
    .photoSquare{
      position: relative;
      width:100%;
      aspect-ratio: 1 / 1;
      overflow:hidden;
      background:#fff;
    }
    .photoSquare::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(circle at 25% 20%, rgba(176,0,32,.08), transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(16,24,40,.08), transparent 55%),
        url("app-icon.png");
      background-repeat: no-repeat, no-repeat, no-repeat;
      background-size: auto, auto, 180px;
      background-position: center, center, center;
      opacity: .10;
      transform: rotate(-6deg);
      pointer-events:none;
    }
    .photoSquare img{
      position:absolute; inset:0;
      width:100%;
      height:100%;
      object-fit: cover;
      object-position: center;
      display:block;
    }
    .photoCap{
      padding: 8px 10px;
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      color:var(--muted); font-size:12px;
    }

    /* Dashboard */
    .dashGrid{
      display:grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap:10px;
      margin-bottom: 10px;
    }
    @media (max-width: 980px){ .dashGrid{grid-template-columns: repeat(2, minmax(0, 1fr));} }

    .dashTile{
      border:1px solid rgba(16,24,40,.12);
      border-radius: 16px;
      padding:10px;
      background: #fff;
      box-shadow: 0 10px 24px rgba(16,24,40,.06);
    }
    .dashTile .k{font-size:11px; color:var(--muted);}
    .dashTile .v{font-size:18px; font-weight:950; margin-top:2px;}
    .dashTile .s{font-size:11px; margin-top:6px; color:var(--muted);}
    .dashTile.red{border-left:5px solid var(--border);}
    .dashTile.green{border-left:5px solid var(--ok);}

    .panel{
      border:1px solid rgba(16,24,40,.12);
      border-radius: 16px;
      padding:10px;
      background:#fff;
      box-shadow: 0 10px 24px rgba(16,24,40,.06);
    }
    .panelHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
      flex-wrap:wrap;
    }
    .panelHead .t{font-weight:950; font-size:12px;}
    .panelHead .a{display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    .chartRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){ .chartRow{grid-template-columns:1fr;} }

    .chartBox{
      border:1px solid rgba(16,24,40,.10);
      border-radius: 16px;
      padding:10px;
      background: rgba(176,0,32,.02);
    }
    .chartTitle{font-size:12px; font-weight:950; margin-bottom:8px;}
    .chartCanvas{width:100%; height:180px; display:block; border-radius: 14px; background:#fff; border:1px solid rgba(16,24,40,.08);}

    .groupList{display:flex; flex-direction:column; gap:8px;}
    .groupRow{
      border:1px solid rgba(16,24,40,.10);
      border-radius: 16px;
      padding:10px;
      background:#fff;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .groupRow .name{font-weight:950; font-size:12px;}
    .groupRow .stats{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px;}
    .groupRow .stats .pill{font-size:11px}
    .groupRow .btns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    .dueList{display:flex; flex-direction:column; gap:8px; max-height:300px; overflow:auto;}
    .dueItem{
      border:1px solid rgba(16,24,40,.10);
      border-radius: 16px;
      padding:10px;
      background:#fff;
      cursor:pointer;
    }
    .dueItem:hover{box-shadow: 0 12px 30px rgba(16,24,40,.10)}
    .dueItem .line1{font-weight:950; font-size:12px;}
    .dueItem .line2{font-size:11px; color:var(--muted); margin-top:6px;}

    /* Areas screen */
    .areaCards{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width: 980px){ .areaCards{grid-template-columns: repeat(2, minmax(0, 1fr));} }
    @media (max-width: 520px){ .areaCards{grid-template-columns: 1fr;} }

    .areaCard{
      border:1px solid rgba(16,24,40,.12);
      border-radius: 18px;
      background:#fff;
      padding:12px;
      box-shadow: 0 10px 24px rgba(16,24,40,.06);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .areaCard:hover{transform: translateY(-1px); box-shadow: 0 14px 36px rgba(16,24,40,.10)}
    .areaCard .h{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .areaCard .name{font-weight:950; font-size:13px}
    .areaCard .nums{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}

    /* Modal */
    .modalBackdrop{
      position: fixed; inset:0;
      background: rgba(16,24,40,.45);
      display:none;
      align-items:center; justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .modalBackdrop.show{display:flex}
    .modal{
      width:min(1040px, 100%);
      background:#fff;
      border-radius: 20px;
      box-shadow: 0 18px 70px rgba(0,0,0,.35);
      overflow:hidden;
      border: 2px solid rgba(176,0,32,.22);
      transform: translateY(10px) scale(.99);
      opacity: 0;
      animation: modalIn .18s ease forwards;
    }
    @keyframes modalIn{
      to{ transform: translateY(0) scale(1); opacity: 1; }
    }
    .modalHead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding: 12px 14px;
      border-bottom: 2px solid rgba(16,24,40,.08);
      background: linear-gradient(180deg, rgba(176,0,32,.06), rgba(255,255,255,.92));
      flex-wrap:wrap;
    }
    .modalHead h3{margin:0; font-size:14px; letter-spacing:.2px}
    .modalBody{padding: 12px 14px;}
    .toolbar{
      display:flex; gap:8px; flex-wrap:wrap;
      align-items:center;
      border:1px solid rgba(16,24,40,.10);
      border-radius: 16px;
      padding: 8px;
      background: rgba(176,0,32,.03);
    }
    .toolBtn{padding:8px 10px; border-radius: 14px; font-weight:950}
    .toolBtn.active{box-shadow: 0 0 0 4px var(--focus); border-color: rgba(176,0,32,.35)}
    canvas{max-width:100%; background:#fff; border-radius: 16px; border:1px solid rgba(16,24,40,.12); touch-action:none}
    video{max-width:100%; border-radius: 16px; border:1px solid rgba(16,24,40,.12); background:#000}

    .toast{
      position: fixed; left:50%; bottom:16px;
      transform: translateX(-50%);
      background: #101828;
      color:#fff;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      box-shadow: 0 14px 45px rgba(0,0,0,.25);
      opacity:0;
      pointer-events:none;
      transition: opacity .15s ease;
      z-index: 100;
    }
    .toast.show{opacity:1}

    .brandBox{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      border:1px dashed rgba(176,0,32,.35);
      border-radius: 16px;
      padding:10px;
      background: rgba(176,0,32,.02);
    }
    .brandPreview{
      width:110px; height:50px;
      border-radius: 14px;
      border:1px solid rgba(16,24,40,.10);
      background:#fff;
      display:grid; place-items:center;
      overflow:hidden;
    }
    .brandPreview img{width:100%; height:100%; object-fit:contain}
  </style>
</head>

<body>
<header>
  <div class="wrap top">
    <div class="brand">
      <div class="mark"><img src="app-icon.png" alt="Site Buddy"/></div>
      <div>
        <h1>Site Buddy</h1>
        <p>Offline audits • Photos • Pins • Reports • PWA</p>
      </div>
    </div>

    <div class="actions">
      <button class="primary" id="btnNewProject">+ New Project</button>
      <button class="secondary" id="btnNewIssue" disabled>+ New Issue</button>

      <div class="exportRow">
        <select id="exportTemplate" style="width: 180px;">
          <option value="client" selected>Client-ready PDF</option>
          <option value="internal">Internal PDF</option>
        </select>
        <button class="primary" id="btnExport" disabled>Export PDF</button>
        <button class="secondary" id="btnShare" disabled>Share PDF</button>
      </div>

      <button class="ghost" id="btnInstall" style="display:none;">Install</button>
      <button class="danger" id="btnReset">Reset</button>
    </div>
  </div>

  <div class="tabs wrap" style="padding-top:0;">
    <div class="tab active" data-screen="dashboard">
      Dashboard <span class="badge" id="bTotal">0</span>
    </div>
    <div class="tab" data-screen="issues">
      Issues <span class="badge" id="bOpen">0</span>
    </div>
    <div class="tab" data-screen="areas">
      Areas <span class="badge" id="bAreas">0</span>
    </div>
    <div class="tab" data-screen="today">
      Today <span class="badge red" id="bDue">0</span>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="screenWrap">

    <!-- DASHBOARD SCREEN -->
    <section class="screen active" id="screen-dashboard">
      <div class="grid2">
        <section class="card">
          <h2>Projects <span class="tiny">Select a project</span></h2>
          <div id="projectList" class="list"></div>
          <div class="hr"></div>

          <h2>Project Details</h2>
          <label>Title</label>
          <input id="pTitle" placeholder="e.g., Riverside Apartments – Block B"/>

          <div class="row">
            <div>
              <label>Reference</label>
              <input id="pRef" placeholder="e.g., RB-2026-014"/>
            </div>
            <div>
              <label>Client</label>
              <input id="pClient" placeholder="e.g., Acme Property"/>
            </div>
          </div>

          <label>Notes</label>
          <textarea id="pNotes" placeholder="Optional site notes…"></textarea>

          <div class="hr"></div>
          <h2>Branding</h2>
          <div class="brandBox">
            <div class="brandPreview" title="Company logo used in PDF header">
              <img id="companyLogoPreview" src="logo.png" alt="Company logo"/>
            </div>
            <div style="flex:1; min-width: 180px;">
              <div class="tiny" style="margin-bottom:6px;">Upload your company logo (saved offline on this device)</div>
              <input id="companyLogoInput" type="file" accept="image/*"/>
              <div style="display:flex; gap:10px; margin-top:8px;">
                <button class="ghost" id="btnClearCompanyLogo" type="button">Clear</button>
              </div>
            </div>
          </div>

          <div class="hr"></div>
          <div class="row">
            <button class="primary" id="btnSaveProject" disabled>Save</button>
            <button class="danger" id="btnDeleteProject" disabled>Delete</button>
          </div>

          <p class="sub">Stored offline on this device (IndexedDB). No internet needed.</p>
        </section>

        <section class="card">
          <h2>Dashboard Overview <span class="tiny" id="dashTitleHint"></span></h2>

          <div class="dashGrid" id="dashGrid"></div>

          <div class="panel" style="margin-top:10px;">
            <div class="panelHead">
              <div class="t">Charts</div>
              <div class="a">
                <button class="ghost" id="btnExportOpen" type="button">Export Open</button>
                <button class="ghost" id="btnExportClosed" type="button">Export Closed</button>
                <button class="ghost" id="btnExportAll" type="button">Export All</button>
              </div>
            </div>
            <div class="chartRow">
              <div class="chartBox">
                <div class="chartTitle">Status (Open vs Closed)</div>
                <canvas id="chartStatus" class="chartCanvas" width="800" height="360"></canvas>
              </div>
              <div class="chartBox">
                <div class="chartTitle">Severity (Low / Medium / High)</div>
                <canvas id="chartSeverity" class="chartCanvas" width="800" height="360"></canvas>
              </div>
            </div>
            <div class="tiny" id="dashNote" style="margin-top:10px;"></div>
          </div>

          <div class="panel" style="margin-top:10px;">
            <div class="panelHead">
              <div class="t">Due today / overdue</div>
              <div class="a">
                <button class="ghost" id="btnExportDue" type="button">Export Due</button>
              </div>
            </div>
            <div class="dueList" id="dueList"></div>
            <div class="tiny" id="dueHint" style="margin-top:8px;"></div>
          </div>

          <div class="panel" style="margin-top:10px;">
            <div class="panelHead">
              <div class="t">Grouped by area</div>
              <div class="a">
                <button class="ghost" id="btnGoAreas" type="button">Open Areas</button>
              </div>
            </div>
            <div class="groupList" id="areaGroups"></div>
            <div class="tiny" id="areaHint" style="margin-top:8px;"></div>
          </div>
        </section>
      </div>
    </section>

    <!-- ISSUES SCREEN -->
    <section class="screen" id="screen-issues">
      <div class="grid2">
        <section class="card">
          <h2>Issues <span class="tiny">Per project</span></h2>

          <div class="row">
            <div>
              <label>Filter</label>
              <select id="issueFilter">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div>
              <label>Search</label>
              <input id="issueSearch" placeholder="Title / location / notes / assignee / SB-001…"/>
            </div>
          </div>

          <div style="height:10px"></div>
          <div id="issueList" class="list"></div>

          <div class="hr"></div>
          <div class="row">
            <button class="ghost" id="btnIssuesExportOpen" type="button">Export Open</button>
            <button class="ghost" id="btnIssuesExportClosed" type="button">Export Closed</button>
          </div>
        </section>

        <section class="card">
          <h2>Issue Details <span class="tiny" id="issueHint">Select a project, then create an issue.</span></h2>

          <div id="issueForm" style="display:none;">
            <label>Issue ID</label>
            <input id="iCode" disabled />

            <label>Title</label>
            <input id="iTitle" placeholder="e.g., Missing handrail at stairwell"/>

            <div class="row">
              <div>
                <label>Status</label>
                <select id="iStatus">
                  <option value="open">Open</option>
                  <option value="closed">Closed</option>
                </select>
              </div>
              <div>
                <label>Severity</label>
                <select id="iSeverity">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div>
                <label>Assignee</label>
                <input id="iAssignee" placeholder="e.g., John / Subcontractor / Team"/>
              </div>
              <div>
                <label>Due date</label>
                <input id="iDueDate" type="date"/>
              </div>
            </div>

            <label>Location / Area</label>
            <input id="iLocation" placeholder="e.g., Level 2 – Corridor C"/>

            <label>Notes</label>
            <textarea id="iNotes" placeholder="Describe the issue, action required, etc."></textarea>

            <div class="row">
              <button class="secondary" id="btnCamera" type="button">Open Camera</button>
              <button class="ghost" id="btnQuickCapture" type="button">Quick Capture</button>
              <label style="margin:0; flex:1;">
                <span class="tiny">Or upload:</span>
                <input id="iPhotoInput" type="file" accept="image/*" multiple capture="environment" style="margin-top:6px;"/>
              </label>
            </div>

            <div style="height:10px"></div>
            <div id="photoGrid" class="photoGrid"></div>

            <div class="row" style="margin-top:10px;">
              <button class="primary" id="btnSaveIssue" type="button">Save Issue</button>
              <button class="danger" id="btnDeleteIssue" type="button">Delete</button>
            </div>

            <div class="hr"></div>
            <h2 style="margin-bottom:6px;">Report Signature</h2>
            <p class="tiny">Draw a signature to include in the PDF report.</p>
            <canvas id="sigCanvas" width="700" height="220"></canvas>
            <div class="row" style="margin-top:8px;">
              <button class="ghost" id="btnSigClear" type="button">Clear signature</button>
              <button class="ghost" id="btnSigSave" type="button">Save signature</button>
            </div>

            <div class="hr"></div>
            <p class="tiny">Pins: open a photo → Annotate → Pin tool → tap to place 1,2,3… and label → PDF auto legend.</p>
          </div>
        </section>
      </div>
    </section>

    <!-- AREAS SCREEN -->
    <section class="screen" id="screen-areas">
      <section class="card">
        <h2>Areas <span class="tiny">Tap an area to open Area View</span></h2>
        <div class="row">
          <div>
            <label>Search areas</label>
            <input id="areaSearch" placeholder="e.g., Level 2, Corridor, Kitchen..."/>
          </div>
          <div>
            <label>Quick export</label>
            <button class="primary" id="btnAreasExportAll" type="button" style="width:100%;">Export All (Grouped)</button>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="areaCards" id="areaCards"></div>
        <div class="tiny" id="areasHint" style="margin-top:10px;"></div>
      </section>
    </section>

    <!-- TODAY SCREEN -->
    <section class="screen" id="screen-today">
      <section class="card">
        <h2>Today <span class="tiny">Overdue + Due today</span></h2>

        <div class="row">
          <div>
            <label>Assignee filter (optional)</label>
            <input id="todayAssignee" placeholder="Type an assignee name to filter…"/>
          </div>
          <div>
            <label>Quick export</label>
            <button class="primary" id="btnTodayExportDue" type="button" style="width:100%;">Export Due / Overdue</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="panel">
          <div class="panelHead">
            <div class="t">Due items</div>
            <div class="a">
              <button class="ghost" id="btnTodayJumpIssues" type="button">Open Issues</button>
            </div>
          </div>
          <div class="dueList" id="todayList"></div>
          <div class="tiny" id="todayHint" style="margin-top:8px;"></div>
        </div>
      </section>
    </section>

  </div>
</main>

<!-- Annotation Modal -->
<div class="modalBackdrop" id="annoBackdrop">
  <div class="modal">
    <div class="modalHead">
      <h3 id="annoTitle">Annotate Photo</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="ghost" id="btnAnnoUndo" type="button">Undo</button>
        <button class="ghost" id="btnAnnoClear" type="button">Clear</button>
        <button class="primary" id="btnAnnoSave" type="button">Save</button>
        <button class="danger" id="btnAnnoClose" type="button">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="toolbar" style="margin-bottom:10px;">
        <button class="toolBtn ghost active" data-tool="rect" type="button">Rectangle</button>
        <button class="toolBtn ghost" data-tool="arrow" type="button">Arrow</button>
        <button class="toolBtn ghost" data-tool="pin" type="button">Pin</button>
        <button class="toolBtn ghost" data-tool="text" type="button">Text</button>
        <span class="tiny" style="margin-left:auto;">Drag to draw • tap to place pin/text</span>
      </div>

      <canvas id="annoCanvas" width="1200" height="800"></canvas>
      <div class="tiny" id="pinHint" style="margin-top:8px;"></div>
    </div>
  </div>
</div>

<!-- Camera Modal -->
<div class="modalBackdrop" id="camBackdrop">
  <div class="modal">
    <div class="modalHead">
      <h3>Camera</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="primary" id="btnSnap" type="button">Snap Photo</button>
        <button class="ghost" id="btnCamSwitch" type="button">Switch camera</button>
        <button class="danger" id="btnCamClose" type="button">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <video id="camVideo" autoplay playsinline></video>
      <canvas id="camCanvas" width="1280" height="720" style="display:none;"></canvas>
      <p class="tiny">Android: Live preview needs HTTPS. Quick Capture always works.</p>
    </div>
  </div>
</div>

<!-- Area View Modal -->
<div class="modalBackdrop" id="areaBackdrop">
  <div class="modal">
    <div class="modalHead">
      <h3 id="areaModalTitle">Area View</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button class="ghost" id="btnAreaExport" type="button">Export this Area</button>
        <button class="secondary" id="btnAreaOpenIssues" type="button">View in Issues</button>
        <button class="danger" id="btnAreaClose" type="button">Close</button>
      </div>
    </div>
    <div class="modalBody">
      <div class="panel">
        <div class="panelHead">
          <div class="t">Area issues</div>
          <div class="a tiny" id="areaStats"></div>
        </div>
        <div class="list" id="areaIssueList" style="max-height:420px;"></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ===================== IndexedDB ===================== */
const DB_NAME = "sitebuddy_db_v8";
const DB_VER  = 1;

function openDB(){
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains("projects")){
        db.createObjectStore("projects", { keyPath:"id" });
      }
      if(!db.objectStoreNames.contains("photos")){
        const s = db.createObjectStore("photos", { keyPath:"id" });
        s.createIndex("by_issueId", "issueId", { unique:false });
      }
      if(!db.objectStoreNames.contains("signatures")){
        db.createObjectStore("signatures", { keyPath:"projectId" });
      }
      if(!db.objectStoreNames.contains("branding")){
        db.createObjectStore("branding", { keyPath:"key" });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}
async function dbPut(storeName, value){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(storeName, "readwrite");
    t.oncomplete = () => resolve(true);
    t.onerror = () => reject(t.error);
    t.objectStore(storeName).put(value);
  });
}
async function dbGet(storeName, key){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(storeName, "readonly");
    const req = t.objectStore(storeName).get(key);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}
async function dbDelete(storeName, key){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction(storeName, "readwrite");
    t.oncomplete = () => resolve(true);
    t.onerror = () => reject(t.error);
    t.objectStore(storeName).delete(key);
  });
}
async function dbGetAllProjects(){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction("projects", "readonly");
    const req = t.objectStore("projects").getAll();
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}
async function dbGetPhotosByIssueId(issueId){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction("photos", "readonly");
    const idx = t.objectStore("photos").index("by_issueId");
    const req = idx.getAll(issueId);
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}
async function dbDeletePhotosByIssueId(issueId){
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const t = db.transaction("photos", "readwrite");
    const store = t.objectStore("photos");
    const idx = store.index("by_issueId");
    const req = idx.openCursor(issueId);
    req.onsuccess = (e) => {
      const cursor = e.target.result;
      if(cursor){ store.delete(cursor.primaryKey); cursor.continue(); }
    };
    t.oncomplete = () => resolve(true);
    t.onerror = () => reject(t.error);
  });
}

/* ===================== Helpers ===================== */
const $ = (id) => document.getElementById(id);
const uid = () => Math.random().toString(36).slice(2,10) + "-" + Date.now().toString(36);

const toastEl = $("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=>toastEl.classList.remove("show"), 1500);
}
function safe(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function pad3(n){ return String(n).padStart(3, "0"); }
function issueCode(n){ return `SB-${pad3(n)}`; }
function photoLabel(n){ return `Photo ${n}`; }
function todayISO(){
  const d = new Date();
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${dd}`;
}
function isOverdue(issue){
  if(!issue?.dueDate) return false;
  if(issue.status === "closed") return false;
  const today = new Date(); today.setHours(0,0,0,0);
  const d = new Date(issue.dueDate + "T00:00:00");
  return d < today;
}
function isDueToday(issue){
  if(!issue?.dueDate) return false;
  if(issue.status === "closed") return false;
  return issue.dueDate === todayISO();
}
async function blobToImage(blob){
  return new Promise((resolve, reject) => {
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
    img.onerror = (e) => { URL.revokeObjectURL(url); reject(e); };
    img.src = url;
  });
}
function drawImageFit(img, maxSide){
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  const ratio = Math.min(maxSide / img.width, maxSide / img.height, 1);
  const w = Math.round(img.width * ratio);
  const h = Math.round(img.height * ratio);
  canvas.width = w; canvas.height = h;
  return { canvas, ctx, w, h };
}
async function normalizeImageToJpegBlob(fileOrBlob, maxSidePx=1700){
  const blob = fileOrBlob instanceof Blob ? fileOrBlob : new Blob([fileOrBlob]);
  const img = await blobToImage(blob);
  const { canvas, ctx, w, h } = drawImageFit(img, maxSidePx);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,w,h);
  ctx.drawImage(img, 0, 0, w, h);
  return await new Promise((resolve) => canvas.toBlob(b => resolve(b), "image/jpeg", 0.88));
}
async function fileToDataUrl(file, maxSide=1200){
  const blob = file instanceof Blob ? file : new Blob([file]);
  const img = await blobToImage(blob);
  const { canvas, ctx, w, h } = drawImageFit(img, maxSide);
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,w,h);
  ctx.drawImage(img, 0, 0, w, h);
  return canvas.toDataURL("image/png");
}

/* ===================== State ===================== */
const state = {
  projects: [],
  selectedProjectId: null,
  selectedIssueId: null,
  photoUrlCache: new Map(),
  companyLogoDataUrl: null,
  currentScreen: "dashboard",
  areaModalArea: null,
};
function getProject(){ return state.projects.find(p => p.id === state.selectedProjectId) || null; }
function getIssue(){
  const p = getProject();
  if(!p) return null;
  return (p.issues||[]).find(i => i.id === state.selectedIssueId) || null;
}
function getTemplate(){ return $("exportTemplate").value || "client"; }

/* ===================== Screen Navigation ===================== */
function setScreen(name){
  state.currentScreen = name;
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("active", t.dataset.screen === name));
  document.querySelectorAll(".screen").forEach(s => s.classList.toggle("active", s.id === `screen-${name}`));
  // refresh the screen content (lightweight)
  if(name === "dashboard") renderDashboard();
  if(name === "issues") { renderIssues(); renderIssueDetail(); }
  if(name === "areas") renderAreas();
  if(name === "today") renderToday();
}
document.querySelectorAll(".tab").forEach(t => t.onclick = () => setScreen(t.dataset.screen));
$("btnGoAreas").onclick = () => setScreen("areas");
$("btnTodayJumpIssues").onclick = () => setScreen("issues");

/* ===================== Branding ===================== */
function renderBrandPreview(){
  $("companyLogoPreview").src = state.companyLogoDataUrl || "logo.png";
}
$("companyLogoInput").addEventListener("change", async (e) => {
  const file = e.target.files?.[0];
  if(!file) return;
  if(!file.type.startsWith("image/")){ toast("Please upload an image"); return; }
  state.companyLogoDataUrl = await fileToDataUrl(file, 1400);
  await dbPut("branding", { key:"companyLogo", dataUrl: state.companyLogoDataUrl });
  renderBrandPreview();
  toast("Company logo saved");
  e.target.value = "";
});
$("btnClearCompanyLogo").onclick = async () => {
  state.companyLogoDataUrl = null;
  await dbDelete("branding", "companyLogo");
  renderBrandPreview();
  toast("Company logo cleared");
};

/* ===================== Charts (Canvas) ===================== */
function clearCanvas(c){
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle = "#fff";
  ctx.fillRect(0,0,c.width,c.height);
  return ctx;
}
function drawDonut(canvas, parts, title){
  const ctx = clearCanvas(canvas);
  const W = canvas.width, H = canvas.height;
  const cx = W/2, cy = H/2 + 10;
  const r = Math.min(W,H)*0.32;
  const total = parts.reduce((s,p)=>s+p.value,0) || 1;

  ctx.beginPath();
  ctx.arc(cx, cy, r, 0, Math.PI*2);
  ctx.strokeStyle = "rgba(16,24,40,.08)";
  ctx.lineWidth = r*0.45;
  ctx.stroke();

  const segColors = ["#b00020", "#101828", "#667085", "#0f766e"];
  let a = -Math.PI/2;
  parts.forEach((p, idx) => {
    const ang = (p.value/total) * Math.PI*2;
    ctx.beginPath();
    ctx.arc(cx, cy, r, a, a+ang);
    ctx.strokeStyle = segColors[idx % segColors.length];
    ctx.lineWidth = r*0.45;
    ctx.lineCap = "butt";
    ctx.stroke();
    a += ang;
  });

  ctx.fillStyle = "#101828";
  ctx.font = "900 26px ui-sans-serif, system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(String(parts.reduce((s,p)=>s+p.value,0)), cx, cy);

  ctx.font = "700 12px ui-sans-serif, system-ui";
  ctx.fillStyle = "#667085";
  ctx.fillText(title || "", cx, cy + 26);

  let lx = 18, ly = 22;
  ctx.textAlign = "left";
  ctx.textBaseline = "alphabetic";
  ctx.font = "800 12px ui-sans-serif, system-ui";
  parts.forEach((p, idx) => {
    ctx.fillStyle = segColors[idx % segColors.length];
    ctx.fillRect(lx, ly-10, 10, 10);
    ctx.fillStyle = "#101828";
    ctx.fillText(`${p.label}: ${p.value}`, lx+16, ly);
    ly += 18;
  });
}
function drawBars(canvas, bars){
  const ctx = clearCanvas(canvas);
  const W = canvas.width, H = canvas.height;
  const pad = 36;
  const max = Math.max(...bars.map(b=>b.value), 1);
  const bw = (W - pad*2) / bars.length * 0.66;
  const gap = (W - pad*2) / bars.length * 0.34;

  ctx.strokeStyle = "rgba(16,24,40,.10)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(pad, H-pad);
  ctx.lineTo(W-pad, H-pad);
  ctx.stroke();

  const colors = ["#667085", "#101828", "#b00020"];
  bars.forEach((b, i) => {
    const x = pad + i*(bw+gap) + gap*0.5;
    const h = (H - pad*2) * (b.value / max);
    const y = (H - pad) - h;

    ctx.fillStyle = colors[i % colors.length];
    ctx.fillRect(x, y, bw, h);

    ctx.fillStyle = "#101828";
    ctx.font = "900 14px ui-sans-serif, system-ui";
    ctx.textAlign = "center";
    ctx.fillText(String(b.value), x + bw/2, y - 8);

    ctx.fillStyle = "#667085";
    ctx.font = "800 12px ui-sans-serif, system-ui";
    ctx.fillText(b.label, x + bw/2, H - 14);
  });
}

/* ===================== Render Projects ===================== */
async function saveProject(proj){
  await dbPut("projects", proj);
  state.projects = await dbGetAllProjects();
}
function renderProjects(){
  const list = $("projectList");
  list.innerHTML = "";
  if(state.projects.length === 0){
    list.innerHTML = `<div class="tiny">No projects yet. Click “New Project”.</div>`;
  }
  for(const p of state.projects){
    const issuesCount = (p.issues||[]).length;
    const el = document.createElement("div");
    el.className = "item" + (p.id === state.selectedProjectId ? " active" : "");
    el.innerHTML = `
      <div class="title">${safe(p.title || "Untitled Project")}</div>
      <div class="meta">
        <span class="pill">${safe(p.reference || "No ref")}</span>
        <span class="pill">${safe(p.client || "No client")}</span>
        <span class="pill">${issuesCount} issue${issuesCount===1?"":"s"}</span>
      </div>`;
    el.onclick = async () => {
      state.selectedProjectId = p.id;
      state.selectedIssueId = null;
      renderAll();
      await loadSignatureIntoCanvas();
      toast("Project selected");
    };
    list.appendChild(el);
  }

  const proj = getProject();
  $("btnNewIssue").disabled = !proj;
  $("btnExport").disabled = !proj;
  $("btnShare").disabled  = !proj;
  $("btnSaveProject").disabled = !proj;
  $("btnDeleteProject").disabled = !proj;

  $("pTitle").value = proj?.title || "";
  $("pRef").value = proj?.reference || "";
  $("pClient").value = proj?.client || "";
  $("pNotes").value = proj?.notes || "";
}

/* ===================== Badges (tab counts) ===================== */
function updateTabBadges(){
  const p = getProject();
  const issues = p?.issues || [];
  const total = issues.length;
  const open = issues.filter(i=>i.status==="open").length;
  const due = issues.filter(i=>isDueToday(i) || isOverdue(i)).length;
  const areas = new Set(issues.map(i => ((i.location||"Unspecified area").trim()||"Unspecified area"))).size;

  $("bTotal").textContent = String(total);
  $("bOpen").textContent = String(open);
  $("bDue").textContent = String(due);
  $("bAreas").textContent = String(areas);

  $("bDue").classList.toggle("red", due>0);
}

/* ===================== Dashboard ===================== */
async function renderDashboard(){
  const p = getProject();
  updateTabBadges();

  $("dashTitleHint").textContent = p ? (p.title || "") : "Select a project";

  const grid = $("dashGrid");
  const note = $("dashNote");
  const dueList = $("dueList");
  const dueHint = $("dueHint");
  const areaGroups = $("areaGroups");
  const areaHint = $("areaHint");

  grid.innerHTML = "";
  dueList.innerHTML = "";
  areaGroups.innerHTML = "";

  if(!p){
    note.textContent = "Select a project to see dashboard stats.";
    dueHint.textContent = "Select a project to see due items.";
    areaHint.textContent = "Select a project to see area grouping.";
    drawDonut($("chartStatus"), [{label:"Open",value:0},{label:"Closed",value:0}], "Total");
    drawBars($("chartSeverity"), [{label:"Low",value:0},{label:"Med",value:0},{label:"High",value:0}]);
    return;
  }

  const issues = (p.issues||[]);
  const total = issues.length;
  const open = issues.filter(i=>i.status==="open").length;
  const closed = issues.filter(i=>i.status==="closed").length;
  const overdue = issues.filter(i=>isOverdue(i)).length;
  const dueToday = issues.filter(i=>isDueToday(i)).length;
  const high = issues.filter(i=>i.severity==="high").length;
  const med  = issues.filter(i=>i.severity==="medium").length;
  const low  = issues.filter(i=>i.severity==="low").length;

  let photosTotal = 0;
  for(const i of issues){
    const ph = await dbGetPhotosByIssueId(i.id);
    photosTotal += ph.length;
  }

  const tiles = [
    {k:"Total issues", v:String(total), s:"All issues in this project", cls:""},
    {k:"Open", v:String(open), s:"Action required", cls:"red"},
    {k:"Closed", v:String(closed), s:"Completed", cls:"green"},
    {k:"Overdue", v:String(overdue), s:"Open + past due date", cls: overdue>0 ? "red" : ""},
    {k:"Due today", v:String(dueToday), s:"Open issues due today", cls: dueToday>0 ? "red" : ""},
    {k:"Photos", v:String(photosTotal), s:"Attached to issues", cls:""},
  ];
  for(const t of tiles){
    const el = document.createElement("div");
    el.className = `dashTile ${t.cls||""}`;
    el.innerHTML = `<div class="k">${safe(t.k)}</div><div class="v">${safe(t.v)}</div><div class="s">${safe(t.s)}</div>`;
    grid.appendChild(el);
  }

  drawDonut($("chartStatus"), [{label:"Open",value:open},{label:"Closed",value:closed}], "Total");
  drawBars($("chartSeverity"), [{label:"Low",value:low},{label:"Med",value:med},{label:"High",value:high}]);

  note.textContent = "Use quick export buttons to generate section-specific PDFs instantly.";

  const dueItems = issues
    .filter(i => isDueToday(i) || isOverdue(i))
    .sort((a,b)=>{
      const da = a.dueDate || "9999-12-31";
      const db = b.dueDate || "9999-12-31";
      return da.localeCompare(db) || (a.code||"").localeCompare(b.code||"");
    });

  if(dueItems.length === 0){
    dueHint.textContent = "No due today or overdue open issues.";
  }else{
    dueHint.textContent = `${dueItems.length} issue(s) due today or overdue.`;
    for(const i of dueItems.slice(0, 40)){
      const el = document.createElement("div");
      el.className = "dueItem";
      const tag = isOverdue(i) ? "Overdue" : "Due today";
      el.innerHTML = `
        <div class="line1">${safe(i.code)} • ${safe(i.title||"Untitled")} <span class="pill ${isOverdue(i)?"overdue":""}" style="margin-left:8px;">${tag}</span></div>
        <div class="line2">${safe(i.location||"Unspecified area")} • Assignee: ${safe(i.assignee||"-")} • Due: ${safe(i.dueDate||"-")}</div>
      `;
      el.onclick = () => { state.selectedIssueId = i.id; setScreen("issues"); renderIssues(); renderIssueDetail(); };
      dueList.appendChild(el);
    }
  }

  // Grouped by area
  const byLoc = new Map();
  for(const i of issues){
    const loc = (i.location || "Unspecified area").trim() || "Unspecified area";
    if(!byLoc.has(loc)) byLoc.set(loc, []);
    byLoc.get(loc).push(i);
  }
  const locs = Array.from(byLoc.keys()).sort((a,b)=>a.localeCompare(b));

  if(locs.length === 0){
    areaHint.textContent = "No issues yet.";
  }else{
    areaHint.textContent = `${locs.length} area(s). Tap “Open Areas” for the Area screen.`;
    for(const loc of locs.slice(0, 8)){
      const arr = byLoc.get(loc);
      const openN = arr.filter(i=>i.status==="open").length;
      const closedN = arr.filter(i=>i.status==="closed").length;
      const overdueN = arr.filter(i=>isOverdue(i)).length;

      const row = document.createElement("div");
      row.className = "groupRow";
      row.innerHTML = `
        <div>
          <div class="name">${safe(loc)}</div>
          <div class="stats">
            <span class="pill">${arr.length} total</span>
            <span class="pill open">${openN} open</span>
            <span class="pill closed">${closedN} closed</span>
            ${overdueN>0 ? `<span class="pill overdue">${overdueN} overdue</span>` : ``}
          </div>
        </div>
        <div class="btns">
          <button class="ghost" data-exp-area="${safe(loc)}" type="button">Export</button>
          <button class="ghost" data-open-area="${safe(loc)}" type="button">Open</button>
        </div>
      `;
      areaGroups.appendChild(row);
    }

    areaGroups.querySelectorAll("[data-open-area]").forEach(b=>{
      b.onclick = (e)=>{
        e.stopPropagation();
        const loc = b.getAttribute("data-open-area");
        openAreaModal(loc);
      };
    });
    areaGroups.querySelectorAll("[data-exp-area]").forEach(b=>{
      b.onclick = async (e)=>{
        e.stopPropagation();
        const loc = b.getAttribute("data-exp-area");
        await exportPdf({ mode:"area", area:loc, template:getTemplate() });
      };
    });
  }
}

/* ===================== Issues ===================== */
function renderIssues(){
  const proj = getProject();
  updateTabBadges();
  const list = $("issueList");
  list.innerHTML = "";
  if(!proj){
    list.innerHTML = `<div class="tiny">Select or create a project.</div>`;
    return;
  }

  const filter = $("issueFilter").value;
  const q = $("issueSearch").value.trim().toLowerCase();

  let issues = (proj.issues||[]).slice();
  if(filter !== "all") issues = issues.filter(i => i.status === filter);
  if(q){
    issues = issues.filter(i =>
      (i.title||"").toLowerCase().includes(q) ||
      (i.location||"").toLowerCase().includes(q) ||
      (i.notes||"").toLowerCase().includes(q) ||
      (i.assignee||"").toLowerCase().includes(q) ||
      (i.code||"").toLowerCase().includes(q)
    );
  }

  if(issues.length === 0){
    list.innerHTML = `<div class="tiny">No issues match. Click “New Issue”.</div>`;
    return;
  }

  for(const i of issues){
    const el = document.createElement("div");
    el.className = "item" + (i.id === state.selectedIssueId ? " active" : "");
    const statusClass = i.status === "closed" ? "pill closed" : "pill open";
    const overdue = isOverdue(i);
    const dueToday = isDueToday(i);
    const due = i.dueDate ? new Date(i.dueDate).toLocaleDateString() : "";
    const ass = (i.assignee || "").trim();

    el.innerHTML = `
      <div class="title">${safe(i.code || "")} • ${safe(i.title || "Untitled Issue")}</div>
      <div class="meta">
        <span class="${statusClass}">${safe(i.status||"open")}</span>
        ${i.severity === "high" ? `<span class="pill high">high</span>` : `<span class="pill">${safe(i.severity||"medium")}</span>`}
        <span class="pill">${safe(i.location||"No location")}</span>
        ${ass ? `<span class="pill">Assignee: ${safe(ass)}</span>` : ``}
        ${due ? `<span class="pill ${overdue ? "overdue":""}">Due: ${safe(due)}${overdue?" (Overdue)":(dueToday?" (Today)":"")}</span>` : ``}
      </div>`;
    el.onclick = async () => {
      state.selectedIssueId = i.id;
      renderIssues();
      await renderIssueDetail();
    };
    list.appendChild(el);
  }
}

async function renderIssueDetail(){
  const proj = getProject();
  const issue = getIssue();

  if(!proj){
    $("issueForm").style.display = "none";
    $("issueHint").textContent = "Select a project, then create an issue.";
    return;
  }
  if(!issue){
    $("issueForm").style.display = "none";
    $("issueHint").textContent = "Create an issue, or tap one to edit.";
    return;
  }

  $("issueHint").textContent = "";
  $("issueForm").style.display = "block";

  $("iCode").value = issue.code || "";
  $("iTitle").value = issue.title || "";
  $("iStatus").value = issue.status || "open";
  $("iSeverity").value = issue.severity || "medium";
  $("iAssignee").value = issue.assignee || "";
  $("iDueDate").value = issue.dueDate || "";
  $("iLocation").value = issue.location || "";
  $("iNotes").value = issue.notes || "";

  await renderPhotos(issue.id);
  await renderDashboard();
  await renderAreas(false);
  await renderToday(false);
}

async function renderPhotos(issueId){
  const grid = $("photoGrid");
  grid.innerHTML = "";
  const photos = await dbGetPhotosByIssueId(issueId);
  photos.sort((a,b)=> (a.photoNo||9999) - (b.photoNo||9999) || (a.createdAt||"").localeCompare(b.createdAt||""));

  if(photos.length === 0){
    grid.innerHTML = `<div class="tiny">No photos yet. Use Camera, Quick Capture, or Upload.</div>`;
    return;
  }

  for(const ph of photos){
    let url = state.photoUrlCache.get(ph.id);
    if(!url){
      url = URL.createObjectURL(ph.blob);
      state.photoUrlCache.set(ph.id, url);
    }
    const el = document.createElement("div");
    el.className = "photoCard";
    const label = photoLabel(ph.photoNo || 1);
    el.innerHTML = `
      <div class="photoSquare"><img src="${url}" alt="Issue photo"/></div>
      <div class="photoCap">
        <span>${safe(label)}</span>
        <div style="display:flex; gap:8px;">
          <button class="ghost" data-anno="${ph.id}" type="button">Annotate</button>
          <button class="danger" data-del="${ph.id}" type="button">Remove</button>
        </div>
      </div>`;
    grid.appendChild(el);
  }

  grid.querySelectorAll("[data-del]").forEach(btn => {
    btn.onclick = async (e) => {
      e.stopPropagation();
      const id = btn.getAttribute("data-del");
      if(!confirm("Remove this photo?")) return;
      const url = state.photoUrlCache.get(id);
      if(url) URL.revokeObjectURL(url);
      state.photoUrlCache.delete(id);
      await dbDelete("photos", id);
      await renderPhotos(issueId);
      await renderDashboard();
      await renderAreas(false);
      await renderToday(false);
      toast("Photo removed");
    };
  });
  grid.querySelectorAll("[data-anno]").forEach(btn => {
    btn.onclick = async (e) => {
      e.stopPropagation();
      await openAnnotationEditor(btn.getAttribute("data-anno"));
    };
  });
}

/* ===================== Areas Screen + Area View ===================== */
function buildAreasMap(issues){
  const by = new Map();
  for(const i of issues){
    const loc = (i.location || "Unspecified area").trim() || "Unspecified area";
    if(!by.has(loc)) by.set(loc, []);
    by.get(loc).push(i);
  }
  return by;
}

async function renderAreas(updateBadges=true){
  const p = getProject();
  if(updateBadges) updateTabBadges();

  const cards = $("areaCards");
  const hint = $("areasHint");
  cards.innerHTML = "";

  if(!p){
    hint.textContent = "Select a project to see areas.";
    return;
  }

  const q = ($("areaSearch").value || "").trim().toLowerCase();
  const issues = p.issues || [];
  const by = buildAreasMap(issues);
  let locs = Array.from(by.keys()).sort((a,b)=>a.localeCompare(b));
  if(q) locs = locs.filter(a => a.toLowerCase().includes(q));

  hint.textContent = `${locs.length} area(s) found.`;

  if(locs.length === 0){
    cards.innerHTML = `<div class="tiny">No areas. Add a location to issues.</div>`;
    return;
  }

  for(const loc of locs){
    const arr = by.get(loc);
    const openN = arr.filter(i=>i.status==="open").length;
    const closedN = arr.filter(i=>i.status==="closed").length;
    const overdueN = arr.filter(i=>isOverdue(i)).length;

    const el = document.createElement("div");
    el.className = "areaCard";
    el.innerHTML = `
      <div class="h">
        <div class="name">${safe(loc)}</div>
        <span class="pill">${arr.length}</span>
      </div>
      <div class="nums">
        <span class="pill open">${openN} open</span>
        <span class="pill closed">${closedN} closed</span>
        ${overdueN>0 ? `<span class="pill overdue">${overdueN} overdue</span>` : ``}
      </div>
      <div class="tiny" style="margin-top:10px;">Tap to open Area View • Export available inside</div>
    `;
    el.onclick = () => openAreaModal(loc);
    cards.appendChild(el);
  }
}

$("areaSearch").addEventListener("input", () => {
  clearTimeout(window.__areas);
  window.__areas = setTimeout(() => renderAreas(), 120);
});

$("btnAreasExportAll").onclick = async () => {
  if(!getProject()){ toast("Select a project first"); return; }
  await exportPdf({ mode:"all", template:getTemplate() });
};

function openAreaModal(area){
  state.areaModalArea = area;
  $("areaModalTitle").textContent = `Area View — ${area}`;
  $("areaBackdrop").classList.add("show");
  renderAreaModalList();
}
$("btnAreaClose").onclick = () => $("areaBackdrop").classList.remove("show");
$("btnAreaExport").onclick = async () => {
  const area = state.areaModalArea;
  if(!area) return;
  await exportPdf({ mode:"area", area, template:getTemplate() });
};
$("btnAreaOpenIssues").onclick = () => {
  const area = state.areaModalArea;
  $("areaBackdrop").classList.remove("show");
  setScreen("issues");
  $("issueFilter").value = "all";
  $("issueSearch").value = area || "";
  renderIssues();
  toast("Filtered to area");
};

function renderAreaModalList(){
  const p = getProject();
  const area = state.areaModalArea;
  const list = $("areaIssueList");
  const stats = $("areaStats");
  list.innerHTML = "";
  if(!p || !area) return;

  const issues = (p.issues||[]).filter(i => ((i.location||"Unspecified area").trim()||"Unspecified area") === area);
  const openN = issues.filter(i=>i.status==="open").length;
  const closedN = issues.filter(i=>i.status==="closed").length;
  const overdueN = issues.filter(i=>isOverdue(i)).length;

  stats.textContent = `${issues.length} total • ${openN} open • ${closedN} closed${overdueN?` • ${overdueN} overdue`:``}`;

  if(issues.length === 0){
    list.innerHTML = `<div class="tiny">No issues in this area.</div>`;
    return;
  }
  issues.sort((a,b)=> (a.code||"").localeCompare(b.code||""));

  for(const i of issues){
    const el = document.createElement("div");
    el.className = "item";
    const statusClass = i.status === "closed" ? "pill closed" : "pill open";
    el.innerHTML = `
      <div class="title">${safe(i.code)} • ${safe(i.title||"Untitled")}</div>
      <div class="meta">
        <span class="${statusClass}">${safe(i.status||"open")}</span>
        ${i.severity === "high" ? `<span class="pill high">high</span>` : `<span class="pill">${safe(i.severity||"medium")}</span>`}
        ${i.dueDate ? `<span class="pill ${isOverdue(i)?"overdue":""}">Due: ${safe(new Date(i.dueDate).toLocaleDateString())}</span>` : ``}
        ${i.assignee ? `<span class="pill">Assignee: ${safe(i.assignee)}</span>` : ``}
      </div>
    `;
    el.onclick = () => {
      $("areaBackdrop").classList.remove("show");
      state.selectedIssueId = i.id;
      setScreen("issues");
      renderIssues();
      renderIssueDetail();
    };
    list.appendChild(el);
  }
}

/* ===================== Today Screen ===================== */
async function renderToday(updateBadges=true){
  const p = getProject();
  if(updateBadges) updateTabBadges();

  const list = $("todayList");
  const hint = $("todayHint");
  list.innerHTML = "";

  if(!p){
    hint.textContent = "Select a project to see today’s due items.";
    return;
  }

  const assQ = ($("todayAssignee").value || "").trim().toLowerCase();
  let items = (p.issues||[]).filter(i => isDueToday(i) || isOverdue(i));
  if(assQ){
    items = items.filter(i => (i.assignee||"").toLowerCase().includes(assQ));
  }
  items.sort((a,b)=>{
    const da = a.dueDate || "9999-12-31";
    const db = b.dueDate || "9999-12-31";
    return da.localeCompare(db) || (a.code||"").localeCompare(b.code||"");
  });

  if(items.length === 0){
    hint.textContent = assQ ? "No due items for this assignee." : "No due today or overdue open issues.";
    return;
  }

  hint.textContent = `${items.length} due item(s). Tap one to open the issue.`;
  for(const i of items.slice(0, 80)){
    const el = document.createElement("div");
    el.className = "dueItem";
    const tag = isOverdue(i) ? "Overdue" : "Due today";
    el.innerHTML = `
      <div class="line1">${safe(i.code)} • ${safe(i.title||"Untitled")} <span class="pill ${isOverdue(i)?"overdue":""}" style="margin-left:8px;">${tag}</span></div>
      <div class="line2">${safe(i.location||"Unspecified area")} • Assignee: ${safe(i.assignee||"-")} • Due: ${safe(i.dueDate||"-")}</div>
    `;
    el.onclick = () => {
      state.selectedIssueId = i.id;
      setScreen("issues");
      renderIssues();
      renderIssueDetail();
    };
    list.appendChild(el);
  }
}

$("todayAssignee").addEventListener("input", () => {
  clearTimeout(window.__today);
  window.__today = setTimeout(() => renderToday(), 120);
});
$("btnTodayExportDue").onclick = async () => {
  if(!getProject()){ toast("Select a project first"); return; }
  await exportPdf({ mode:"due", template:getTemplate() });
};

/* ===================== CRUD Projects / Issues ===================== */
$("btnNewProject").onclick = async () => {
  const p = {
    id: uid(),
    title: "New Project",
    reference: "",
    client: "",
    notes: "",
    issueCounter: 0,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    issues: []
  };
  await saveProject(p);
  state.selectedProjectId = p.id;
  state.selectedIssueId = null;
  renderAll();
  await loadSignatureIntoCanvas();
  toast("Project created");
};

$("btnSaveProject").onclick = async () => {
  const p = getProject();
  if(!p) return;
  p.title = $("pTitle").value.trim() || "Untitled Project";
  p.reference = $("pRef").value.trim();
  p.client = $("pClient").value.trim();
  p.notes = $("pNotes").value.trim();
  p.updatedAt = new Date().toISOString();
  await saveProject(p);
  renderProjects();
  renderDashboard();
  toast("Project saved");
};

$("btnDeleteProject").onclick = async () => {
  const p = getProject();
  if(!p) return;
  if(!confirm(`Delete project "${p.title}" and all its issues/photos/signature?`)) return;

  for(const issue of (p.issues||[])) await dbDeletePhotosByIssueId(issue.id);
  await dbDelete("signatures", p.id);
  await dbDelete("projects", p.id);

  for(const [, url] of state.photoUrlCache.entries()) URL.revokeObjectURL(url);
  state.photoUrlCache.clear();

  state.projects = await dbGetAllProjects();
  state.selectedProjectId = state.projects[0]?.id || null;
  state.selectedIssueId = null;
  renderAll();
  await loadSignatureIntoCanvas();
  toast("Project deleted");
};

$("btnNewIssue").onclick = async () => {
  const p = getProject();
  if(!p) return;

  p.issueCounter = Number(p.issueCounter || 0) + 1;
  const code = issueCode(p.issueCounter);

  const issue = {
    id: uid(),
    code,
    title: "New Issue",
    status: "open",
    severity: "medium",
    assignee: "",
    dueDate: "",
    location: "",
    notes: "",
    photoCounter: 0,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  };

  p.issues = [issue, ...(p.issues||[])];
  p.updatedAt = new Date().toISOString();
  await saveProject(p);

  state.selectedIssueId = issue.id;
  setScreen("issues");
  renderIssues();
  await renderIssueDetail();
  toast(`Issue created (${code})`);
};

$("btnSaveIssue").onclick = async () => {
  const p = getProject();
  const i = getIssue();
  if(!p || !i) return;

  i.title = $("iTitle").value.trim() || "Untitled Issue";
  i.status = $("iStatus").value;
  i.severity = $("iSeverity").value;
  i.assignee = $("iAssignee").value.trim();
  i.dueDate = $("iDueDate").value;
  i.location = $("iLocation").value.trim();
  i.notes = $("iNotes").value.trim();
  i.updatedAt = new Date().toISOString();

  p.updatedAt = new Date().toISOString();
  await saveProject(p);
  renderIssues();
  renderDashboard();
  renderAreas();
  renderToday();
  toast("Issue saved");
};

$("btnDeleteIssue").onclick = async () => {
  const p = getProject();
  const i = getIssue();
  if(!p || !i) return;
  if(!confirm(`Delete issue "${i.code} • ${i.title}" and its photos?`)) return;

  await dbDeletePhotosByIssueId(i.id);
  p.issues = (p.issues||[]).filter(x => x.id !== i.id);
  p.updatedAt = new Date().toISOString();
  await saveProject(p);

  state.selectedIssueId = null;
  renderIssues();
  await renderIssueDetail();
  renderDashboard();
  renderAreas();
  renderToday();
  toast("Issue deleted");
};

async function nextPhotoNumber(issueId){
  const p = getProject();
  if(!p) return 1;
  const issue = (p.issues||[]).find(x=>x.id===issueId);
  if(!issue) return 1;
  issue.photoCounter = Number(issue.photoCounter || 0) + 1;
  issue.updatedAt = new Date().toISOString();
  p.updatedAt = new Date().toISOString();
  await saveProject(p);
  return issue.photoCounter;
}

$("iPhotoInput").addEventListener("change", async (e) => {
  const issue = getIssue();
  if(!issue) return;
  const files = Array.from(e.target.files || []);
  if(files.length === 0) return;

  for(const file of files){
    if(!file.type.startsWith("image/")) continue;
    const blob = await normalizeImageToJpegBlob(file, 1700);
    const n = await nextPhotoNumber(issue.id);
    const rec = {
      id: uid(),
      issueId: issue.id,
      photoNo: n,
      createdAt: new Date().toISOString(),
      blob,
      annotations: [],
      annoW: null,
      annoH: null
    };
    await dbPut("photos", rec);
  }
  e.target.value = "";
  await renderPhotos(issue.id);
  await renderDashboard();
  await renderAreas();
  await renderToday();
  toast(files.length === 1 ? "Photo added" : `${files.length} photos added`);
});
$("btnQuickCapture").onclick = () => $("iPhotoInput").click();

/* ===================== Camera (HTTPS required) ===================== */
let camStream = null;
let camFacingMode = "environment";

$("btnCamera").onclick = async () => {
  if(!getIssue()) return;
  await openCamera();
};
$("btnCamClose").onclick = async () => closeCamera();
$("btnCamSwitch").onclick = async () => {
  camFacingMode = camFacingMode === "environment" ? "user" : "environment";
  await openCamera(true);
};

async function openCamera(){
  $("camBackdrop").classList.add("show");
  const video = $("camVideo");

  if(!navigator.mediaDevices?.getUserMedia){
    toast("Camera not supported. Use Quick Capture/Upload.");
    $("camBackdrop").classList.remove("show");
    return;
  }
  if(!window.isSecureContext){
    toast("Live camera needs HTTPS. Use Quick Capture.");
    $("camBackdrop").classList.remove("show");
    return;
  }

  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }

  const attempts = [
    { video: { facingMode: { exact: camFacingMode } }, audio:false },
    { video: { facingMode: { ideal: camFacingMode } }, audio:false },
    { video: { facingMode: { ideal: "environment" } }, audio:false },
    { video: true, audio:false },
  ];
  let lastErr = null;
  for(const c of attempts){
    try{ camStream = await navigator.mediaDevices.getUserMedia(c); break; }
    catch(err){ lastErr = err; camStream = null; }
  }
  if(!camStream){
    console.error(lastErr);
    toast("Camera blocked. Use Quick Capture/Upload.");
    $("camBackdrop").classList.remove("show");
    return;
  }

  try{
    video.srcObject = camStream;
    video.setAttribute("playsinline","true");
    video.muted = true;
    await video.play();
    toast("Camera ready");
  }catch(err){
    console.error(err);
    toast("Preview failed. Use Quick Capture.");
    $("camBackdrop").classList.remove("show");
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
}
function closeCamera(){
  $("camBackdrop").classList.remove("show");
  const video = $("camVideo");
  try{ video.pause(); }catch(_){}
  video.srcObject = null;
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
}

$("btnSnap").onclick = async () => {
  const issue = getIssue();
  if(!issue) return;
  const video = $("camVideo");
  if(!camStream || !video.videoWidth){
    toast("Camera not ready. Use Quick Capture.");
    return;
  }
  const canvas = $("camCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const blob = await new Promise(r => canvas.toBlob(b=>r(b),"image/jpeg",0.9));
  const norm = await normalizeImageToJpegBlob(blob, 1700);

  const n = await nextPhotoNumber(issue.id);
  const rec = {
    id: uid(),
    issueId: issue.id,
    photoNo: n,
    createdAt: new Date().toISOString(),
    blob: norm,
    annotations: [],
    annoW: null,
    annoH: null
  };
  await dbPut("photos", rec);
  await renderPhotos(issue.id);
  await renderDashboard();
  await renderAreas();
  await renderToday();
  toast("Photo captured");
};

/* ===================== Annotation (pins+labels) ===================== */
const annoCanvas = $("annoCanvas");
const annoCtx = annoCanvas.getContext("2d");
const anno = {
  photoId:null,
  baseImg:null,
  tool:"rect",
  dragging:false,
  startX:0, startY:0,
  temp:null,
  shapes:[],
  history:[],
  pinCounter:0,
};
function setTool(tool){
  anno.tool = tool;
  document.querySelectorAll("[data-tool]").forEach(b => b.classList.toggle("active", b.getAttribute("data-tool") === tool));
  $("pinHint").textContent = tool === "pin" ? "Tap to place a numbered pin. You’ll be asked for a label (legend text)." : "";
}
document.querySelectorAll("[data-tool]").forEach(btn => btn.onclick = () => setTool(btn.getAttribute("data-tool")));

$("btnAnnoClose").onclick = () => closeAnno();
$("btnAnnoUndo").onclick = () => {
  if(anno.history.length){
    anno.shapes = anno.history.pop();
    anno.pinCounter = Math.max(0, ...anno.shapes.filter(s=>s.type==="pin").map(s=>s.num||0), 0);
    drawAnno();
  }
};
$("btnAnnoClear").onclick = () => {
  if(!confirm("Clear all annotations?")) return;
  pushHistory();
  anno.shapes = [];
  anno.pinCounter = 0;
  drawAnno();
};
$("btnAnnoSave").onclick = async () => {
  if(!anno.photoId) return;
  const rec = await dbGet("photos", anno.photoId);
  if(!rec) return;
  rec.annotations = anno.shapes;
  rec.annoW = annoCanvas.width;
  rec.annoH = annoCanvas.height;
  await dbPut("photos", rec);
  toast("Annotations saved");
  closeAnno();
  const issue = getIssue();
  if(issue) await renderPhotos(issue.id);
};

function pushHistory(){
  anno.history.push(JSON.parse(JSON.stringify(anno.shapes)));
  if(anno.history.length > 30) anno.history.shift();
}
function clientToCanvas(e){
  const rect = annoCanvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) * (annoCanvas.width / rect.width);
  const y = (e.clientY - rect.top) * (annoCanvas.height / rect.height);
  return { x, y };
}

annoCanvas.addEventListener("pointerdown", async (e) => {
  if(!anno.baseImg) return;
  const { x, y } = clientToCanvas(e);

  if(anno.tool === "pin"){
    const label = prompt("Pin label (for legend):", "Note");
    if(label && label.trim()){
      pushHistory();
      anno.pinCounter += 1;
      anno.shapes.push({ type:"pin", x, y, num: anno.pinCounter, label: label.trim() });
      drawAnno();
    }
    return;
  }

  if(anno.tool === "text"){
    const text = prompt("Text:", "Note");
    if(text && text.trim()){
      pushHistory();
      anno.shapes.push({ type:"text", x, y, text: text.trim() });
      drawAnno();
    }
    return;
  }

  anno.dragging = true;
  anno.startX = x; anno.startY = y;

  if(anno.tool === "rect"){
    anno.temp = { type:"rect", x1:x, y1:y, x2:x, y2:y };
  }else if(anno.tool === "arrow"){
    anno.temp = { type:"arrow", x1:x, y1:y, x2:x, y2:y };
  }else{
    anno.temp = null;
  }
});

annoCanvas.addEventListener("pointermove", (e) => {
  if(!anno.dragging || !anno.temp) return;
  const { x, y } = clientToCanvas(e);
  anno.temp.x2 = x; anno.temp.y2 = y;
  drawAnno();
  drawShape(anno.temp, true);
});

annoCanvas.addEventListener("pointerup", () => {
  if(!anno.dragging) return;
  anno.dragging = false;
  if(!anno.temp) return;
  pushHistory();
  if(anno.temp.type === "rect"){
    const { x1,y1,x2,y2 } = anno.temp;
    anno.shapes.push({ type:"rect", x: Math.min(x1,x2), y: Math.min(y1,y2), w: Math.abs(x2-x1), h: Math.abs(y2-y1) });
  }else{
    anno.shapes.push(anno.temp);
  }
  anno.temp = null;
  drawAnno();
});

function drawPin(ctx, x, y, num){
  ctx.save();
  ctx.fillStyle = "#b00020";
  ctx.strokeStyle = "#ffffff";
  ctx.lineWidth = 5;
  const r = 22;
  ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = "#ffffff";
  ctx.font = "950 22px ui-sans-serif, system-ui";
  ctx.textAlign = "center"; ctx.textBaseline = "middle";
  ctx.fillText(String(num), x, y+1);
  ctx.restore();
}

function drawShape(s, preview){
  const ctx = annoCtx;
  ctx.save();
  ctx.lineWidth = preview ? 5 : 6;
  ctx.strokeStyle = "#b00020";
  ctx.fillStyle = "#b00020";
  ctx.globalAlpha = preview ? 0.85 : 1;
  ctx.font = "950 28px ui-sans-serif, system-ui";

  if(s.type === "rect"){
    const x = s.x ?? Math.min(s.x1, s.x2);
    const y = s.y ?? Math.min(s.y1, s.y2);
    const w = s.w ?? Math.abs(s.x2 - s.x1);
    const h = s.h ?? Math.abs(s.y2 - s.y1);
    ctx.strokeRect(x,y,w,h);
  }else if(s.type === "arrow"){
    const x1=s.x1,y1=s.y1,x2=s.x2,y2=s.y2;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    const angle = Math.atan2(y2-y1, x2-x1);
    const headLen = 28;
    const a1 = angle - Math.PI/7, a2 = angle + Math.PI/7;
    ctx.beginPath();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2 - headLen*Math.cos(a1), y2 - headLen*Math.sin(a1));
    ctx.lineTo(x2 - headLen*Math.cos(a2), y2 - headLen*Math.sin(a2));
    ctx.closePath();
    ctx.fill();
  }else if(s.type === "text"){
    ctx.fillText(s.text || "", s.x, s.y);
  }else if(s.type === "pin"){
    drawPin(ctx, s.x, s.y, s.num || 0);
  }
  ctx.restore();
}

function drawAnno(){
  annoCtx.clearRect(0,0,annoCanvas.width, annoCanvas.height);
  annoCtx.drawImage(anno.baseImg, 0, 0, annoCanvas.width, annoCanvas.height);
  for(const s of anno.shapes) drawShape(s, false);
}

async function openAnnotationEditor(photoId){
  const rec = await dbGet("photos", photoId);
  if(!rec) return;
  const img = await blobToImage(rec.blob);

  const maxW = 1200;
  const ratio = Math.min(maxW / img.width, 1);
  annoCanvas.width = Math.round(img.width * ratio);
  annoCanvas.height = Math.round(img.height * ratio);

  anno.photoId = photoId;
  anno.baseImg = img;
  anno.shapes = rec.annotations || [];
  anno.history = [];
  anno.pinCounter = Math.max(0, ...anno.shapes.filter(s=>s.type==="pin").map(s=>s.num||0), 0);
  setTool("rect");

  $("annoBackdrop").classList.add("show");
  drawAnno();
}
function closeAnno(){
  $("annoBackdrop").classList.remove("show");
  anno.photoId = null;
  anno.baseImg = null;
  anno.shapes = [];
  anno.history = [];
  anno.pinCounter = 0;
}

/* ===================== Signature (smooth) ===================== */
const sigCanvas = $("sigCanvas");
const sigCtx = sigCanvas.getContext("2d");
sigCanvas.style.touchAction = "none";
const sig = { drawing:false };

function clearSig(){
  sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
  sigCtx.strokeStyle = "rgba(16,24,40,.18)";
  sigCtx.lineWidth = 2;
  sigCtx.beginPath();
  sigCtx.moveTo(40, sigCanvas.height-60);
  sigCtx.lineTo(sigCanvas.width-40, sigCanvas.height-60);
  sigCtx.stroke();
}
function sigPos(e){
  const r = sigCanvas.getBoundingClientRect();
  return {
    x: (e.clientX - r.left) * (sigCanvas.width / r.width),
    y: (e.clientY - r.top) * (sigCanvas.height / r.height)
  };
}
function sigDown(e){
  e.preventDefault();
  sig.drawing = true;
  sigCanvas.setPointerCapture(e.pointerId);
  const {x,y} = sigPos(e);
  sigCtx.strokeStyle = "#101828";
  sigCtx.lineWidth = 3.8;
  sigCtx.lineCap = "round";
  sigCtx.lineJoin = "round";
  sigCtx.beginPath();
  sigCtx.moveTo(x,y);
}
function sigMove(e){
  if(!sig.drawing) return;
  e.preventDefault();
  const {x,y} = sigPos(e);
  sigCtx.lineTo(x,y);
  sigCtx.stroke();
}
function sigUp(e){
  if(!sig.drawing) return;
  e.preventDefault();
  sig.drawing = false;
  try{ sigCanvas.releasePointerCapture(e.pointerId); }catch(_){}
}
sigCanvas.addEventListener("pointerdown", sigDown);
sigCanvas.addEventListener("pointermove", sigMove);
sigCanvas.addEventListener("pointerup", sigUp);
sigCanvas.addEventListener("pointercancel", sigUp);
sigCanvas.addEventListener("pointerleave", sigUp);

$("btnSigClear").onclick = () => { clearSig(); toast("Signature cleared"); };
$("btnSigSave").onclick = async () => {
  const p = getProject();
  if(!p) return;
  await dbPut("signatures", { projectId: p.id, dataUrl: sigCanvas.toDataURL("image/png") });
  toast("Signature saved");
};
async function loadSignatureIntoCanvas(){
  clearSig();
  const p = getProject();
  if(!p) return;
  const rec = await dbGet("signatures", p.id);
  if(!rec?.dataUrl) return;

  const img = new Image();
  img.onload = () => {
    const maxW = sigCanvas.width - 80, maxH = sigCanvas.height - 80;
    const r = Math.min(maxW / img.width, maxH / img.height, 1);
    const w = img.width * r, h = img.height * r;
    sigCtx.drawImage(img, (sigCanvas.width-w)/2, (sigCanvas.height-h)/2, w, h);
  };
  img.src = rec.dataUrl;
}

/* ===================== PDF Export (templates) ===================== */
function safeFile(s){ return String(s||"Report").replace(/[^a-z0-9-_]+/gi,"_").slice(0,60); }
function extractPins(photoRec){
  const pins = (photoRec.annotations||[]).filter(a=>a.type==="pin").map(p=>({ num:p.num||0, label:p.label||"" }));
  pins.sort((a,b)=>a.num-b.num);
  return pins;
}
async function fetchAsDataUrl(path){
  const res = await fetch(path);
  const blob = await res.blob();
  return await new Promise((resolve) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.readAsDataURL(blob);
  });
}

async function renderAnnotatedSquareToDataUrl(photoRec){
  const img = await blobToImage(photoRec.blob);

  const { canvas, ctx, w, h } = drawImageFit(img, 1800);
  ctx.fillStyle = "#ffffff"; ctx.fillRect(0,0,w,h);
  ctx.drawImage(img, 0,0,w,h);

  const shapes = photoRec.annotations || [];
  const annoW = photoRec.annoW || w;
  const annoH = photoRec.annoH || h;
  const sx = w/annoW, sy = h/annoH;

  ctx.save();
  ctx.strokeStyle = "#b00020";
  ctx.fillStyle = "#b00020";
  ctx.lineWidth = 6;
  ctx.font = "950 36px ui-sans-serif, system-ui";

  function drawPdfPin(x,y,num){
    const r = 28;
    ctx.fillStyle = "#b00020";
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();
    ctx.lineWidth = 6;
    ctx.strokeStyle = "#ffffff";
    ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.stroke();
    ctx.fillStyle = "#ffffff";
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText(String(num), x, y+1);
    ctx.textAlign="left"; ctx.textBaseline="alphabetic";
    ctx.fillStyle = "#b00020";
    ctx.strokeStyle = "#b00020";
  }

  for(const s of shapes){
    if(s.type==="rect"){
      ctx.strokeRect((s.x||0)*sx, (s.y||0)*sy, (s.w||0)*sx, (s.h||0)*sy);
    }else if(s.type==="arrow"){
      const x1=(s.x1||0)*sx,y1=(s.y1||0)*sy,x2=(s.x2||0)*sx,y2=(s.y2||0)*sy;
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      const angle = Math.atan2(y2-y1, x2-x1);
      const headLen=40; const a1=angle-Math.PI/7, a2=angle+Math.PI/7;
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2 - headLen*Math.cos(a1), y2 - headLen*Math.sin(a1));
      ctx.lineTo(x2 - headLen*Math.cos(a2), y2 - headLen*Math.sin(a2));
      ctx.closePath(); ctx.fill();
    }else if(s.type==="text"){
      ctx.fillText(s.text||"", (s.x||0)*sx, (s.y||0)*sy);
    }else if(s.type==="pin"){
      drawPdfPin((s.x||0)*sx, (s.y||0)*sy, s.num||0);
    }
  }
  ctx.restore();

  const side = Math.min(w, h);
  const sx0 = Math.floor((w - side)/2);
  const sy0 = Math.floor((h - side)/2);

  const sq = document.createElement("canvas");
  sq.width = side; sq.height = side;
  const sqCtx = sq.getContext("2d");
  sqCtx.fillStyle = "#fff";
  sqCtx.fillRect(0,0,side,side);
  sqCtx.drawImage(canvas, sx0, sy0, side, side, 0,0,side,side);

  return sq.toDataURL("image/jpeg", 0.9);
}

async function addPdfHeader(doc, template){
  const pageW = doc.internal.pageSize.getWidth();
  const leftX = 46, topY = 24;

  const companyLogo = state.companyLogoDataUrl;
  if(companyLogo){
    try{ doc.addImage(companyLogo, "PNG", leftX, topY, 110, 36); }catch(_){}
  }
  try{
    const sb = await fetchAsDataUrl("logo.png");
    doc.addImage(sb, "PNG", pageW-46-140, topY, 140, 40);
  }catch(_){}

  // INTERNAL badge
  if(template === "internal"){
    doc.setFillColor(176,0,32);
    doc.roundedRect(pageW-46-140, topY+44, 140, 22, 8, 8, "F");
    doc.setTextColor(255,255,255);
    doc.setFont("helvetica","bold"); doc.setFontSize(10);
    doc.text("INTERNAL", pageW-46-70, topY+59, { align:"center" });
    doc.setTextColor(0,0,0);
  }
}

function filterIssues(p, opts){
  const issues = (p.issues||[]).slice();
  if(!opts || opts.mode === "all") return issues;

  if(opts.mode === "open") return issues.filter(i=>i.status==="open");
  if(opts.mode === "closed") return issues.filter(i=>i.status==="closed");
  if(opts.mode === "due") return issues.filter(i=>isDueToday(i) || isOverdue(i));
  if(opts.mode === "area") {
    const a = (opts.area||"").trim();
    return issues.filter(i => ((i.location||"Unspecified area").trim()||"Unspecified area") === a);
  }
  return issues;
}

async function drawReport(doc, p, opts){
  const margin = 46;
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const contentW = pageW - margin*2;
  const template = opts.template || "client";

  function redFrame(){
    doc.setDrawColor(176,0,32);
    doc.setLineWidth(3);
    doc.rect(margin, margin, contentW, pageH - margin*2);
  }

  const issues = filterIssues(p, opts);
  const suffix =
    opts?.mode === "open" ? " (Open)" :
    opts?.mode === "closed" ? " (Closed)" :
    opts?.mode === "due" ? " (Due / Overdue)" :
    opts?.mode === "area" ? ` (Area: ${opts.area})` :
    "";

  // Cover
  redFrame(); await addPdfHeader(doc, template);
  doc.setFont("helvetica","bold"); doc.setFontSize(22);
  doc.text((p.title || "Site Buddy Report") + suffix, margin+16, 110, { maxWidth: contentW-32 });
  doc.setFont("helvetica","normal"); doc.setFontSize(11);
  doc.text(`Reference: ${p.reference || "-"}`, margin+16, 146);
  doc.text(`Client: ${p.client || "-"}`, margin+16, 162);
  doc.text(`Generated: ${new Date().toLocaleString()}`, margin+16, 178);
  doc.text(`Included issues: ${issues.length}`, margin+16, 194);
  if(template === "internal"){
    doc.setTextColor(102,112,133);
    doc.text(`Template: INTERNAL (includes internal-only badge)`, margin+16, 210);
    doc.setTextColor(0,0,0);
  }

  // Summary
  doc.addPage(); redFrame(); await addPdfHeader(doc, template);
  const openCount = issues.filter(i=>i.status==="open").length;
  const closedCount = issues.filter(i=>i.status==="closed").length;
  const overdueCount = issues.filter(i=>isOverdue(i)).length;
  const dueTodayCount = issues.filter(i=>isDueToday(i)).length;
  const highCount = issues.filter(i=>i.severity==="high").length;

  doc.setFont("helvetica","bold"); doc.setFontSize(18);
  doc.text("Dashboard Summary", margin+16, 110);
  doc.setFont("helvetica","normal"); doc.setFontSize(12);
  doc.text(`Total issues: ${issues.length}`, margin+16, 144);
  doc.text(`Open: ${openCount}`, margin+16, 164);
  doc.text(`Closed: ${closedCount}`, margin+16, 184);
  doc.text(`Overdue: ${overdueCount}`, margin+16, 204);
  doc.text(`Due today: ${dueTodayCount}`, margin+16, 224);
  doc.text(`High severity: ${highCount}`, margin+16, 244);

  // Signature
  const sigRec = await dbGet("signatures", p.id);
  if(sigRec?.dataUrl){
    doc.setFont("helvetica","bold"); doc.setFontSize(12);
    doc.text("Signature", margin+16, 284);
    try{ doc.addImage(sigRec.dataUrl, "PNG", margin+16, 296, 220, 80); }catch(_){}
  }

  // Group by area then status
  const byLoc = new Map();
  for(const i of issues){
    const loc = (i.location || "Unspecified area").trim() || "Unspecified area";
    if(!byLoc.has(loc)) byLoc.set(loc, []);
    byLoc.get(loc).push(i);
  }
  const locs = Array.from(byLoc.keys()).sort((a,b)=>a.localeCompare(b));

  for(const loc of locs){
    const locIssues = byLoc.get(loc);
    const open = locIssues.filter(i=>i.status==="open");
    const closed = locIssues.filter(i=>i.status==="closed");

    for(const block of [
      { name:"Open issues", items:open },
      { name:"Closed issues", items:closed }
    ]){
      if(block.items.length === 0) continue;

      doc.addPage(); redFrame(); await addPdfHeader(doc, template);
      doc.setFont("helvetica","bold"); doc.setFontSize(16);
      doc.text(loc, margin+16, 110);
      doc.setFontSize(12);
      doc.text(block.name, margin+16, 134);

      let y = 164;
      for(const issue of block.items){
        const assignee = (issue.assignee || "-").trim() || "-";
        const dueDate = issue.dueDate ? new Date(issue.dueDate).toLocaleDateString() : "-";
        const line1 = `${issue.code||""} • ${issue.title||"Untitled"}  •  Severity: ${issue.severity||"medium"}`;
        const line2 = `Assignee: ${assignee}  •  Due: ${dueDate}  •  Status: ${issue.status||"open"}`;
        const notes = issue.notes || "-";

        const lines1 = doc.splitTextToSize(line1, contentW-32);
        const lines2 = doc.splitTextToSize(line2, contentW-32);
        const lines3 = doc.splitTextToSize(notes, contentW-32);

        const needed = (lines1.length+lines2.length+lines3.length)*14 + 18;
        if(y + needed > pageH - margin - 40){
          doc.addPage(); redFrame(); await addPdfHeader(doc, template);
          y = 110;
        }

        doc.setFont("helvetica","bold"); doc.setFontSize(11);
        doc.text(lines1, margin+16, y); y += lines1.length*14 + 4;
        doc.setFont("helvetica","normal"); doc.text(lines2, margin+16, y); y += lines2.length*14 + 6;
        doc.text(lines3, margin+16, y); y += lines3.length*14 + 10;

        // Photo pages (SQUARE layout + numbering)
        const photos = await dbGetPhotosByIssueId(issue.id);
        photos.sort((a,b)=> (a.photoNo||9999) - (b.photoNo||9999));
        for(const ph of photos){
          const photoNo = ph.photoNo || 1;
          doc.addPage(); redFrame(); await addPdfHeader(doc, template);
          doc.setFont("helvetica","bold"); doc.setFontSize(14);
          doc.text(`${issue.code||""} • ${issue.title||"Issue"} — ${photoLabel(photoNo)}`, margin+16, 110);

          const sqUrl = await renderAnnotatedSquareToDataUrl(ph);
          const box = Math.min(contentW - 32, 380);
          const x = margin + 16;
          const yImg = 130;
          doc.addImage(sqUrl, "JPEG", x, yImg, box, box, undefined, "FAST");

          // Pin legend under image
          const pins = extractPins(ph);
          const legendY = yImg + box + 26;
          doc.setFont("helvetica","bold"); doc.setFontSize(12);
          doc.text("Pin legend", x, legendY);
          doc.setFont("helvetica","normal"); doc.setFontSize(11);

          if(pins.length === 0){
            doc.setTextColor(102,112,133);
            doc.text("No pins on this photo.", x, legendY + 22);
            doc.setTextColor(0,0,0);
          }else{
            let ly = legendY + 22;
            for(const pin of pins){
              const line = `${pin.num}. ${pin.label}`;
              const wrapped = doc.splitTextToSize(line, contentW-32);
              doc.text(wrapped, x, ly);
              ly += wrapped.length*14 + 2;
              if(ly > pageH - margin - 20) break;
            }
          }
        }
      }
    }
  }
}

async function exportPdf(opts={mode:"all", template:"client"}){
  const p = getProject();
  if(!p){ toast("Select a project first"); return; }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  await drawReport(doc, p, opts);

  const extra =
    opts.mode === "open" ? "_Open" :
    opts.mode === "closed" ? "_Closed" :
    opts.mode === "due" ? "_Due" :
    opts.mode === "area" ? `_Area_${safeFile(opts.area||"")}` :
    "";

  const tmpl = opts.template === "internal" ? "_INTERNAL" : "_CLIENT";
  doc.save(`SiteBuddy_${safeFile(p.title || "Report")}${extra}${tmpl}.pdf`);
  toast("PDF exported");
}

async function buildPdfBlob(project, opts){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit:"pt", format:"a4" });
  await drawReport(doc, project, opts);
  return doc.output("blob");
}

$("btnExport").onclick = () => exportPdf({mode:"all", template:getTemplate()});
$("btnShare").onclick = async () => {
  const p = getProject();
  if(!p){ toast("Select a project first"); return; }
  try{
    const blob = await buildPdfBlob(p, {mode:"all", template:getTemplate()});
    const name = `SiteBuddy_${safeFile(p.title || "Report")}_${getTemplate()==="internal"?"INTERNAL":"CLIENT"}.pdf`;
    const file = new File([blob], name, { type:"application/pdf" });

    if(navigator.canShare && navigator.canShare({ files:[file] })){
      await navigator.share({ title:p.title || "Site Buddy Report", text:"Site Buddy report PDF", files:[file] });
      toast("Shared");
      return;
    }

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 3000);
    toast("Downloaded (share not supported)");
  }catch(e){
    console.error(e);
    toast("Share failed");
  }
};

/* Quick export buttons */
$("btnExportOpen").onclick = async ()=> exportPdf({mode:"open", template:getTemplate()});
$("btnExportClosed").onclick = async ()=> exportPdf({mode:"closed", template:getTemplate()});
$("btnExportAll").onclick = async ()=> exportPdf({mode:"all", template:getTemplate()});
$("btnExportDue").onclick = async ()=> exportPdf({mode:"due", template:getTemplate()});

$("btnIssuesExportOpen").onclick = async ()=> exportPdf({mode:"open", template:getTemplate()});
$("btnIssuesExportClosed").onclick = async ()=> exportPdf({mode:"closed", template:getTemplate()});

/* ===================== PWA install + SW ===================== */
let deferredPrompt = null;
window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;
  $("btnInstall").style.display = "inline-block";
});
$("btnInstall").onclick = async () => {
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  $("btnInstall").style.display = "none";
};
window.addEventListener("appinstalled", () => {
  toast("Installed");
  $("btnInstall").style.display = "none";
});
if("serviceWorker" in navigator){
  window.addEventListener("load", async () => {
    try{ await navigator.serviceWorker.register("./sw.js"); }
    catch(e){ console.warn("SW registration failed", e); }
  });
}

/* ===================== Reset ===================== */
$("btnReset").onclick = async () => {
  if(!confirm("Reset Site Buddy? This deletes all offline data on this device.")) return;

  closeCamera(); closeAnno();

  for(const [, url] of state.photoUrlCache.entries()) URL.revokeObjectURL(url);
  state.photoUrlCache.clear();

  await new Promise((resolve) => {
    const req = indexedDB.deleteDatabase(DB_NAME);
    req.onsuccess = () => resolve(true);
    req.onerror = () => resolve(true);
    req.onblocked = () => resolve(true);
  });

  state.projects = [];
  state.selectedProjectId = null;
  state.selectedIssueId = null;

  await dbDelete("branding", "companyLogo");
  state.companyLogoDataUrl = null;
  renderBrandPreview();

  renderAll();
  clearSig();
  toast("Reset complete");
};

/* ===================== Inputs ===================== */
["pTitle","pRef","pClient","pNotes"].forEach(id => $(id).addEventListener("input", () => $("btnSaveProject").disabled = !getProject()));
$("issueFilter").addEventListener("change", () => { renderIssues(); });
$("issueSearch").addEventListener("input", () => {
  clearTimeout(window.__q);
  window.__q = setTimeout(() => { renderIssues(); }, 120);
});

/* ===================== Photos removed URL cleanup on unload ===================== */
window.addEventListener("beforeunload", () => {
  for(const [, url] of state.photoUrlCache.entries()) try{ URL.revokeObjectURL(url); }catch(_){}
});

/* ===================== Init / RenderAll ===================== */
function renderAll(){
  renderProjects();
  renderDashboard();
  renderIssues();
  renderIssueDetail();
  renderAreas();
  renderToday();
  updateTabBadges();
}

async function init(){
  state.projects = await dbGetAllProjects();
  if(!state.selectedProjectId && state.projects.length) state.selectedProjectId = state.projects[0].id;

  const logo = await dbGet("branding", "companyLogo");
  state.companyLogoDataUrl = logo?.dataUrl || null;
  renderBrandPreview();

  clearSig();
  renderAll();
  await loadSignatureIntoCanvas();
}
init();
</script>
</body>
</html>
