<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Site Buddy (MVP)</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a27; --muted:#8ea0b8; --text:#e8eef7;
      --accent:#4da3ff; --accent2:#7cffa6; --danger:#ff5c7a;
      --border:rgba(255,255,255,.08);
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(900px 500px at 20% 0%, rgba(77,163,255,.22), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(124,255,166,.12), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      background: rgba(11,15,23,.75);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--border);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:16px;}
    .topbar{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), rgba(77,163,255,.2));
      display:grid; place-items:center; font-weight:800;
      box-shadow: 0 10px 30px rgba(77,163,255,.15);
    }
    .brand h1{font-size:16px; margin:0; letter-spacing:.3px}
    .brand p{margin:0; font-size:12px; color:var(--muted)}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
    }
    button.primary{background: rgba(77,163,255,.18); border-color: rgba(77,163,255,.35);}
    button.good{background: rgba(124,255,166,.14); border-color: rgba(124,255,166,.28);}
    button.danger{background: rgba(255,92,122,.12); border-color: rgba(255,92,122,.25);}
    button:disabled{opacity:.45; cursor:not-allowed}
    main .grid{
      display:grid; gap:14px;
      grid-template-columns: 320px 1fr;
      padding:16px 0 28px;
    }
    @media (max-width: 920px){
      main .grid{grid-template-columns:1fr}
    }
    .card{
      background: rgba(18,26,39,.75);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .card h2{
      margin:0 0 10px; font-size:14px; letter-spacing:.25px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sub{color:var(--muted); font-size:12px; margin:6px 0 0;}
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, textarea, select{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 10px;
      border-radius:12px;
      outline:none;
    }
    textarea{min-height:90px; resize:vertical}
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .list{
      display:flex; flex-direction:column; gap:8px;
      max-height: 520px; overflow:auto; padding-right:4px;
    }
    .item{
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
      cursor:pointer;
    }
    .item.active{border-color: rgba(77,163,255,.5); background: rgba(77,163,255,.08);}
    .item .title{font-weight:750; font-size:13px}
    .item .meta{font-size:12px; color:var(--muted); margin-top:4px; display:flex; gap:10px; flex-wrap:wrap;}
    .pill{
      font-size:11px; padding:4px 8px; border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
    }
    .pill.open{color:#b9d7ff; border-color: rgba(77,163,255,.25)}
    .pill.closed{color:#c9ffda; border-color: rgba(124,255,166,.25)}
    .split{
      display:grid; gap:14px;
      grid-template-columns: 1fr 360px;
      align-items:start;
    }
    @media (max-width: 920px){ .split{grid-template-columns:1fr} }
    .photos{
      display:grid; gap:10px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (max-width: 560px){ .photos{grid-template-columns:1fr} }
    .photo{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .photo img{width:100%; height:160px; object-fit:cover; display:block;}
    .photo .cap{padding:8px 10px; font-size:12px; color:var(--muted); display:flex; justify-content:space-between; gap:8px;}
    .hr{height:1px; background:var(--border); margin:12px 0;}
    .tiny{font-size:11px; color:var(--muted)}
    .toast{
      position: fixed; bottom: 16px; left: 50%;
      transform: translateX(-50%);
      background: rgba(18,26,39,.92);
      border:1px solid var(--border);
      padding:10px 12px;
      border-radius: 999px;
      box-shadow: 0 12px 35px rgba(0,0,0,.35);
      font-size:12px;
      opacity:0; pointer-events:none;
      transition: opacity .2s ease;
    }
    .toast.show{opacity:1}
    .kbd{
      font-size:11px; border:1px solid var(--border); border-bottom-color: rgba(255,255,255,.18);
      padding:2px 6px; border-radius:8px; color:var(--muted); background: rgba(255,255,255,.03);
    }
  </style>
</head>

<body>
<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo">SB</div>
      <div>
        <h1>Site Buddy</h1>
        <p>One-screen audit MVP • Projects → Issues → Photos → PDF</p>
      </div>
    </div>
    <div class="actions">
      <button class="primary" id="btnNewProject">+ New Project</button>
      <button class="good" id="btnNewIssue" disabled>+ New Issue</button>
      <button class="primary" id="btnExport" disabled>Export PDF</button>
      <button class="danger" id="btnReset">Reset</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <!-- LEFT: Projects -->
    <section class="card">
      <h2>
        Projects
        <span class="tiny"><span class="kbd">Tap</span> to select</span>
      </h2>
      <div id="projectList" class="list"></div>
      <div class="hr"></div>

      <div id="projectFormWrap">
        <h2>Project Details</h2>
        <label>Title</label>
        <input id="pTitle" placeholder="e.g., Riverside Apartments – Block B" />
        <div class="row">
          <div>
            <label>Reference</label>
            <input id="pRef" placeholder="e.g., RB-2026-014" />
          </div>
          <div>
            <label>Client</label>
            <input id="pClient" placeholder="e.g., Acme Property" />
          </div>
        </div>
        <label>Notes</label>
        <textarea id="pNotes" placeholder="Optional site notes…"></textarea>
        <div class="row">
          <button class="good" id="btnSaveProject" disabled>Save Project</button>
          <button class="danger" id="btnDeleteProject" disabled>Delete</button>
        </div>
        <p class="sub">Tip: Add issues on the right. Everything saves locally in your browser.</p>
      </div>
    </section>

    <!-- RIGHT: Issues + Detail -->
    <section class="card">
      <h2>
        Issues
        <span class="tiny">Per selected project</span>
      </h2>

      <div class="split">
        <!-- Issues list -->
        <div>
          <div class="row">
            <div>
              <label>Filter</label>
              <select id="issueFilter">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div>
              <label>Search</label>
              <input id="issueSearch" placeholder="Title / location / notes…" />
            </div>
          </div>

          <div style="height:10px"></div>
          <div id="issueList" class="list" style="max-height: 360px;"></div>
        </div>

        <!-- Issue detail -->
        <div>
          <h2 style="margin-bottom:6px;">Issue Details</h2>
          <p class="sub" id="issueHint">Select a project, then create an issue.</p>

          <div id="issueForm" style="display:none;">
            <label>Title</label>
            <input id="iTitle" placeholder="e.g., Missing handrail at stairwell" />

            <div class="row">
              <div>
                <label>Status</label>
                <select id="iStatus">
                  <option value="open">Open</option>
                  <option value="closed">Closed</option>
                </select>
              </div>
              <div>
                <label>Severity</label>
                <select id="iSeverity">
                  <option value="low">Low</option>
                  <option value="medium" selected>Medium</option>
                  <option value="high">High</option>
                </select>
              </div>
            </div>

            <label>Location / Area</label>
            <input id="iLocation" placeholder="e.g., Level 2 – Corridor C" />

            <label>Notes</label>
            <textarea id="iNotes" placeholder="Describe the issue, action required, etc."></textarea>

            <label>Photos</label>
            <input id="iPhotoInput" type="file" accept="image/*" capture="environment" multiple />
            <p class="tiny">Add photos from camera or gallery. (Annotation MVP = simple label per photo.)</p>

            <div id="photoGrid" class="photos"></div>

            <div class="row" style="margin-top:10px;">
              <button class="good" id="btnSaveIssue">Save Issue</button>
              <button class="danger" id="btnDeleteIssue">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <div class="hr"></div>
      <p class="tiny">
        Roadmap hooks: real drawing annotations, signatures, templates, cloud sync, team assignments.
      </p>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- jsPDF for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/**
 * Site Buddy MVP
 * - One-screen app
 * - LocalStorage persistence
 * - Projects -> Issues -> Photos (data URLs)
 * - PDF export via jsPDF
 *
 * Next upgrades (easy drop-ins):
 * - IndexedDB for large images
 * - Real canvas annotations
 * - Templates + signatures
 * - Cloud sync
 */

const STORE_KEY = "sitebuddy.v1";
const uid = () => Math.random().toString(36).slice(2, 10) + "-" + Date.now().toString(36);

const state = {
  data: { projects: [] },
  selectedProjectId: null,
  selectedIssueId: null,
};

const $ = (id) => document.getElementById(id);
const toastEl = $("toast");
function toast(msg){
  toastEl.textContent = msg;
  toastEl.classList.add("show");
  setTimeout(()=> toastEl.classList.remove("show"), 1600);
}

function load(){
  try{
    const raw = localStorage.getItem(STORE_KEY);
    if(raw) state.data = JSON.parse(raw);
  }catch(e){
    console.warn("Failed to load store", e);
  }
  // Select first project by default
  if(!state.selectedProjectId && state.data.projects.length){
    state.selectedProjectId = state.data.projects[0].id;
  }
}

function save(){
  localStorage.setItem(STORE_KEY, JSON.stringify(state.data));
}

function getProject(){
  return state.data.projects.find(p => p.id === state.selectedProjectId) || null;
}
function getIssue(){
  const p = getProject();
  if(!p) return null;
  return p.issues.find(i => i.id === state.selectedIssueId) || null;
}

function renderProjects(){
  const list = $("projectList");
  list.innerHTML = "";

  if(state.data.projects.length === 0){
    const empty = document.createElement("div");
    empty.className = "tiny";
    empty.textContent = "No projects yet. Click “New Project”.";
    list.appendChild(empty);
  }

  for(const p of state.data.projects){
    const el = document.createElement("div");
    el.className = "item" + (p.id === state.selectedProjectId ? " active" : "");
    const issuesCount = (p.issues || []).length;
    el.innerHTML = `
      <div class="title">${escapeHtml(p.title || "Untitled Project")}</div>
      <div class="meta">
        <span class="pill">${escapeHtml(p.reference || "No ref")}</span>
        <span class="pill">${escapeHtml(p.client || "No client")}</span>
        <span class="pill">${issuesCount} issue${issuesCount===1?"":"s"}</span>
      </div>
    `;
    el.onclick = () => {
      state.selectedProjectId = p.id;
      state.selectedIssueId = null;
      render();
    };
    list.appendChild(el);
  }

  // Update project form
  const proj = getProject();
  $("btnNewIssue").disabled = !proj;
  $("btnExport").disabled = !proj;

  $("btnSaveProject").disabled = !proj;
  $("btnDeleteProject").disabled = !proj;

  $("pTitle").value = proj?.title || "";
  $("pRef").value = proj?.reference || "";
  $("pClient").value = proj?.client || "";
  $("pNotes").value = proj?.notes || "";
}

function renderIssues(){
  const proj = getProject();
  const list = $("issueList");
  list.innerHTML = "";

  if(!proj){
    list.innerHTML = `<div class="tiny">Select or create a project.</div>`;
    return;
  }

  const filter = $("issueFilter").value;
  const q = $("issueSearch").value.trim().toLowerCase();

  let issues = proj.issues || [];
  if(filter !== "all") issues = issues.filter(i => i.status === filter);
  if(q){
    issues = issues.filter(i =>
      (i.title||"").toLowerCase().includes(q) ||
      (i.location||"").toLowerCase().includes(q) ||
      (i.notes||"").toLowerCase().includes(q)
    );
  }

  if(issues.length === 0){
    list.innerHTML = `<div class="tiny">No issues match. Click “New Issue”.</div>`;
    return;
  }

  for(const i of issues){
    const el = document.createElement("div");
    el.className = "item" + (i.id === state.selectedIssueId ? " active" : "");
    const pillClass = i.status === "closed" ? "pill closed" : "pill open";
    el.innerHTML = `
      <div class="title">${escapeHtml(i.title || "Untitled Issue")}</div>
      <div class="meta">
        <span class="${pillClass}">${escapeHtml(i.status)}</span>
        <span class="pill">${escapeHtml(i.severity || "medium")}</span>
        <span class="pill">${escapeHtml(i.location || "No location")}</span>
      </div>
    `;
    el.onclick = () => {
      state.selectedIssueId = i.id;
      renderIssueDetail();
      renderIssues(); // refresh highlight
    };
    list.appendChild(el);
  }
}

function renderIssueDetail(){
  const proj = getProject();
  const issue = getIssue();

  if(!proj){
    $("issueForm").style.display = "none";
    $("issueHint").textContent = "Select a project, then create an issue.";
    $("issueHint").style.display = "block";
    return;
  }

  if(!issue){
    $("issueForm").style.display = "none";
    $("issueHint").textContent = "Create an issue, or tap one to edit.";
    $("issueHint").style.display = "block";
    return;
  }

  $("issueHint").style.display = "none";
  $("issueForm").style.display = "block";

  $("iTitle").value = issue.title || "";
  $("iStatus").value = issue.status || "open";
  $("iSeverity").value = issue.severity || "medium";
  $("iLocation").value = issue.location || "";
  $("iNotes").value = issue.notes || "";

  renderPhotos(issue);
}

function renderPhotos(issue){
  const grid = $("photoGrid");
  grid.innerHTML = "";

  const photos = issue.photos || [];
  if(photos.length === 0){
    const hint = document.createElement("div");
    hint.className = "tiny";
    hint.textContent = "No photos yet.";
    grid.appendChild(hint);
    return;
  }

  photos.forEach((ph, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "photo";
    wrap.innerHTML = `
      <img src="${ph.dataUrl}" alt="Issue photo ${idx+1}" />
      <div class="cap">
        <span>Photo ${idx+1}</span>
        <button class="danger" style="padding:6px 8px; border-radius:10px;" data-del="${idx}">Remove</button>
      </div>
      <div style="padding:0 10px 10px;">
        <label style="margin-top:0;">Annotation label (MVP)</label>
        <input data-anno="${idx}" placeholder="e.g., crack highlighted here" value="${escapeAttr(ph.annotationLabel || "")}" />
      </div>
    `;
    grid.appendChild(wrap);
  });

  // remove handlers
  grid.querySelectorAll("[data-del]").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const index = Number(btn.getAttribute("data-del"));
      issue.photos.splice(index, 1);
      save();
      renderPhotos(issue);
      toast("Photo removed");
    });
  });

  // annotation label handlers
  grid.querySelectorAll("[data-anno]").forEach(inp => {
    inp.addEventListener("input", () => {
      const index = Number(inp.getAttribute("data-anno"));
      issue.photos[index].annotationLabel = inp.value;
      save();
    });
  });
}

function render(){
  renderProjects();
  renderIssues();
  renderIssueDetail();
}

function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[s]));
}
function escapeAttr(str){
  return escapeHtml(str).replace(/"/g, "&quot;");
}

/* Actions */
$("btnNewProject").onclick = () => {
  const p = {
    id: uid(),
    title: "New Project",
    reference: "",
    client: "",
    notes: "",
    createdAt: new Date().toISOString(),
    issues: []
  };
  state.data.projects.unshift(p);
  state.selectedProjectId = p.id;
  state.selectedIssueId = null;
  save();
  render();
  toast("Project created");
};

$("btnSaveProject").onclick = () => {
  const p = getProject();
  if(!p) return;
  p.title = $("pTitle").value.trim() || "Untitled Project";
  p.reference = $("pRef").value.trim();
  p.client = $("pClient").value.trim();
  p.notes = $("pNotes").value.trim();
  p.updatedAt = new Date().toISOString();
  save();
  renderProjects();
  toast("Project saved");
};

$("btnDeleteProject").onclick = () => {
  const p = getProject();
  if(!p) return;
  const ok = confirm(`Delete project "${p.title}" and all its issues?`);
  if(!ok) return;
  state.data.projects = state.data.projects.filter(x => x.id !== p.id);
  state.selectedProjectId = state.data.projects[0]?.id || null;
  state.selectedIssueId = null;
  save();
  render();
  toast("Project deleted");
};

$("btnNewIssue").onclick = () => {
  const p = getProject();
  if(!p) return;
  const issue = {
    id: uid(),
    title: "New Issue",
    status: "open",
    severity: "medium",
    location: "",
    notes: "",
    photos: [],
    createdAt: new Date().toISOString()
  };
  p.issues.unshift(issue);
  state.selectedIssueId = issue.id;
  save();
  renderIssues();
  renderIssueDetail();
  toast("Issue created");
};

$("btnSaveIssue").onclick = () => {
  const issue = getIssue();
  if(!issue) return;
  issue.title = $("iTitle").value.trim() || "Untitled Issue";
  issue.status = $("iStatus").value;
  issue.severity = $("iSeverity").value;
  issue.location = $("iLocation").value.trim();
  issue.notes = $("iNotes").value.trim();
  issue.updatedAt = new Date().toISOString();
  save();
  renderIssues();
  toast("Issue saved");
};

$("btnDeleteIssue").onclick = () => {
  const p = getProject();
  const issue = getIssue();
  if(!p || !issue) return;
  const ok = confirm(`Delete issue "${issue.title}"?`);
  if(!ok) return;
  p.issues = p.issues.filter(x => x.id !== issue.id);
  state.selectedIssueId = null;
  save();
  renderIssues();
  renderIssueDetail();
  toast("Issue deleted");
};

$("iPhotoInput").addEventListener("change", async (e) => {
  const issue = getIssue();
  if(!issue) return;

  const files = Array.from(e.target.files || []);
  if(files.length === 0) return;

  // Convert to Data URLs (simple MVP; switch to IndexedDB/file storage later)
  for(const file of files){
    if(!file.type.startsWith("image/")) continue;
    const dataUrl = await fileToDataUrl(file);
    issue.photos.push({ dataUrl, annotationLabel: "" });
  }

  // reset file input to allow re-adding same file
  e.target.value = "";
  save();
  renderPhotos(issue);
  toast(files.length === 1 ? "Photo added" : `${files.length} photos added`);
});

function fileToDataUrl(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

// Filters/search
$("issueFilter").addEventListener("change", renderIssues);
$("issueSearch").addEventListener("input", () => {
  // small debounce
  clearTimeout(window.__q);
  window.__q = setTimeout(renderIssues, 120);
});

$("btnExport").onclick = () => exportPdf();

async function exportPdf(){
  const p = getProject();
  if(!p){
    toast("Select a project first");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const margin = 46;
  const pageW = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const contentW = pageW - margin*2;

  const title = p.title || "Site Buddy Report";
  const metaLines = [
    `Reference: ${p.reference || "-"}`,
    `Client: ${p.client || "-"}`,
    `Generated: ${new Date().toLocaleString()}`,
  ];

  // Cover
  doc.setFont("helvetica", "bold");
  doc.setFontSize(22);
  doc.text(title, margin, 90, { maxWidth: contentW });
  doc.setFont("helvetica", "normal");
  doc.setFontSize(11);
  let y = 120;
  metaLines.forEach(line => { doc.text(line, margin, y); y += 16; });

  if(p.notes){
    y += 10;
    doc.setFont("helvetica", "bold");
    doc.text("Project Notes", margin, y);
    y += 14;
    doc.setFont("helvetica", "normal");
    const wrapped = doc.splitTextToSize(p.notes, contentW);
    doc.text(wrapped, margin, y);
  }

  // Issues
  const issues = (p.issues || []).slice().reverse(); // oldest to newest
  for(let idx=0; idx<issues.length; idx++){
    const issue = issues[idx];
    doc.addPage();
    let yy = margin;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.text(`Issue ${idx+1}: ${issue.title || "Untitled"}`, margin, yy, { maxWidth: contentW });
    yy += 22;

    doc.setFont("helvetica", "normal");
    doc.setFontSize(11);
    const line = (label, val) => {
      doc.setFont("helvetica", "bold"); doc.text(label, margin, yy);
      doc.setFont("helvetica", "normal"); doc.text(String(val ?? "-"), margin + 90, yy);
      yy += 16;
    };

    line("Status:", issue.status || "open");
    line("Severity:", issue.severity || "medium");
    line("Location:", issue.location || "-");

    yy += 6;
    doc.setFont("helvetica", "bold");
    doc.text("Notes", margin, yy);
    yy += 14;
    doc.setFont("helvetica", "normal");
    const notes = issue.notes || "-";
    doc.text(doc.splitTextToSize(notes, contentW), margin, yy);

    // Photos (1 per row)
    const photos = issue.photos || [];
    if(photos.length){
      doc.addPage();
      let py = margin;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.text(`Issue ${idx+1} Photos`, margin, py);
      py += 18;

      for(let pIdx=0; pIdx<photos.length; pIdx++){
        const ph = photos[pIdx];
        const img = ph.dataUrl;

        // compute image box
        const boxW = contentW;
        const boxH = 280;
        if(py + boxH + 90 > pageH){
          doc.addPage();
          py = margin;
        }

        try{
          doc.setDrawColor(220);
          doc.rect(margin, py, boxW, boxH);

          // add image (fit into box)
          // jsPDF needs width/height; we keep a safe fit
          doc.addImage(img, "JPEG", margin+6, py+6, boxW-12, boxH-12, undefined, "FAST");
        }catch(e){
          doc.setFont("helvetica", "normal");
          doc.setFontSize(11);
          doc.text("Photo could not be embedded (format issue).", margin, py+16);
        }

        py += boxH + 14;
        doc.setFont("helvetica", "bold");
        doc.setFontSize(11);
        doc.text(`Photo ${pIdx+1} annotation:`, margin, py);
        doc.setFont("helvetica", "normal");
        doc.text(ph.annotationLabel || "-", margin + 140, py, { maxWidth: contentW - 140 });
        py += 22;
      }
    }
  }

  doc.save(`SiteBuddy_${safeName(title)}.pdf`);
  toast("PDF exported");
}

function safeName(s){
  return String(s || "Report").replace(/[^a-z0-9-_]+/gi, "_").slice(0, 60);
}

$("btnReset").onclick = () => {
  const ok = confirm("Reset Site Buddy? This deletes all local projects/issues/photos.");
  if(!ok) return;
  localStorage.removeItem(STORE_KEY);
  state.data = { projects: [] };
  state.selectedProjectId = null;
  state.selectedIssueId = null;
  render();
  toast("Reset done");
};

/* Init */
load();
render();

// Enable Save Project when fields change
["pTitle","pRef","pClient","pNotes"].forEach(id => {
  $(id).addEventListener("input", () => $("btnSaveProject").disabled = !getProject());
});
</script>
</body>
</html>